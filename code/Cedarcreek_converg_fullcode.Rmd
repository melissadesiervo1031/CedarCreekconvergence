---
title: "Cedar Creek data analysis"
author: "Melissa DeSiervo" mhdesiervo@gmail.com; mdesierv@uwyo.edu
date: "3/25/2022"
output: html_document
---


library(plyr)
library(dplyr)
library(ggplot2)
library(ape)
library(devtools)
library(tidyr)
library(vegan) ##must be the most recent version from github##
library(viridis)
library(stringr)
library(here)
library(tidyverse)
library(tsvr)
library(ggpubr)
library(ecotraj)
library(investr)
library(data.table)
library(trajr)
library(gtable)
library(gridExtra)
library(codyn)
library(indicspecies)
library(BiodiversityR)



```{r aictable function}

aictable<-function(X,m){
  #
  #  This function will create a full model selection table based on AICc.
  #  
  #  Inputs:
  #
  #  X is the AIC table produced by R by using AIC(model1,model2, ...)
  #  m is the sample size
  #
  #
  rnames<-row.names(X)
  AICc<-X$AIC+2*X$df*(X$df+1)/(m-X$df-1)     #small-sample correction
  logL<-X$df-X$AIC/2                         #Log-likelihood
  tab<-data.frame(X[,1],logL,AICc)           #Remove AIC column; add logL and AICc
  colnames(tab)[1]<-c("Params")              #Rename "df" column   
  row.names(tab)<-rnames
  tab<-tab[order(tab$AICc),]                 #Sort by ascending AICc value
  deltaAICc<-tab$AICc-min(tab$AICc)          #Delta AICc
  weight<-exp(-deltaAICc/2)/sum(exp(-deltaAICc/2))  #Weights
  cumwt<-weight                              #Column for cumulative weight
  for(i in 2:dim(X)[1]){                  
    cumwt[i]<-cumwt[i-1]+cumwt[i]              #Accumulate weight from the top
  }
  tab<-data.frame(tab,deltaAICc,weight,cumwt)
  tab<-round(tab,4)
  tab
}

```


```{r upload and clean E001 and E002 datasets}


# Reading in and cleaning Cedar Creek data###

#Read in e001 data## Plot data for the unplowed fields##

d1s <- read.csv(here("data/e001-soil-cn-2019-09-13.csv"), header=T, strip.white=T, skip=1)

# Delete some extra variables and add dummies to stack exp1 & exp2 data
d1s$natm.nadd <- NULL
d1s$fertadd <- NULL
d1s$burn.trt.1992 <- NA
d1s$ntrt.last.year <- 'CurrentYear'
d1s$ntrt.origin <- 1 # No cessation in E001
d1s$disk <- 0 # E001 was not disked before experiment (disturbed vegetation)
d1s$exp <- 1

#Read in e002 data ##Plot data for the plowed fields##

d2s <- read.csv(here("data/e002-soil-cn-2019-09-13.csv"), header=T, strip.white=T, skip=1)

## Delete some extra variables and add dummies to stack exp1 & exp2 data
d2s$X <- NULL
d2s$date <- NULL
d2s$BurnRecBeginning1992 <- NULL
d2s$NtrtRecBefore1992 <- NULL
d2s$TrtRecAfter1991 <- NULL
d2s$TrtRecAfter2013 <- NULL
d2s$burn <- NA
d2s$fence <- NA
d2s$fence.origin <- NA
d2s$depth <- NA
d2s$disk <- 1 # E002 was disked before experiment (disturbed vegetation)
d2s$exp <- 2


#Additioanl plot info for both experiments##

d3s <- read.csv(here("data/E001-E002-Soil-CN-2018.csv"), header=T, strip.white=T, skip=0, na.strings=c(""))


# Delete samples that have errors
d3s <- d3s[is.na(d3s$FLAGGED.FOR.RERUN..S.Spillage..E.Error.),]

# Delete some extra variables and add dummies to stack exp1 & exp2 data
d3s$FLAGGED.FOR.RERUN..S.Spillage..E.Error. <- NULL
d3s$Sample <- NULL
d3s$X <- NULL
d3s$burn <- NA
d3s$burn.origin <- NA
d3s$burn.trt.1992 <- NA
d3s$fence <- NA
d3s$fence.origin <- NA
d3s$depth <- NA
d3s$disk <- NA
d3s$nadd <- NA
d3s$ntrt <- NA
d3s$ntrt.last.year <- NA
d3s$ntrt.origin <- NA
d3s$trt.origin <- NA  

d3s$disk[d3s$exp==1] <- 0 # E001 was not disked before experiment (intact vegetation)
d3s$disk[d3s$exp==2] <- 1 # E002 was disked before experiment (disturbed vegetation)

# Check that data sets have the same variables
sort(names(d1s))
sort(names(d2s))
sort(names(d3s))

# Stack exp1 & 2 data
ds <- rbind(d1s,d2s,d3s)


#Read in e001 aboveground plant biomass data ##

d1a <- read.csv(here("data/e001-aboveground-mass-2019-09-13.csv"), header=T, strip.white=T, skip=1)



# Delete some extra variables and add dummies to stack exp1 & exp2 data
d1a$natm.nadd <- NULL
d1a$fertadd <- NULL
d1a$burn.trt.1992 <- NA
d1a$ntrt.last.year <- "CurrentYear" # No cessation in E001
d1a$ntrt.origin <- 1 # No cessation in E001
d1a$subplot <- NA
d1a$disk <- 0 # E001 was not disked before experiment (disturbed vegetation)
d1a$exp <- 1


#Read in e002 aboveground plant biomass data ##
d2a <- read.csv(here("data/e002-aboveground-mass-2019-09-13.csv"), header=T, strip.white=T, skip=1)


# Delete some extra variables and add dummies to stack exp1 & exp2 data
d2a$X <- NULL
d2a$date <- NULL
d2a$burn <- NA
d2a$fence <- NA
d2a$fence.origin <- NA
d2a$disk <- 1 # E002 was disked before experiment (intact vegetation)
d2a$exp <- 2


# Check that data sets have the same variables
sort(names(d1a))
sort(names(d2a))


# Stack exp1 & 2 data

da <- rbind(d1a,d2a)

# Delete records with key missing data
da <- da[!is.na(da$mass),]

# Disking not done if field D
da <- da[da$field != 'D',]
da$field <- as.factor(as.character(da$field))


# If subplot is missing specify it as a whole plot
da$subplot[is.na(da$subplot)] <- "Whole"

# Code other Nutrient additions
da$other.add <- 1
da$other.add[da$ntrt == 9] <- 0


################################################################################
# Here we make a clean design file of original treatments                      #
# Make clean subplot and year level file with original treatments only.        #
################################################################################


names(da)

# SUBPLOT SCALE Get a list of plots that have original treatments
design.df <- ddply(da, .(field, exp, plot, subplot, ntrt, nadd, disk, other.add, ntrt.origin), colwise(mean, .(mass.above)))
design.df$mass.above <- NULL
dim(design.df)
with(design.df, table(plot, field, exp))
dim(design.df)

# PLOT SCALE Get a list of plots that have original treatments
design.df.plot <- ddply(da, .(field, exp, plot, ntrt, nadd, disk, other.add, ntrt.origin), colwise(mean, .(mass.above)))
design.df.plot$mass.above <- NULL
dim(design.df.plot)
with(design.df.plot, table(plot, field, exp))
dim(design.df.plot)


# YEAR AND SUBPLOT SCALE Get a list of plots that have original treatments
design.df.yr <- ddply(da, .(field, exp, plot, subplot, year, ntrt, disk, other.add, ntrt.origin, burn.origin, fence.origin), colwise(mean, .(mass.above)))
design.df$mass.above <- NULL
dim(design.df)
with(design.df, table(plot, field, exp))
dim(design.df)

#### Important note: burn.origin column isn't exactly right for B E002. The burn doesn't happen until 1992, so should be 54 plots from 1982-1991 and 27 plots 1992-2004###

summary(design.df.yr)
design.orig <- design.df.yr   #dim 9086 X 12

# Delete cessations plots
design.orig <- design.orig[design.orig$ntrt.origin==1,]  #dim #7799   12#


# Delete subplots with experimental burns (after 1992)
#design.orig <- design.orig[design.orig$burn.origin==1,]
design.orig<-subset(design.orig, year < 1992| year >= 1992 & burn.origin==1) #dim #6153   12#

# Some field level data is not represented in both data sets
# Get this sorted out across merged data set
# Fences removed in 2004 (partial removal in field C but still open generally)
# After 2004 all of E002 is unfenced
design.orig$fence[design.orig$year <= 2004 & design.orig$exp==2] <- 1
design.orig$fence[design.orig$year > 2004 & design.orig$exp==2] <- 0

# After 2004 all of E001 is unfenced except in field C
design.orig$fence[design.orig$year <= 2004 & design.orig$exp==1 & design.orig$field != 'C'] <- 1
design.orig$fence[design.orig$year > 2004 & design.orig$exp==2 & design.orig$field != 'C'] <- 0

# Pull out data that is fenced after 2004 as these were invidual plots 
# fenced in field C (I think) after whole field fences were removed. 
design.orig$sel <- TRUE
design.orig$sel[design.orig$year > 2004 & design.orig$fence == 1] <- FALSE
design.orig <- design.orig[design.orig$sel,]
with(design.orig, table(year,fence, exp))
with(design.orig, table(year, field,fence.origin, exp))
with(design.orig, table(year, fence, field, exp))

dim(design.orig)   #dim #6153   12#
summary(design.orig)

# Get field scale burn record
df.burn <- ddply(d1a, .(field, year), colwise(max, .(burn)), na.rm=T)
# Replace original burn record with field summary
da$burn <- NULL
da <- merge(da, df.burn, by=c("field", "year"), all.x=TRUE)


# MERGE IN DESIGN.ORIG FILE TO ONLY HAVE FILES FOR WHICH TREATMENTS HAVE NOT CHANGED

dim(da)  ##72737  X  19### ##includes N cessation and burned plots###
dim(design.orig)  # Unique plot_years with correct treatments### ##dim 6396##

design.orig2<-design.orig %>% select(field, year, exp, disk, plot, subplot, ntrt, other.add, ntrt.origin, burn.origin, fence.origin)

da_min<-da %>% select(field, year, exp, disk, plot, subplot, ntrt,  species, mass.above) #72737  X 9### ##includes N cessation and burned plots###

da_orig<-merge(design.orig2, da_min, by =c("field", "year", "exp", "disk", "plot", "subplot", "ntrt")) # ##dim 50404    13### 

### da_orig is what we want to use moving foward...##

##### get counts by plot year to crosscheck with excel file "Datasubset_CC Convergence###


da_origsiteyear<-da_orig %>%  distinct(field, year, exp, disk, plot, subplot, ntrt, .keep_all = T)

plotcountcheck<-da_origsiteyear%>%group_by(exp, field, year) %>%  tally()

plotcountcheck2<-da_origsiteyear%>%group_by(exp, year) %>%  tally()


plotcountcheck19822004<-subset(plotcountcheck, year < 2005)

sum(plotcountcheck19822004$n) #  6102 total plots-years 1982 to 2004 #### matches exactly w/ excel file## :-) 

sum(plotcountcheck$n)  ## 6396 total plot  years to be analyzed with full times series (note that this includes the E/W subplots that are compiled later...#### 



################# TAXONOMIC AND OTHER SMALL DATA FIXES####################


# Capitalize species to get rid of capilization differences in spelling
da_orig$species <- toupper(as.character(da_orig$species))


###
da_orig$live <- 1
da_orig$sorted <- 1
da_orig$wood <- 0
da_orig$vasc <- 1

# Do some general substitutions

da_orig$species <- gsub("APOCYNUM CANNABINUM", "APOCYNUM ANDROSAEMIFOLIUM", da_orig$species) ## MD 11/1 based off email with Eric##
da_orig$species <- gsub("MISC. FORB", "MISCELLANEOUS FORB", da_orig$species)
da_orig$species <- gsub("SEDGES", "CAREX SP.", da_orig$species)
da_orig$species <- gsub("QUERCUS RUBRUM", "QUERCUS RUBRA", da_orig$species)

# Find litter and code as not alive
sel<-da_orig$species == 'MISCELLANEOUS LITTER'
da_orig$live[sel] <- 0

sel<-grep("PINE", da_orig$species)
da_orig$live[sel] <- 0

# Code unsorted material as not being sorted
sel<-grep("MISCELLANEOUS", da_orig$species)
da_orig$sorted[sel] <- 0

sel<-grep("FUNGI", da_orig$species)
da_orig$sorted[sel] <- 0

sel<-grep("MOSS", da_orig$species)
da_orig$sorted[sel] <- 0

sel<-grep("LICHEN", da_orig$species)
da_orig$sorted[sel] <- 0

# Woody stuff
sel<-grep("ACER NEGUNDO", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("CEANOTHUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("CORYLUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("PINUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("PINE", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("POPULUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("QUERCUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("ULMUS", da_orig$species)
da_orig$wood[sel] <- 1


##mistake w/ biomass for Asclepias syriaca##
da_orig["mass.above"][da_orig["mass.above"] == 1711.970] <- 1711.970/10


# Read in species attribute look up table
sp.df <- read.csv(here("data/Cedar_Creek_Plant_Taxon_List.csv"),header=T)



names(sp.df)[] <- tolower(names(sp.df))

sp.df<-plyr::rename(sp.df, c("Ã¯..species"="species"))
sp.df$species <- toupper(sp.df$species) 
sp.df$functional.group <- toupper(sp.df$functional.group)
sp.df$duration <- toupper(sp.df$duration)
sp.df$lifeform <- toupper(sp.df$lifeform)
sp.df$pathway <- toupper(sp.df$pathway)
sp.df$origin <- toupper(sp.df$origin)
sp.df$family <- toupper(sp.df$family)

da_full <- merge(da_orig,sp.df, by='species', all.x=TRUE)

# Set Unknowns to missing
da_full$origin[da_full$origin == 'UNKNOWN'] <- NA
da_full$origin[da_full$origin == 'NATIVE AND/OR INTRODUCED'] <- NA


da_full$functional.group[da_full$functional.group == 'UNKNOW'] <- NA

da_full$duration[da_full$duration == 'UNKNOWN'] <- NA
da_full$duration[da_full$duration == 'BIENNIAL, PERENNIAL'] <- "BIENNIAL"

# Lump biennials in with annuals as they are pretty similar
# mostly weedy forbs 
unique(da_full$species[da_full$duration=="BIENNIAL"])
unique(da_full$species[da_full$duration=="BIENNIAL, PERENNIAL"])
unique(da_full$species[grep('BIENNIAL', da_full$duration)]) 

da_full$duration[grep('BIENNIAL', da_full$duration)] <- "ANNUAL"
unique(da_full$species[da_full$duration=="ANNUAL" & da_full$functional.group=="C4"])
unique(da_full$species[da_full$duration=="ANNUAL" & da_full$functional.group=="F"])

# Add in some species atrributes
sel <- da_full$species == "QUERCUS RUBRA"
da_full$functional.group[sel] <- "W"
da_full$lifeform[sel] <- "WOODY"
da_full$origin[sel] <- "NATIVE"

# Add in some species atrributes
sel <- da_full$species == "RUDBEKIA SEROTINA"
da_full$functional.group[sel] <- "F"
da_full$lifeform[sel] <- "FORB"
da_full$origin[sel] <- "NATIVE"

# Add in some species atrributes
sel <- da_full$species == "POA PRATENSIS"
da_full$origin[sel] <- "INTRODUCED"

sel <- da_full$species == "MISCELLANEOUS CAREX SP."
da_full$functional.group[sel] <- "S"
da_full$lifeform[sel] <- "SEDGE"
da_full$origin[sel] <- "NATIVE"


# Capitalize species to get rid of capilization differences in spelling
da_full$species <- toupper(as.character(da_full$species))

##deal with some entries where sp. were weighed twice##
summary(freq <- ddply(da_full[da_full$live==1 & da_full$sorted==1, ], .(year, field, exp, plot, subplot, disk, ntrt, species), colwise(length, .(mass.above)))) ##takes a while##

freq$freq <- freq$mass.above

freq$mass.above <- NULL
freq[freq$freq > 1,]

doubles.df <- merge(freq[freq$freq > 1,], da_full[c("field", "exp","plot", "year", "species", "mass.above")], by=c("field", "exp","plot", "year", "species"))
doubles.df[c("field", "exp","plot", "year", "species", "mass.above")]

#####
# There are a few cases where there are multiple species weighed per sample. 
# Options are taking max, min, mean, or sum. 

#da.mn <- ddply(da_full, .(field, exp, plot, subplot, year, disk, ntrt, nadd, species, live, sorted, wood, functional.group, lifeform, duration, origin), colwise(mean, .(mass.above)))
##takes a while##

# subset to live, sorted, herbaceous plants
d2 <- da_full[da_full$sorted ==1 & da_full$live ==1 & da_full$wood==0, c("field", "exp","plot", "subplot", "year", "disk", "ntrt",  "species", "mass.above")]

#subset that includes woody stuff####
d2woody <- da_full[da_full$sorted ==1 & da_full$live ==1, c("field", "exp","plot", "subplot", "year", "disk", "ntrt", "species", "mass.above")]


#Add some columns for herbaceous version####
d3<-d2 %>% mutate(expntrtfieldyear= paste(exp,field, ntrt, year, sep = '_'), expntrtyear= paste(exp,ntrt, year, sep = '_'), ntrt2=ntrt) 

#Add some columns for herbaceous + woody version ####
d3woody<-d2woody %>% mutate(expntrtfieldyear= paste(exp,field, ntrt, year, sep = '_'), expntrtyear= paste(exp,ntrt, year, sep = '_'), ntrt2=ntrt) 


##These data frames (d3 or d3woody) has fields A, B, C, experiment 1 (intact) & exp 2 (disked in 1982) in a long data dataformat ##9 levels of nutrient addition#### years 1982 - 2019 (not every field / exp sampeled in every year## 
#### Has both whole plots and suplots...###


# Transpose herbaceous and woody data to be a site by species matrix
da.widewoody <- reshape(d3woody,
                   v.names="mass.above",
                   idvar=c("field", "exp","plot", "subplot", "year", "disk", "ntrt", "expntrtyear"),
                   timevar="species",
                   direction="wide") 
# Fill in NA's with zeros in wide data set
da.widewoody[is.na(da.widewoody)] <- 0

##make nutrient and years factors#

da.widewoody$ntrt<-as.factor(da.widewoody$ntrt)
da.widewoody$year<-as.factor(da.widewoody$year)

########Combine east / west subplots into "whole" to match up with rest of data (from 2015)#######

##make only the biomasses the numeric variables##
da.widewoody$exp<-as.factor(da.widewoody$exp)
da.widewoody$disk<-as.factor(da.widewoody$disk)


#subset out the east/ west subplots plots and the whole plots ##

da.wideeastwest<-subset(da.widewoody, subplot=="East"|subplot=="West", row.names=NULL)
da.widewhole<-subset(da.widewoody, subplot=="Whole", row.names=NULL)

##Add the values from the subplots together##

EWaddall<-as.data.frame(da.wideeastwest%>%group_by(field,exp,plot,year,disk,ntrt,expntrtyear, expntrtfieldyear, ntrt2) %>% summarise_if(is.numeric,sum)%>% mutate(subplot="Whole"))


###merge the whole plots back together###
da.wide_allwhole<-rbind(da.widewhole,EWaddall)



dim(da.wide_allwhole) ## dimensions of the dataset = 6126  194##

##reorder columns so that all the rows are in the same order across fields etc. 
da.wide5<-da.wide_allwhole%>%arrange(year)%>%arrange(plot)%>%arrange(exp)%>%arrange(field) 


##### Check that the max number of rep within a treatment is 18, since 6 plots in each field and exp recieved the same N treatment##

max(ave(da.wide5$plot, da.wide5$expntrtyear,FUN = seq_along))


####check the plotyears####


plotcountcheck5<-da.wide5%>%group_by(exp, field, year) %>%  tally()

plotcountcheck2<-da_origsiteyear%>%group_by(exp, year) %>%  tally()


##This data frame (da.wide5) has fields A, B, C, experiment 1 (intact) & exp 2 (disked in 1982) ## years 1982 - 2019 for E002 and years 1982 - 2004 for exp E001 (not every field / exp sampeled in every year## INCLUDES WOODY PLANTS
###wide version format###

# N Treatments (Ntrt) Details (from Table 1 Tilman 1987)
# Ntrt Trt g N/m2/yr Other nutrients 
# 1     A       0.0      All 
# 2     B       1.0      All 
# 3     C       2.0      All 
# 4     D       3.4      All 
# 5     E       5.4      All 
# 6     F       9.5      All 
# 7     G      17.0      All 
# 8     H      27.2      All 
# 9     I       0.0      None 

##da.wide5 = fields A, B, C, E001 and E002 1982 to 2019 w/ some missing years###

###some notes about missing data##
## E002 missing data = 2003 field A & B, 2005 all fields , 2006 all fields , 2009 A and C, 2010 all fields, 2011 A, 2012 all fields, 213 A and C, 2014 all fields, 2015 A, 2016 A, 2017 all, ####


############ SUBSETTING FROM FULL DATASET FIELDS ABC E001 and E002########


##subset to years before 2005 for BOTH E001 and E002 ## (bc of change in fire regime)

da.wide5$year<-as.numeric(as.character(da.wide5$year)) 

exp12subset<-subset(da.wide5,year<2005)


##subset to selected nutrient treatments below 9.5 g N##

exp12subset_1<-subset(exp12subset,ntrt==9|ntrt==1|ntrt==2|ntrt==4|ntrt==6)


### this data set (exp12subset_1 has fields ABC, E001 and E002 from 1982-2004) ## > 2004 was a change in the fire regime## ONLY the control and selected nutrient treatments below 9.5 g N) ##

###some notes about missing data##
## E001 data set is complete from 1982 - 2004. E002 dataset is missing years 1995, 1998, 2001, 2003 ALL fields##




```



```{r clean field D data}


#### SELECTING JUST FIELD D TO LOOK AT REMNANT VEGETATION (NEVER PLOWED)###

# Stack exp1 & 2 data
da <- rbind(d1a,d2a)

# Delete records with key missing data
da <- da[!is.na(da$mass),]

# Selecting just field D###

da_fieldD <- subset(da, field=="D")

####

# Capitalize species to get rid of capilization differences in spelling
da_fieldD$species <- toupper(as.character(da_fieldD$species))


# mabye we include woody for field D? not sure yet...###
da_fieldD$live <- 1
da_fieldD$sorted <- 1
da_fieldD$wood <- 0
da_fieldD$vasc <- 1

# Do some general substitutions

da_fieldD$species <- gsub("APOCYNUM CANNABINUM", "APOCYNUM ANDROSAEMIFOLIUM", da_fieldD$species) ## MD 11/1 based off email with Eric##
da_fieldD$species <- gsub("MISC. FORB", "MISCELLANEOUS FORB", da_fieldD$species)
da_fieldD$species <- gsub("SEDGES", "CAREX SP.", da_fieldD$species)
da_fieldD$species <- gsub("QUERCUS RUBRUM", "QUERCUS RUBRA", da_fieldD$species)

# Find litter and code as not alive
sel<-da_fieldD$species == 'MISCELLANEOUS LITTER'|da_fieldD$species == 'WOODY DEBRIS'

da_fieldD$live[sel] <- 0

sel<-grep("PINE", da_fieldD$species)
da_fieldD$live[sel] <- 0

# Code unsorted material as not being sorted
sel<-grep("MISCELLANEOUS", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

sel<-grep("FUNGI", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

sel<-grep("MOSS", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

sel<-grep("LICHEN", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

# Woody stuff
sel<-grep("ACER NEGUNDO", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("CEANOTHUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("CORYLUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("PINUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("PINE", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("POPULUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("QUERCUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("ULMUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1


###remove the not live stuff...leave in trees ###

da_fieldD_2<-subset(da_fieldD, live==1)


### Without trees###

# subset to live, sorted, herbaceous plants
da_fieldD_3 <- da_fieldD[da_fieldD$sorted ==1 & da_fieldD$live ==1 & da_fieldD$wood==0, c("field", "plot", "year", "species", "mass.above")]


######### with trees####


# Transpose data to be a site by species matrix
da_fieldD_wide <- reshape(da_fieldD_2,
                   v.names="mass.above",
                   idvar=c("field", "plot", "year"),
                   timevar="species",
                   direction="wide") 

# Fill in NA's with zeros in wide data set
da_fieldD_wide[is.na(da_fieldD_wide)] <- 0





```



###PERMANOVA AND PCOA SUBSETTING N gradient###

```{r - Conduct a PCoA using all the veg data across years (log)}


##make nutrient and years factors#

exp12subset_1$ntrt<-as.factor(exp12subset_1$ntrt)
exp12subset_1$year<-as.factor(exp12subset_1$year)


##arrange the dataframe so that that columns and rows are in right order##
exp12subset_1_sorted<-exp12subset_1%>%arrange(year)%>%arrange(plot)%>%arrange(field)%>%arrange(exp)


##just the plot data##
plot<-exp12subset_1_sorted%>% dplyr::select('field':'ntrt2')

##just the veg data##

veg<-exp12subset_1_sorted%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)



###log transformation####

vegmatrix<-as.matrix(veg)

logveg<-log(1+vegmatrix)


## Bray curtis dissimiliarty matrix##
distE1andE2<-vegdist(logveg, method="bray")
BCdistall<-as.matrix(distE1andE2)  ##into a matrix#
BCdistalldf<-as.data.frame(BCdistall)  #into a dataframe#

BCdistalldf2<-cbind(plot,BCdistalldf) #merge plot data w/ dissim matrix##

##BCdistalldf2 has the plot info and the BC dissimilarity matrix for the entire experiment (E001 and E002, all three fields combined, with a subsetted selection of the ntrt treatments)

###PcOA for both E011 and E002 together####

PCOA_allfieldE12 <- pcoa(distE1andE2)  ## takes a while##

#PCOA_allfieldE12 <- cmdscale(distE1andE2)  ## Another way of doing the pcoa that gives same results#


## extracting the axis scores for each exp##

PCOAaxesboth <- PCOA_allfieldE12$vectors[,c(1,2)]


##merge the axis scores with the plot data ###

PCOAandplotsboth<-cbind(plot,PCOAaxesboth )

##PCOAandplotsboth has the plot info and the PCOA scores for the entire experiment (E001 and E002, all three fields combined, with a subsetted selection of the ntrt treatments)






```



```{r - Conduct permanova: nutrient, disturbance, field effect (log data)}



####for this analysis, getting rid of the years where not every field was sampeled##

exp12subset_2<-exp12subset_1%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)



###log transform the biomass data###

justveg<-as.matrix(exp12subset_2[,12:198])

logveg<-log(1+justveg)

exp12subset_2<-cbind(exp12subset_2[,1:11], logveg)



### Extract two  years year to get the apply function to work#####

da.wide_1990<-subset(exp12subset_2, year=="1990", row.names=NULL)

da.wide_1999<-subset(exp12subset_2, year=="1999", row.names=NULL)

###
exp12subset_19821991<-subset(exp12subset_2, as.numeric(as.character(year)) < 1992)
exp12subset_19922004<-subset(exp12subset_2, as.numeric(as.character(year)) >= 1992)

#drop the levels not sampeled

levels(exp12subset_19821991$year)
exp12subset_19821991$year <- as.factor(as.character(exp12subset_19821991$year))


levels(exp12subset_19922004$year)
exp12subset_19922004$year <- as.factor(as.character(exp12subset_19922004$year))

##Do a PERMANOVA looping over years, looking at effect of exp (disturbed or not), ntrt treatment# and field (A, B, C)###

##need to do this in two batches because from 1992 on there are fewer plots..####

###
permallfields1<-lapply(X = split.data.frame(x = exp12subset_19821991, f=exp12subset_19821991$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt+field, data= da.wide_1990)
  return(data.frame(z))
  }
  )



permallfields2<-lapply(X = split.data.frame(x = exp12subset_19922004, f=exp12subset_19922004$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt+field, data= da.wide_1999)
  return(data.frame(z))
  }
  )




##dataframe of results##
permmaster1<-plyr::ldply(permallfields1, data.frame)
permmaster2<-plyr::ldply(permallfields2, data.frame)


names<-c("Disturbance", "Fertilization", "Field", "residual", "total")

sourcevariation<-rep(names,length(unique(permmaster1$.id)))

permmaster11<-cbind(sourcevariation,permmaster1)

sourcevariation<-rep(names,length(unique(permmaster2$.id)))

permmaster22<-cbind(sourcevariation,permmaster2)

###

permmasterall<-rbind(permmaster11, permmaster22)
  
permmaster3<-subset(permmasterall,sourcevariation=="Disturbance"|sourcevariation=="Fertilization"|sourcevariation=="Field") 

##This dataframe (permmmaster3) has the results from a permanova for each independent variable (disturbance, field, fertilization) for every year in the dataset w/ everything sampeled. The R2 column is what is plotted in Fig 1 ###



```



```{r - recreate FIG 1, R2 over time dist, nut, field (log data)}


permmaster4<- permmaster3 %>% mutate (year=as.numeric(.id))  %>% mutate (year2=year-1981)

permmaster4$sourcevariation<- factor(permmaster4$sourcevariation, levels = c("Disturbance", "Fertilization", "Field"))

my_plotlabels = paste0('(', letters, ') ')

abclabels = paste0(my_plotlabels[1:length(levels(permmaster4$sourcevariation))]) 

permmaster5<-cbind(permmaster4, abclabels)


##make the plot##

mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))




variancetimeall<-permmaster5 %>% ggplot(aes(x=as.numeric(year2), y=R2, group=sourcevariation)) +
    geom_point() +
    facet_wrap(~sourcevariation, strip.position = c("top"))+
    geom_smooth(method="loess", colour="black", size=0.5, fill = "gray1") +
    geom_text(aes(x = 2.0, y = 0.54, label = abclabels, group =     abclabels),size = 4,check_overlap = T)+
    ylab(expression('Explained variation'))+
    xlab("Time since experiment (years)")+
    mytheme+
    theme(strip.text = element_text(face="bold", size=12))+
     theme(strip.background = element_blank())

   ###

```



```{r - recreate FIG 2, PCOA ordination by year (log data)}



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=8, colour = "black"))+theme(axis.text.y=element_text(size=8, colour = "black"))+theme(axis.title=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))



##PCOAandplotsE001 (and E002) have 11 colummns of plot data, PC0A axis 1 and 2 for each plot (in each year, field, subset of ntrt conditions)##


##all fields. averaging across plots in all fields (n=18) with the same treatment group##

#first check that there are 18 OR 9 in each ntrt treatment / year##
PCOAandplotscount<-PCOAandplotsboth %>% count(year,disk,ntrt)

####2003 for E002 only has 1 field so we remove it###

PCOAandplotsboth2<-PCOAandplotsboth %>%filter(year!=2003)

PCOAandplotscount2<-PCOAandplotsboth2 %>% count(year,disk,ntrt)##good now###

PCOAandplotsboth2$Axis.1<-as.numeric(PCOAandplotsboth2$Axis.1)
PCOAandplotsboth2$Axis.2<-as.numeric(PCOAandplotsboth2$Axis.2)

PCOAandplotsboth2$year<-as.numeric(as.character(PCOAandplotsboth2$year))



PCOAandplotsavg<-PCOAandplotsboth2 %>% group_by(exp,year,disk,ntrt) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())



####

## plot specifications

PCOAandplotsavg2<-mutate(PCOAandplotsavg, ntrt2=ntrt)

PCOAandplotsavg2$ntrt2<-PCOAandplotsavg2$ntrt

PCOAandplotsavg2$ntrt2  <- plyr::mapvalues(PCOAandplotsavg2$ntrt2, from=c("9", "1", "2", "3", "4","5","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))

PCOAandplotsavg2$ntrt2 <- factor(PCOAandplotsavg2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))

PCOAandplotsavg2<-PCOAandplotsavg2  %>% mutate(yearlabel=ifelse(year==1982|year==1992|year==2004,year, NA))%>%mutate(exp_ntrt= as.factor(paste(exp, ntrt, sep = '_')))

PCOAandplotsavg2$exp_ntrt <- factor(PCOAandplotsavg2$exp_ntrt , levels = c("1_9", "2_9", "1_1","2_1", "1_2", "2_2", "1_4", "2_4", "1_6", "2_6"))

PCOAandplotsavg3<-PCOAandplotsavg2 %>% mutate(abclabel=exp_ntrt)
levels(PCOAandplotsavg3$abclabel) <- c( "(a) ", "(b) ", "(c) ", "(d) ", "(e) ", "(f) ", "(g) ", "(h) ", "(i) ", "(j) ")

## plot specifications
PCOAandplotsavg3$ntrt2  <- plyr::mapvalues(PCOAandplotsavg3$ntrt2, from=c("9", "1", "2", "3", "4","5","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))
PCOAandplotsavg3$ntrt2 <- factor(PCOAandplotsavg3$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))


PCOAandplotsavg3$disk<-plyr::mapvalues(PCOAandplotsavg3$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))




##
##to draw points between years###

ann_textdisk3 <- data.frame(meanAxis1 = c(0.00, 0.00), meanAxis2 =c(0.27, 0.27),exp= c("Intact in 1982 (E001)","Disturbed in 1982 (E002)"), year=c(1982, 1982), exp_ntrt=c("1_9", "2_9"),abclabel = factor(c("(a) ","(b) " ),levels = c("(a) ", "(b) ", "(c) ", "(d) ", "(e) ", "(f) ", "(g) ", "(h) ", "(i) ", "(j) ")))

ann_textntrt <- data.frame(meanAxis1 = c(0.45, 0.45, 0.45, 0.45, 0.45), meanAxis2 =c(0.05, 0.05, 0.05, 0.05, 0.05),exp= c("2","2","2","2","2"), year=c(1982, 1982, 1982, 1982, 1982), exp_ntrt=c("2_9", "2_1", "2_2", "2_4", "2_6"),abclabel = factor(c("(b) ","(d) ", "(f) ","(h) ","(j) "),levels = c("(a) ", "(b) ", "(c) ", "(d) ", "(e) ", "(f) ", "(g) ", "(h) ", "(i) ", "(j) ")))



PcoAfieldAveragedE001E002<-ggplot(PCOAandplotsavg3[order(PCOAandplotsavg3$year),], aes(x=meanAxis1  , y=meanAxis2 , group=exp_ntrt, color=year, label=year)) +
    geom_point(size=0.75) +
    geom_errorbar(aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2), color="dark gray", size=0.25) +
    geom_errorbarh(aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1), color="dark gray", size=0.25) +
    geom_path(aes(x=meanAxis1 , y=meanAxis2 , group=exp_ntrt, color=year),size=0.5)+
    geom_point(size=0.75) +
    xlim(c(min(PCOAandplotsavg3$meanAxis1-PCOAandplotsavg3$seAxis1)),max(PCOAandplotsavg3$meanAxis1+PCOAandplotsavg3$seAxis1))+
    ylim(c(min(PCOAandplotsavg3$meanAxis2-PCOAandplotsavg3$seAxis2)),max(PCOAandplotsavg3$meanAxis2+PCOAandplotsavg3$seAxis2))+
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    facet_grid(ntrt2~disk) + 
    #geom_text(aes(label=yearlabel),position=position_jitter(width=0.05,height=0.05), color="black", size=2.5)+
    mytheme+
    scale_color_viridis(option = "D")+
    scale_fill_viridis(option = "D",trans = 'reverse')+
    guides(#reverse color order (higher value on top)
    color = guide_colorbar(reverse = TRUE),
    #reverse size order (higher diameter on top) 
    size = guide_legend(reverse = TRUE))+
   #scale_y_continuous(breaks=c(-0.2, 0.0, 0.2, 0.4))+
    geom_text(aes(x = -0.26, y = 0.16, label = abclabel, group =     abclabel),size = 3,check_overlap = T)+
    theme(strip.background = element_blank())+
    theme(strip.text = element_text(face="bold", size=10))+
    theme(panel.spacing.y=unit(0.5, "lines"))
    #geom_text_repel(aes(label=yearlabel),size = 2.5, color="black")


```



```{r - recreate FIG 4 cd, PCoA by decade (log data)}


PCOAandplotsavg<-PCOAandplotsboth %>% group_by(exp,year,disk,ntrt) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())


###get rid of years where we don't have 9 or 18 plots###
####2003 for E002 only has 1 field, so remove it###

PCOAandplotsavg2<-subset(PCOAandplotsavg, n>8)


PCOAandplotsavg2<-PCOAandplotsavg2  %>% mutate(yearlabel=ifelse(year==1982|year==1988|year==1992|year==2004,year, NA))

######

##by decade####

PcoAplaying <- PCOAandplotsavg2 %>% filter(year %in% c(1982,2004))

arrow_start <- PCOAandplotsavg2 %>% filter(year ==1982)
arrow_stop<- PCOAandplotsavg2 %>% filter(year == 2004)

wide_PcoAplaying <- pivot_wider(PcoAplaying, names_from = year, values_from = year)

##just pull out the first year of data##

PCOAandplots1982<-subset(PCOAandplotsavg2, year==1982)

##pull out the first, last, and midpoint year##

PCOAandplots198219922004<-subset(PCOAandplotsavg2, year==1982|year==1992|year==2004)

PCOAandplots198219922004<-PCOAandplots198219922004 %>% mutate(abclabel=exp)%>% mutate(ntrt2=ntrt) %>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))

levels(PCOAandplots198219922004$abclabel) <- c( "(a) ", "(b) ")


PCOAandplots198219922004$ntrt2  <- mapvalues(PCOAandplots198219922004$ntrt2, from=c("9", "1", "2", "3", "4","5","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))
PCOAandplots198219922004$ntrt2 <- factor(PCOAandplots198219922004$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))


#first arrow and second##
PcoAplayingfirst <- PCOAandplotsavg2 %>% filter(year %in% c(1982,1992, 2004))

PcoAplayingfirst2<-PcoAplayingfirst %>% mutate(abclabel=exp)
levels(PcoAplayingfirst2$abclabel) <- c( "(c) ", "(d) ")

#make sure its in the right order##
PcoAplayingfirst2<-PcoAplayingfirst2 %>% arrange(year)%>% arrange(exp)%>% arrange(ntrt)%>% mutate(ntrt2=ntrt) %>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))



PcoAplayingfirst2$ntrt2  <- mapvalues(PcoAplayingfirst2$ntrt2, from=c("9", "1", "2", "3", "4","5","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))
PcoAplayingfirst2$ntrt2 <- factor(PcoAplayingfirst2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))

wide_PcoAplaying1 <- pivot_wider(PcoAplayingfirst2, names_from = year, values_from = year)

wide_PcoAplaying1$`1982`<-as.numeric(as.character(wide_PcoAplaying1$`1982`))
wide_PcoAplaying1$`1992`<-as.numeric(as.character(wide_PcoAplaying1$`1992`))
wide_PcoAplaying1$`2004`<-as.numeric(as.character(wide_PcoAplaying1$`2004`))


PCOAandplotslabels<-subset(PcoAplayingfirst2, ntrt==4)
PCOAandplotslabels<-PCOAandplotslabels%>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))%>%  mutate(yearlabel= year)


######

## plot specifications
PCOAandplotsavg2$ntrt2  <- mapvalues(PCOAandplotsavg2$ntrt2, from=c("9", "1", "2", "3", "4","5","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))
PCOAandplotsavg2$ntrt2 <- factor(PCOAandplotsavg2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))


PCOAandplotsavg2$disk<-mapvalues(PCOAandplotsavg2$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



ann_textdisk2 <- data.frame(meanAxis1 = c(0.03, 0.03), meanAxis2 =c(0.27,0.27),exp= c("Intact in 1982 (E001)","Disturbed in 1982 (E002)"), ntrt2=c("None", "None"), expntrt=c("1_9" ,"2_9"), abclabel = factor(c("(a) ","(b) " ),levels = c("(c) ", "(d) ")))


####
mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


PcOAdecade<-ggplot(data=PcoAplayingfirst2, aes(x=meanAxis1  , y=meanAxis2 , color=ntrt2)) +
  geom_hline(yintercept = 0)+geom_vline(xintercept = 0)+
  geom_point(data=PCOAandplots198219922004, aes(x=meanAxis1  , y=meanAxis2 , group=ntrt2, shape=as.factor(year)), size=2)+
    geom_errorbar(data=PCOAandplots198219922004, aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2,color=ntrt2), size=0.25) +
  geom_errorbarh(data=PCOAandplots198219922004, aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1,color=ntrt2),  size=0.25) +
  geom_point(data=PCOAandplots198219922004, aes(x=meanAxis1  , y=meanAxis2 , group=ntrt2,color=ntrt2,shape=as.factor(year)))+
  geom_segment(data=wide_PcoAplaying1, aes(x=`1982`  , y=`1982`, xend =`1992`, yend = `1992`, color=ntrt2), arrow=arrow(length=unit(0.0, "cm"))) +
    geom_path(size=0.75, arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))+
      geom_segment(data=wide_PcoAplaying1, aes(x=`1992`  , y=`1992`, xend =`2004`, yend = `2004`, color=ntrt2), arrow=arrow(length=unit(0.0, "cm"))) +
    geom_path(size=0.75, arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))+
          geom_text(data=PCOAandplotslabels, aes(label=yearlabel),position = position_nudge(y = -0.018, x=-0.02), color="black", size=3.0)+
    #ylab("PCoA 2")+
    ylab(expression(atop("", paste("PCoA 2"))))+
    xlab("PCoA 1")+
    facet_grid(~disk) + 
    xlim(-0.28,0.42)+
    ylim(-0.5,0.15)+
    scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
    mytheme+
    scale_shape_manual(values = c(21, 22, 24))+
      theme(strip.background = element_blank())+
      geom_text(aes(x = -0.25, y = 0.14, label = abclabel, group =     abclabel),size = 4, color= "black", check_overlap = T)+theme(strip.text = element_blank())


```



###PERMANOVA AND PCOA FULL N GRADIENT###
##this chuck takes a long time to run.....###

```{r - Conduct a PCoA using all the veg data across years  FULL N GRADIENT (log)}


exp12subset<-subset(da.wide5,year<2005)

##make nutrient and years factors#

exp12subset$ntrt<-as.factor(exp12subset$ntrt)
exp12subset$year<-as.factor(exp12subset$year)


##arrange the dataframe so that that columns and rows are in right order##
exp12subsetsorted<-exp12subset%>%arrange(year)%>%arrange(plot)%>%arrange(field)%>%arrange(exp)


##just the plot data##
plot<-exp12subsetsorted%>% dplyr::select('field':'ntrt2')

##just the veg data##

veg<-exp12subsetsorted%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)



###log transformation####

vegmatrix<-as.matrix(veg)

logveg<-log(1+vegmatrix)


## Bray curtis dissimiliarty matrix##
distE1andE2<-vegdist(logveg, method="bray")
BCdistall<-as.matrix(distE1andE2)  ##into a matrix#
BCdistalldf<-as.data.frame(BCdistall)  #into a dataframe#

BCdistalldf2<-cbind(plot,BCdistalldf) #merge plot data w/ dissim matrix##

##BCdistalldf2 has the plot info and the BC dissimilarity matrix for the entire experiment (E001 and E002, all three fields combined, with a subsetted selection of the ntrt treatments)

###PcOA for both E011 and E002 together####

PCOA_allfieldE12_fullN <- pcoa(distE1andE2)  ## takes a while##

#PCOA_allfieldE12 <- cmdscale(distE1andE2)  ## Another way of doing the pcoa that gives same results#


## extracting the axis scores for each exp##

PCOAaxesboth_fullN <- PCOA_allfieldE12_fullN$vectors[,c(1,2)]


##merge the axis scores with the plot data ###

PCOAandplotsboth_fullN<-cbind(plot,PCOAaxesboth_fullN )

##PCOAandplotsboth_full N has the plot info and the PCOA scores for the entire experiment (E001 and E002, all three fields combined, wiah ALL of the ntrt treatments)






```

##this chuck takes a long time to run.....###

```{r - Conduct permanova: nutrient, disturbance, field effect (log data) FULL N GRADIENT}

exp12subset<-subset(da.wide5,year<2005)


####for this analysis, getting rid of the years where not every field was sampeled##

exp12subset_22<-exp12subset%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)



###log transform the biomass data###

justveg<-as.matrix(exp12subset_22[,12:198])

logveg<-log(1+justveg)

exp12subset_22<-cbind(exp12subset_22[,1:11], logveg)



### Extract two  years year to get the apply function to work#####

da.wide_1990<-subset(exp12subset_22, year=="1990", row.names=NULL)

da.wide_1999<-subset(exp12subset_22, year=="1999", row.names=NULL)

###
exp12subset_19821991<-subset(exp12subset_22, as.numeric(as.character(year)) < 1992)
exp12subset_19922004<-subset(exp12subset_22, as.numeric(as.character(year)) >= 1992)

#drop the levels not sampeled

levels(exp12subset_19821991$year)
exp12subset_19821991$year <- as.factor(as.character(exp12subset_19821991$year))


levels(exp12subset_19922004$year)
exp12subset_19922004$year <- as.factor(as.character(exp12subset_19922004$year))

##Do a PERMANOVA looping over years, looking at effect of exp (disturbed or not), ntrt treatment# and field (A, B, C)###

##need to do this in two batches because from 1992 on there are fewer plots..####

###
permallfields1<-lapply(X = split.data.frame(x = exp12subset_19821991, f=exp12subset_19821991$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt+field, data= da.wide_1990)
  return(data.frame(z))
  }
  )



permallfields2<-lapply(X = split.data.frame(x = exp12subset_19922004, f=exp12subset_19922004$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt+field, data= da.wide_1999)
  return(data.frame(z))
  }
  )




##dataframe of results##
permmaster1<-plyr::ldply(permallfields1, data.frame)
permmaster2<-plyr::ldply(permallfields2, data.frame)


names<-c("Disturbance", "Fertilization", "Field", "residual", "total")

sourcevariation<-rep(names,length(unique(permmaster1$.id)))

permmaster11<-cbind(sourcevariation,permmaster1)

sourcevariation<-rep(names,length(unique(permmaster2$.id)))

permmaster22<-cbind(sourcevariation,permmaster2)

###

permmasterall<-rbind(permmaster11, permmaster22)
  
permmaster3_allnut<-subset(permmasterall,sourcevariation=="Disturbance"|sourcevariation=="Fertilization"|sourcevariation=="Field") 

##This dataframe (permmmaster3_allnut) has the results from a permanova for each independent variable (disturbance, field, fertilization) for every year in the dataset w/ everything sampeled. The R2 column is what is plotted in Fig 1 ###



```


```{r - Conduct permanova w/ blocking: nutrient, disturbance, field effect (log data) FULL N GRADIENT}

exp12subset<-subset(da.wide5,year<2005)


####for this analysis, getting rid of the years where not every field was sampeled##

exp12subset_22<-exp12subset%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)



###log transform the biomass data###

justveg<-as.matrix(exp12subset_22[,12:198])

logveg<-log(1+justveg)

exp12subset_22<-cbind(exp12subset_22[,1:11], logveg)



### Extract two  years year to get the apply function to work#####

da.wide_1990<-subset(exp12subset_22, year=="1990", row.names=NULL)

da.wide_1999<-subset(exp12subset_22, year=="1999", row.names=NULL)

###
exp12subset_19821991<-subset(exp12subset_22, as.numeric(as.character(year)) < 1992)
exp12subset_19922004<-subset(exp12subset_22, as.numeric(as.character(year)) >= 1992)

#drop the levels not sampeled

levels(exp12subset_19821991$year)
exp12subset_19821991$year <- as.factor(as.character(exp12subset_19821991$year))


levels(exp12subset_19922004$year)
exp12subset_19922004$year <- as.factor(as.character(exp12subset_19922004$year))

##Do a PERMANOVA looping over years, looking at effect of exp (disturbed or not), ntrt treatment# and field (A, B, C)###

##need to do this in two batches because from 1992 on there are fewer plots..####


adonis2(Y ~ fish + season*year, data=metadata, perm= how(blocks = metadata$valley, plots = Plots(strata = metadata$lake), within = Within(type = "series"), nperm=9999), by="margin")

### If we restrict permutations, I don't think we can use field as fixed effect###

#perm= how(blocks = metadata$valley, plots = Plots(strata = metadata$lake)

##not working..hmmm###


###
permallfieldstry1<-lapply(X = split.data.frame(x = exp12subset_19821991, f=exp12subset_19821991$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt,  data= da.wide_1990, strata=field)
  return(data.frame(z))
  }
  )



permallfields2<-lapply(X = split.data.frame(x = exp12subset_19922004, f=exp12subset_19922004$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt+field, data= da.wide_1999)
  return(data.frame(z))
  }
  )




##dataframe of results##
permmaster1<-plyr::ldply(permallfields1, data.frame)
permmaster2<-plyr::ldply(permallfields2, data.frame)


names<-c("Disturbance", "Fertilization", "Field", "residual", "total")

sourcevariation<-rep(names,length(unique(permmaster1$.id)))

permmaster11<-cbind(sourcevariation,permmaster1)

sourcevariation<-rep(names,length(unique(permmaster2$.id)))

permmaster22<-cbind(sourcevariation,permmaster2)

###

permmasterall<-rbind(permmaster11, permmaster22)
  
permmaster3_allnut<-subset(permmasterall,sourcevariation=="Disturbance"|sourcevariation=="Fertilization"|sourcevariation=="Field") 

##This dataframe (permmmaster3_allnut) has the results from a permanova for each independent variable (disturbance, field, fertilization) for every year in the dataset w/ everything sampeled. The R2 column is what is plotted in Fig 1 ###



```





```{r - recreate FIG 1, R2 FULL N GRADIENT}


permmaster3_allnut2<- permmaster3_allnut %>% mutate (year=as.numeric(.id))  %>% mutate (year2=year-1981)

permmaster3_allnut2$sourcevariation<- factor(permmaster3_allnut2$sourcevariation, levels = c("Disturbance", "Fertilization", "Field"))

my_plotlabels = paste0('(', letters, ') ')

abclabels = paste0(my_plotlabels[1:length(levels(permmaster3_allnut2$sourcevariation))]) 

permmaster5<-cbind(permmaster3_allnut2, abclabels)


##make the plot##

mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))




variancetimeall_allnut<-permmaster5 %>% ggplot(aes(x=as.numeric(year2), y=R2, group=sourcevariation)) +
    geom_point() +
    facet_wrap(~sourcevariation, strip.position = c("top"))+
    geom_smooth(method="loess", colour="black", size=0.5, fill = "gray1") +
    geom_text(aes(x = 2.0, y = 0.54, label = abclabels, group =     abclabels),size = 4,check_overlap = T)+
    ylab(expression('Explained variation'))+
    xlab("Time since experiment (years)")+
    mytheme+
    theme(strip.text = element_text(face="bold", size=12))+
     theme(strip.background = element_blank())

   ###

```


```{r - recreate FIG 2, PCOA ordination by year FULL N GRADIENT}


##PCOAandplotsE001 (and E002) have 11 colummns of plot data, PC0A axis 1 and 2 for each plot (in each year, field, subset of ntrt conditions)##


PCOAandplotsboth_fullN



#first check that there are 18 OR 9 in each ntrt treatment / year##
PCOAandplotscount_fullN<-PCOAandplotsboth_fullN %>% count(year,disk,ntrt)

####2003 for E002 only has 1 field so we remove it###

PCOAandplotsboth2_fullN<-PCOAandplotsboth_fullN %>%filter(year!=2003)

PCOAandplotscount2_fullN<-PCOAandplotsboth2_fullN %>% count(year,disk,ntrt)##good now###

PCOAandplotsboth2_fullN$Axis.1<-as.numeric(PCOAandplotsboth2_fullN$Axis.1)
PCOAandplotsboth2_fullN$Axis.2<-as.numeric(PCOAandplotsboth2_fullN$Axis.2)

PCOAandplotsboth2_fullN$year<-as.numeric(as.character(PCOAandplotsboth2_fullN$year))



PCOAandplotsavg_fullN<-PCOAandplotsboth2_fullN %>% group_by(exp,year,disk,ntrt) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())



####

## plot specifications

PCOAandplotsavg2_fullN<-mutate(PCOAandplotsavg_fullN, ntrt2=ntrt)

PCOAandplotsavg2_fullN$ntrt2<-PCOAandplotsavg2_fullN$ntrt



PCOAandplotsavg2_fullN$ntrt2  <- mapvalues(PCOAandplotsavg2_fullN$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

PCOAandplotsavg2_fullN$ntrt2 <- factor(PCOAandplotsavg2_fullN$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))




PCOAandplotsavg2_fullN<-PCOAandplotsavg2_fullN  %>% mutate(yearlabel=ifelse(year==1982|year==1992|year==2004,year, NA))%>%mutate(exp_ntrt= as.factor(paste(exp, ntrt, sep = '_')))

PCOAandplotsavg2_fullN$exp_ntrt <- factor(PCOAandplotsavg2_fullN$exp_ntrt , levels = c("1_9", "2_9", "1_1","2_1", "1_2", "2_2","1_3", "2_3", "1_4", "2_4","1_5", "2_5", "1_6", "2_6", "1_7", "2_7", "1_8", "2_8"))

PCOAandplotsavg3_fullN<-PCOAandplotsavg2_fullN %>% mutate(abclabel=exp_ntrt)
levels(PCOAandplotsavg3_fullN$abclabel) <- c( "(a) ", "(b) ", "(c) ", "(d) ", "(e) ", "(f) ", "(g) ", "(h) ", "(i) ", "(j) ", "(k) ", "(l) ", "(m) ", "(n) ", "(o) ", "(p) ", "(q) ", "(r) ")


PCOAandplotsavg3_fullN$disk<-plyr::mapvalues(PCOAandplotsavg3_fullN$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))




##
##to draw points between years###

ann_textdisk3 <- data.frame(meanAxis1 = c(0.00, 0.00), meanAxis2 =c(0.27, 0.27),exp= c("Intact in 1982 (E001)","Disturbed in 1982 (E002)"), year=c(1982, 1982), exp_ntrt=c("1_9", "2_9"),abclabel = factor(c("(a) ","(b) " ),levels = c("(a) ", "(b) ", "(c) ", "(d) ", "(e) ", "(f) ", "(g) ", "(h) ", "(i) ", "(j) ", "(k) ", "(l) ", "(m) ", "(n) ", "(o) ", "(p) ", "(q) ", "(r) ")))

#ann_textntrt <- data.frame(meanAxis1 = c(0.45, 0.45, 0.45, 0.45, 0.45,0.45,0.45,0.45,0.45), meanAxis2 =c(0.05, 0.05, 0.05, 0.05, 0.05,0.05,0.05,0.05,0.05),exp= c("2","2","2","2","2","2","2","2","2"), year=c(1982, 1982, 1982, 1982, 1982), exp_ntrt=c("2_9", "2_1", "2_2","2_3", "2_4","2_5", "2_6","2_7", "2_8"),abclabel = factor(c("(b) ","(d) ", "(f) ","(h) ","(j) " ,"l", "n", "p", "r"),levels = c("(a) ", "(b) ", "(c) ", "(d) ", "(e) ", "(f) ", "(g) ", "(h) ", "(i) ", "(j) ")))



PcoAfieldAveragedE001E002_fullN<-ggplot(PCOAandplotsavg3_fullN[order(PCOAandplotsavg3_fullN$year),], aes(x=meanAxis1  , y=meanAxis2 , group=exp_ntrt, color=year, label=year)) +
    geom_point(size=0.75) +
    geom_errorbar(aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2), color="dark gray", size=0.25) +
    geom_errorbarh(aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1), color="dark gray", size=0.25) +
    geom_path(aes(x=meanAxis1 , y=meanAxis2 , group=exp_ntrt, color=year),size=0.5)+
    geom_point(size=0.75) +
    xlim(c(min(PCOAandplotsavg3_fullN$meanAxis1-PCOAandplotsavg3_fullN$seAxis1)),max(PCOAandplotsavg3_fullN$meanAxis1+PCOAandplotsavg3_fullN$seAxis1))+
    ylim(c(min(PCOAandplotsavg3_fullN$meanAxis2-PCOAandplotsavg3_fullN$seAxis2)),max(PCOAandplotsavg3_fullN$meanAxis2+PCOAandplotsavg3_fullN$seAxis2))+
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    facet_grid(ntrt2~disk) + 
    #geom_text(aes(label=yearlabel),position=position_jitter(width=0.05,height=0.05), color="black", size=2.5)+
    mytheme+
    scale_color_viridis(option = "D")+
    scale_fill_viridis(option = "D",trans = 'reverse')+
    guides(#reverse color order (higher value on top)
    color = guide_colorbar(reverse = TRUE),
    #reverse size order (higher diameter on top) 
    size = guide_legend(reverse = TRUE))+
   #scale_y_continuous(breaks=c(-0.2, 0.0, 0.2, 0.4))+
    geom_text(aes(x = -0.26, y = 0.16, label = abclabel, group =     abclabel),size = 3,check_overlap = T)+
    theme(strip.background = element_blank())+
    theme(strip.text = element_text(face="bold", size=10))+
    theme(panel.spacing.y=unit(0.5, "lines"))
    #geom_text_repel(aes(label=yearlabel),size = 2.5, color="black")


```


```{r - recreate FIG 4 cd, PCoA by decade FULL N GRADIENT}


PCOAandplotsavg_fullN<-PCOAandplotsboth_fullN %>% group_by(exp,year,disk,ntrt) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())


###get rid of years where we don't have 9 or 18 plots###
####2003 for E002 only has 1 field, so remove it###

PCOAandplotsavg2_fullN<-subset(PCOAandplotsavg_fullN, n>8)


PCOAandplotsavg2_fullN<-PCOAandplotsavg2_fullN  %>% mutate(yearlabel=ifelse(year==1982|year==1988|year==1992|year==2004,year, NA))

######

##by decade####

PcoAplaying_fullN <- PCOAandplotsavg2_fullN %>% filter(year %in% c(1982,2004))

arrow_start_fullN <- PCOAandplotsavg2_fullN %>% filter(year ==1982)
arrow_stop_fullN<- PCOAandplotsavg2_fullN %>% filter(year == 2004)

wide_PcoAplaying_fullN <- pivot_wider(PcoAplaying_fullN, names_from = year, values_from = year)

##just pull out the first year of data##

PCOAandplots1982_fullN<-subset(PCOAandplotsavg2_fullN, year==1982)

##pull out the first, last, and midpoint year##

PCOAandplots198219922004_fullN<-subset(PCOAandplotsavg2_fullN, year==1982|year==1992|year==2004)

PCOAandplots198219922004_fullN<-PCOAandplots198219922004_fullN %>% mutate(abclabel=exp)%>% mutate(ntrt2=ntrt) %>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))

levels(PCOAandplots198219922004_fullN$abclabel) <- c( "(a) ", "(b) ")


PCOAandplots198219922004_fullN$ntrt2  <- mapvalues(PCOAandplots198219922004_fullN$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

PCOAandplots198219922004_fullN$ntrt2 <- factor(PCOAandplots198219922004_fullN$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))




#first arrow and second##
PcoAplayingfirst_fullN <- PCOAandplotsavg2_fullN %>% filter(year %in% c(1982,1992, 2004))

PcoAplayingfirst2_fullN<-PcoAplayingfirst_fullN %>% mutate(abclabel=exp)
levels(PcoAplayingfirst2_fullN$abclabel) <- c( "(c) ", "(d) ")

#make sure its in the right order##
PcoAplayingfirst2_fullN<-PcoAplayingfirst2_fullN %>% arrange(year)%>% arrange(exp)%>% arrange(ntrt)%>% mutate(ntrt2=ntrt) %>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))




PcoAplayingfirst2_fullN$ntrt2  <- mapvalues(PcoAplayingfirst2_fullN$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

PcoAplayingfirst2_fullN$ntrt2 <- factor(PcoAplayingfirst2_fullN$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))




wide_PcoAplaying1 <- pivot_wider(PcoAplayingfirst2_fullN, names_from = year, values_from = year)

wide_PcoAplaying1$`1982`<-as.numeric(as.character(wide_PcoAplaying1$`1982`))
wide_PcoAplaying1$`1992`<-as.numeric(as.character(wide_PcoAplaying1$`1992`))
wide_PcoAplaying1$`2004`<-as.numeric(as.character(wide_PcoAplaying1$`2004`))


PCOAandplotslabels_fullN<-subset(PcoAplayingfirst2_fullN, ntrt==4)
PCOAandplotslabels_fullN<-PCOAandplotslabels_fullN%>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))%>%  mutate(yearlabel= year)


######

## plot specifications



PCOAandplotsavg2_fullN$disk<-mapvalues(PCOAandplotsavg2_fullN$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



ann_textdisk2 <- data.frame(meanAxis1 = c(0.03, 0.03), meanAxis2 =c(0.27,0.27),exp= c("Intact in 1982 (E001)","Disturbed in 1982 (E002)"), ntrt2=c("None", "None"), expntrt=c("1_9" ,"2_9"), abclabel = factor(c("(a) ","(b) " ),levels = c("(c) ", "(d) ")))


####
mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


PcOAdecade_fullN<-ggplot(data=PcoAplayingfirst2_fullN, aes(x=meanAxis1  , y=meanAxis2 , color=ntrt2)) +
  geom_hline(yintercept = 0)+geom_vline(xintercept = 0)+
  geom_point(data=PCOAandplots198219922004_fullN, aes(x=meanAxis1  , y=meanAxis2 , group=ntrt2, shape=as.factor(year)), size=2)+
    geom_errorbar(data=PCOAandplots198219922004_fullN, aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2,color=ntrt2), size=0.25) +
  geom_errorbarh(data=PCOAandplots198219922004_fullN, aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1,color=ntrt2),  size=0.25) +
  geom_point(data=PCOAandplots198219922004_fullN, aes(x=meanAxis1  , y=meanAxis2 , group=ntrt2,color=ntrt2,shape=as.factor(year)))+
  geom_segment(data=wide_PcoAplaying1, aes(x=`1982`  , y=`1982`, xend =`1992`, yend = `1992`, color=ntrt2), arrow=arrow(length=unit(0.0, "cm"))) +
    geom_path(size=0.75, arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))+
      geom_segment(data=wide_PcoAplaying1, aes(x=`1992`  , y=`1992`, xend =`2004`, yend = `2004`, color=ntrt2), arrow=arrow(length=unit(0.0, "cm"))) +
    geom_path(size=0.75, arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))+
          geom_text(data=PCOAandplotslabels, aes(label=yearlabel),position = position_nudge(y = 0.001, x=0.02), color="black", size=3.0)+
    #ylab("PCoA 2")+
    ylab(expression(atop("", paste("PCoA 2"))))+
    xlab("PCoA 1")+
    facet_grid(~disk) + 
    xlim(-0.28,0.55)+
    ylim(-0.5,0.18)+
      mytheme+
    scale_shape_manual(values = c(21, 22, 24))+
      theme(strip.background = element_blank())+
      geom_text(aes(x = -0.25, y = 0.14, label = abclabel, group =     abclabel),size = 4, color= "black", check_overlap = T)+theme(strip.text = element_blank())


```



###PCOA across years controls and field D ###

```{r - Conduct a PCoA just controls plots over time (log)}

head(da_fieldD_3 ) #long form field D##
da_fieldD_3$exp<-1

head(d3woody)  ##long form fields ABC##


d3controls<-d3woody %>% filter(ntrt==9)%>% filter(exp==1) %>% select(field, exp, plot, year, species, mass.above)



da_fieldD_3<-da_fieldD_3 %>% select(field, exp, plot, year, species, mass.above)

fieldABCD<-rbind(da_fieldD_3, d3controls)

# Transpose data to be a site by species matrix
fieldABCD_wide <- reshape(fieldABCD,
                   v.names="mass.above",
                   idvar=c("field", "plot", "year"),
                   timevar="species",
                   direction="wide") 


fieldABCD_wide_sorted<-fieldABCD_wide%>%arrange(year)%>%arrange(plot)%>%arrange(field)%>%arrange(exp)

###count of plots###

##there should be 3 or 6 plots per field A, B, C to 2004, and 45 in field D ###########
plotcountcheck2<-fieldABCD_wide_sorted%>%group_by(exp, field, year) %>%  tally()



##subset to fewer years###


##just the plot data field ABCD##
plotABCD<-fieldABCD_wide_sorted%>% dplyr::select(field, exp, plot, year)


##just the veg data##

vegABCD<-fieldABCD_wide_sorted[5:201]


# Fill in NA's with zeros in wide data set
vegABCD[is.na(vegABCD)] <- 0


vegmatrixABCD<-as.matrix(vegABCD)

logvegABCD<-log(1+vegmatrixABCD)


## Bray curtis dissimiliarty matrix##
distABCD<-vegdist(logvegABCD, method="bray")
BCdistABCD<-as.matrix(distABCD)  ##into a matrix#
BCdistABCDdf<-as.data.frame(BCdistABCD)  #into a dataframe#

BCdistABCDdf2<-cbind(plotABCD,BCdistABCDdf) #merge plot data w/ dissim matrix##




##BCdistABCD2 has the plot info and the BC dissimilarity matrix for all the control plots from E001 ABC and field D ######

###PcOA fields ABCD####

PCOA_ABCD <- pcoa(BCdistABCD)  ## takes a while##


## extracting the axis scores for each exp##

PCOAaxes_ABCD<- PCOA_ABCD$vectors[,c(1,2)]


##merge the axis scores with the plot info...##

PCOAABCDandplots<-cbind(plotABCD, PCOAaxes_ABCD)



```


```{r - Supp figure PCOA controls ABCD}


PCOA_ABCD_average<-PCOAABCDandplots %>% group_by(field, year) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())



PCOA_ABCD_averageplot<-ggplot(PCOA_ABCD_average, aes(x=meanAxis1, y=meanAxis2 , group=field, color=year)) +
    geom_point(size=0.75) +
    geom_errorbar(aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2), color="dark gray", size=0.25) +
    geom_errorbarh(aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1), color="dark gray", size=0.25) +
    geom_path(aes(x=meanAxis1 , y=meanAxis2 , group=field, color=year),size=0.5)+
    geom_point(size=0.75) +
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    facet_grid(~field) + 
    mytheme+
    scale_color_viridis(option = "D")+
    scale_fill_viridis(option = "D",trans = 'reverse')+
    guides(#reverse color order (higher value on top)
    color = guide_colorbar(reverse = TRUE),
    #reverse size order (higher diameter on top) 
    size = guide_legend(reverse = TRUE))+
   #scale_y_continuous(breaks=c(-0.2, 0.0, 0.2, 0.4))+
    theme(strip.background = element_blank())+
    theme(strip.text = element_text(face="bold", size=10))+
    theme(panel.spacing.y=unit(0.5, "lines"))
    #geom_text_repel(aes(label=yearlabel),size = 2.5, color="black")


##########



######

##Picking out a few years to show trajectory...##


PCOA_ABCD_average

##pull out the first, last, and midpoint year##

PCOA_ABCD_averagesubset<-subset(PCOA_ABCD_average, year==1982|year==1987|year==1992|year==1996|year==2004)


## to get arrows..###

wide_ABCD<- pivot_wider(PCOA_ABCD_averagesubset, names_from = year, values_from = year)

wide_ABCD$`1982`<-as.numeric(as.character(wide_ABCD$`1982`))
wide_ABCD$`1987`<-as.numeric(as.character(wide_ABCD$`1987`))
wide_ABCD$`1992`<-as.numeric(as.character(wide_ABCD$`1992`))
wide_ABCD$`1996`<-as.numeric(as.character(wide_ABCD$`1996`))
wide_ABCD$`2004`<-as.numeric(as.character(wide_ABCD$`2004`))

######

PCOA_ABCD_averagesubset$field<-mapvalues(PCOA_ABCD_averagesubset$field, from=c("A", "B", "C", "D"), to=c("A (Last farmed 1968)", "B (Last farmed 1957)", "C (Last farmed in 1934)", "D (Never farmed)"))

wide_ABCD$field<-mapvalues(wide_ABCD$field, from=c("A", "B", "C", "D"), to=c("A (Last farmed 1968)", "B (Last farmed 1957)", "C (Last farmed in 1934)", "D (Never farmed)"))


####
mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


#subsetfor labels#
PCOA_ABCD_averagesubset19822004<-subset(PCOA_ABCD_averagesubset, year==1982|year==2004)


PcOAdecadeABCD<-ggplot(data=PCOA_ABCD_averagesubset, aes(x=meanAxis1  , y=meanAxis2 , color=field)) +
  geom_point(data=PCOA_ABCD_averagesubset, aes(x=meanAxis1  , y=meanAxis2 , group=field, label=as.factor(as.character(year))))+
    geom_errorbar(data=PCOA_ABCD_averagesubset, aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2), size=0.25) +
  geom_errorbarh(data=PCOA_ABCD_averagesubset, aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1),  size=0.25) +
      geom_path(size=0.75, arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))+
      geom_segment(data=wide_ABCD, aes(x=`1982`  , y=`1982`, xend =`1987`, yend = `1987`, color=field), arrow=arrow(length=unit(0.0, "cm"))) +
        geom_segment(data=wide_ABCD, aes(x=`1987`  , y=`1987`, xend =`1992`, yend = `1992`, color=field), arrow=arrow(length=unit(0.0, "cm"))) +
        geom_segment(data=wide_ABCD, aes(x=`1992`  , y=`1992`, xend =`1996`, yend = `1996`, color=field), arrow=arrow(length=unit(0.0, "cm"))) +
        geom_segment(data=wide_ABCD, aes(x=`1996`  , y=`1996`, xend =`2004`, yend = `2004`, color=field), arrow=arrow(length=unit(0.0, "cm"))) +
    ylab(expression(atop("", paste("PCoA 2"))))+
    xlab("PCoA 1")+
    xlim(-0.35,0.65)+
   ylim(-0.4,0.25)+
     mytheme+
    theme(strip.background = element_blank())+
    geom_text(data=PCOA_ABCD_averagesubset19822004, aes(label = as.factor(as.character(year)), group = field),size = 4,check_overlap = T,nudge_x = -0.08,
  nudge_y = -0.02)
      


```




###DISPERSION####
```{r - Calculate the distance TO centroid within ntrt treatments (log data)}


###need to have the most recent verion of vegan from github for this to work##
#https://github.com/vegandevs/vegan/issues/331#


#######################

####for this analysis, getting rid of the years where not every field was sampeled##

exp12subset_2<-exp12subset_1%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)

##just the veg data##

veg<-exp12subset_2%>% dplyr::select(`mass.above.ACHILLEA MILLEFOLIUM(LANULOSA)`:`mass.above.VIOLA SP.`)



###log transformation####

vegmatrix<-as.matrix(veg)

logveg<-log(1+vegmatrix)



##using the apply function to calculation the dispersion (beta disp) for each nutrient treatment for each year#

bd_allboth<-betadisper(vegdist(logveg),exp12subset_2$expntrtyear, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a bit##

#bd_allbothEUC<-betadisper(vegdist(logveg, method="euclidean"),exp12subset_2$expntrtyear, type = "centroid")    ##same thing but in Euclidean distance###

##some squared distances are negative and changed to zero##


######making group distances into a dataframe with rownames###

bd_allboth_2<-as.data.frame(bd_allboth$group.distances, row.names = rownames(bd_allboth$group.distances))

setDT(bd_allboth_2, keep.rownames = TRUE)[]


bd_allboth_df<-separate(data = bd_allboth_2, col = rn, into = c("exp", "ntrt", "year"))

bd_allboth_df$year<-as.numeric(bd_allboth_df$year)
bd_allboth_df$ntrt<-as.factor(bd_allboth_df$ntrt)

bd_allboth_df$distances<-as.numeric(bd_allboth_df$`bd_allboth$group.distances`)

bd_allboth_df2<-bd_allboth_df%>%mutate(ntrt2 = ntrt)

###this dataframe (bd_allboth_df2) has the average distance to the centroid for each disurbance_nutrient group for each year. Distances = the average Bray dist for 18 plots to their group centroids (what is plotted in Fig 3 a) ##


```


```{r - AIC table dist TO centroid, TABLE S1 }

####test whether the distance to centroid is best fit by a linear or saturating function##


head(bd_allboth_df2)

bd_allboth_df2<-bd_allboth_df2%>% mutate (year2=year-1981)


###linear fit###

distlin<-lm(distances~year2, data=bd_allboth_df2)


##saturating function##
distnonlin<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = bd_allboth_df2)


rawaic<-AIC(distlin, distnonlin)
nR<-dim(bd_allboth_df2)[1]  #Sample size 
aictable(rawaic,nR)

###nonlinear is the best fit###

```


```{r - model fits and error dist TO centroid, TABLE S2}


head(bd_allboth_df2)

###https://www.statforbiology.com/nonlinearregression/usefulequations#asymptotic_regression_model###

groupdistancesboth2_df<-bd_allboth_df2%>% mutate(year2=year-1981)

groupdistcontrol<-bd_allboth_df2%>% filter(ntrt==9)%>%mutate(year2=year-1981)


###E002 seperate by nutrient and experiment####

controlE002<-subset(groupdistancesboth2_df, ntrt==9 & exp==2)
E002distntrt1<-subset(groupdistancesboth2_df, ntrt==1 & exp==2)
E002distntrt2<-subset(groupdistancesboth2_df, ntrt==2 & exp==2)
E002distntrt4<-subset(groupdistancesboth2_df, ntrt==4 & exp==2)
E002distntrt6<-subset(groupdistancesboth2_df, ntrt==6 & exp==2)

#
#E002 #Non linear model fits##

controlE002fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = controlE002)
E002distntrt1fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E002distntrt1)
E002distntrt2fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E002distntrt2)
E002distntrt4fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E002distntrt4)
E002distntrt6fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E002distntrt6)


##Seperate experiment and N treatments, E001 ##

controlE001<-subset(groupdistancesboth2_df, ntrt==9 & exp==1)
E001distntrt1<-subset(groupdistancesboth2_df, ntrt==1 & exp==1)
E001distntrt2<-subset(groupdistancesboth2_df, ntrt==2 & exp==1)
E001distntrt4<-subset(groupdistancesboth2_df, ntrt==4 & exp==1)
E001distntrt6<-subset(groupdistancesboth2_df, ntrt==6 & exp==1)


####Nonlinear model fits E001##

controlE001fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = controlE001)
E001distntrt1fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E001distntrt1)
E001distntrt2fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E001distntrt2)
E001distntrt4fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E001distntrt4)
#E001distntrt6fit<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = E001distntrt6) ##doesn't work...see below###

####this (ntrt6) is weird (have to specify lrc and then it works...##

x6=E001distntrt6$year2
y6=E001distntrt6$distances

##first, specify the fit##
asympfunc <- function(x6, Asym, R0, lrc=coef(E002distntrt6fit)[3])
    Asym + (R0 - Asym) * exp(-exp(lrc) * x6)
nls(y6 ~ asympfunc(x6, Asym, R0),
    data = data.frame(x6, y6),
    start = list(Asym = 0.3,R0=0.5))


E001distntrt6fit<-nls(y6 ~ asympfunc(x6, Asym, R0),
    data = data.frame(x6, y6),
    start = as.list(coef(E002distntrt6fit)[c(1, 2)]))

###THESE ARE ALL THE VALUES IN TABLE S1###

summary(controlE001fit)
summary(E001distntrt1fit)
summary(E001distntrt2fit)
summary(E001distntrt4fit)
summary(E001distntrt6fit)

summary(controlE002fit)
summary(E002distntrt1fit)
summary(E002distntrt2fit)
summary(E002distntrt4fit)
summary(E002distntrt6fit)



#### get the predictions from each of the NLS models we made for graphing####

predcontrolE001 <- predict(controlE001fit)
predntrt1E001 <- predict(E001distntrt1fit)
predntrt2E001 <- predict(E001distntrt2fit)
predntrt4E001 <- predict(E001distntrt4fit)
predntrt6E001 <- predict(E001distntrt6fit)


predcontrolE002 <- predict(controlE002fit)
predntrt1E002 <- predict(E002distntrt1fit)
predntrt2E002 <- predict(E002distntrt2fit)
predntrt4E002 <- predict(E002distntrt4fit)
predntrt6E002 <- predict(E002distntrt6fit)


predcontrolE001_df<-as.data.frame(cbind(controlE001, pred=predcontrolE001))
predntrt1E001_df<-as.data.frame(cbind(E001distntrt1, pred=predntrt1E001))
predntrt2E001_df<-as.data.frame(cbind(E001distntrt2, pred=predntrt2E001))
predntrt4E001_df<-as.data.frame(cbind(E001distntrt4, pred=predntrt4E001))
predntrt6E001_df<-as.data.frame(cbind(E001distntrt6, pred=predntrt6E001))



predcontrolE002_df<-as.data.frame(cbind(controlE002, pred=predcontrolE002))
predntrt1E002_df<-as.data.frame(cbind(E002distntrt1, pred=predntrt1E002))
predntrt2E002_df<-as.data.frame(cbind(E002distntrt2, pred=predntrt2E002))
predntrt4E002_df<-as.data.frame(cbind(E002distntrt4, pred=predntrt4E002))
predntrt6E002_df<-as.data.frame(cbind(E002distntrt6, pred=predntrt6E002))


allpred_df<-rbind(predcontrolE001_df,predntrt1E001_df,predntrt2E001_df,predntrt4E001_df,predntrt6E001_df,predcontrolE002_df,predntrt1E002_df,predntrt2E002_df,predntrt4E002_df,predntrt6E002_df)







```


```{r - recreate FIG 3ab, Distance to the centroid (log data)}


head(groupdistancesboth2_df)






##confidence intervals around the control only###

## confidence intervals E001##

confE001 <- as.data.frame(predFit(controlE001fit,interval = "confidence", level= 0.95))

confE001_1<-cbind(controlE001,confE001)

## confidence intervals E002##

confE002 <- as.data.frame(predFit(controlE002fit,interval = "confidence", level= 0.95))

confE002_2<-cbind(controlE002,confE002)

confboth<-rbind(confE001_1,confE002_2)

##combine and add label###
confboth<-rbind(confE001_1, confE002_2)

confboth_2<-confboth %>% mutate(abclabel=exp)
levels(confboth_2$abclabel) <- c( "(a) ", "(b) ")



##### plot specifications###

allpred_df$ntrt2  <- mapvalues(allpred_df$ntrt2, from=c("9", "1", "2", "3", "4","5","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))

allpred_df$ntrt2 <- factor(allpred_df$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))


allpred_df$exp<-mapvalues(allpred_df$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

allpred_df$exp<- factor(allpred_df$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



groupdistcontrol<-groupdistcontrol %>% mutate(abclabel=exp)
levels(groupdistcontrol$abclabel) <- c("(a) ", "(b) ")


groupdistancesboth2_df<-groupdistancesboth2_df %>% mutate(abclabel=exp)
levels(groupdistancesboth2_df$abclabel)<- c("(a) ", "(b) ")


confboth_2$exp<-mapvalues(confboth_2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

confboth_2$exp<- factor(confboth_2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


groupdistcontrol$exp<-mapvalues(groupdistcontrol$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

groupdistcontrol$exp<- factor(groupdistcontrol$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))




groupdistancesboth2_df$exp<-mapvalues(groupdistancesboth2_df$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

groupdistancesboth2_df$exp<- factor(groupdistancesboth2_df$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

groupdistancesboth2_df<-groupdistancesboth2_df%>%mutate(ntrt2 = as.factor(ntrt))

groupdistancesboth2_df$ntrt2  <- mapvalues(groupdistancesboth2_df$ntrt2, from=c("9", "1", "2", "3", "4","5","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))

groupdistancesboth2_df$ntrt2 <- factor(groupdistancesboth2_df$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro"))


groupdistancesboth2_df<-groupdistancesboth2_df %>% mutate(abclabel=exp)
levels(groupdistancesboth2_df$abclabel) <- c( "(a) ", "(b) ")


ann_textdisk1 <- data.frame(year2 = c(12,12), distances =c(0.7, 0.7),exp= c("Intact in 1982 (E001)","Disturbed in 1982 (E002)"), ntrt2=c("None", "None"), abclabel = factor(c("(a) ","(b) " ),levels = c("(a) ", "(b) ")))

####



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


disttocentroidplot<- ggplot(data=groupdistancesboth2_df) +
    geom_point(data=groupdistancesboth2_df, aes(x=as.numeric(as.character(year2)), y=distances, group=ntrt2, color=ntrt2)) +
    geom_point(data=groupdistcontrol, aes(x=as.numeric(as.character(year2)), y=distances),     color="gray45") +
    geom_line(data=allpred_df,aes(x=as.numeric(as.character(year2)), y=pred, group=ntrt2, color=ntrt2) )+
    geom_ribbon(data=confboth_2, aes(ymin=lwr, ymax=upr, x=year2), color=NA, alpha=0.2)+
    facet_grid(~exp)+ 
    ylab(expression('Average distance to group centroid'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
     geom_text(aes(x = 1.5, y = 0.60, label = abclabel, group =     abclabel),size = 4,check_overlap = T)

```


###DISPERSION WITH ALL N TREATMENTS###
```{r - Calculate the distance TO centroid within ntrt treatments all treatments (log data)}


###need to have the most recent verion of vegan from github for this to work##
#https://github.com/vegandevs/vegan/issues/331#


#######################

####All nutrient treatments....####

exp12subset<-subset(da.wide5,year<2005)

##get rid of years not all fields were sampeled###

#exp12subset_full<-exp12subset%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)

##just the veg data##

veg_full<-exp12subset%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)



###log transformation####

vegmatrixfull<-as.matrix(veg_full)

logvegfull<-log(1+vegmatrixfull)



##using the apply function to calculation the dispersion (beta disp) for each nutrient treatment for each year#

bd_allbothfull<-betadisper(vegdist(logvegfull),exp12subset$expntrtyear, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a bit##

#bd_allbothEUC<-betadisper(vegdist(logveg, method="euclidean"),exp12subset_2$expntrtyear, type = "centroid")    ##same thing but in Euclidean distance###

##some squared distances are negative and changed to zero##


######making group distances into a dataframe with rownames###

bd_allbothfull_2<-as.data.frame(bd_allbothfull$group.distances, row.names = rownames(bd_allbothfull$group.distances))

setDT(bd_allbothfull_2, keep.rownames = TRUE)[]


bd_allbothfull_df<-separate(data = bd_allbothfull_2, col = rn, into = c("exp", "ntrt", "year"))

bd_allbothfull_df$year<-as.numeric(bd_allbothfull_df$year)
bd_allbothfull_df$ntrt<-as.factor(bd_allbothfull_df$ntrt)

bd_allbothfull_df$distances<-as.numeric(bd_allbothfull_df$`bd_allbothfull$group.distances`)

bd_allbothfull_df2<-bd_allbothfull_df%>%mutate(ntrt2 = ntrt)

###this dataframe (bd_allboth_fulldf2) has the average distance to the centroid for each disurbance_nutrient group for each year. Distances = the average Bray dist for 18 plots to their group centroids (what is plotted in Fig 3 a) ##

## INCLUDES ALL NUTRIENT GROUPS###



```


### PLOT DISPERSION WITH ALL N TREATMENTS###
```{r - recreate FIG 3ab, w/ ALL nutrient treatments (log data)}


head(bd_allbothfull_df2)



##### plot specifications###

bd_allbothfull_df2$exp<-mapvalues(bd_allbothfull_df2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

bd_allbothfull_df2$exp<- factor(bd_allbothfull_df2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



bd_allbothfull_df2$ntrt2  <- mapvalues(bd_allbothfull_df2$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

bd_allbothfull_df2$ntrt2 <- factor(bd_allbothfull_df2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


disttocentroidplot<- ggplot(bd_allbothfull_df2) +
    geom_point(data=bd_allbothfull_df2, aes(x=as.numeric(as.character(year)), y=distances, group=ntrt2, color=ntrt2)) +
   geom_smooth(data=bd_allbothfull_df2,   aes(x=as.numeric(as.character(year)), y=distances, group=ntrt2, color=ntrt2), method="loess", se=FALSE) +
   facet_grid(~exp)+ 
    ylab(expression('Average distance to group centroid'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())

```



###DISPERSION WITH ALL N TREATMENTS AND BY FIELD ###
```{r - Calculate the distance TO centroid within ntrt treatments all treatments (log data)}


###need to have the most recent verion of vegan from github for this to work##
#https://github.com/vegandevs/vegan/issues/331#

##START W/ DATA SET FOR E001 that only goes to 2004, and E002 to 2019 (fields A and C)##

head(da.wide5)

####check the plotyears####


plotcountcheck5<-da.wide5%>%group_by(exp, field, year) %>%  tally()

plotcountcheck55<-da.wide5%>%group_by(exp, year) %>%  tally()

###### time series only extends > 2004 for E002###


##plot data##
plot_full<-da.wide5%>%dplyr::select(field:expntrtyear) %>% mutate(expfieldplotyear= paste(exp,field,plot,year, sep = '_'))

##just the veg data##

veg_full<-da.wide5%>% dplyr::select(`mass.above.ACER NEGUNDO` :`mass.above.VIOLA SP.`)



###log transformation####

vegmatrixfull<-as.matrix(veg_full)

logvegfull<-log(1+vegmatrixfull)



##using the apply function to calculation the dispersion (beta disp) for each nutrient treatment for each FIELD for each year#

bd_allbyfield<-betadisper(vegdist(logvegfull),plot_full$expntrtfieldyear, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a VERY LONG TIME ##

#bd_allbothEUC<-betadisper(vegdist(logveg, method="euclidean"),exp12subset_2$expntrtyear, type = "centroid")    ##same thing but in Euclidean distance###

##some squared distances are negative and changed to zero##


######making group distances into a dataframe with rownames###


bd_allbyfield_2<-as.data.frame(bd_allbyfield$group.distances, row.names = rownames(bd_allbyfield$group.distances))

setDT(bd_allbyfield_2, keep.rownames = TRUE)[]


bd_allbyfield_2_df<-separate(data = bd_allbyfield_2, col = rn, into = c("exp", "field", "ntrt", "year"))

bd_allbyfield_2_df$year<-as.numeric(bd_allbyfield_2_df$year)
bd_allbyfield_2_df$ntrt<-as.factor(bd_allbyfield_2_df$ntrt)

bd_allbyfield_2_df$distances<-as.numeric(bd_allbyfield_2_df$`bd_allbyfield$group.distances`)

bd_allbyfield_2_df<-bd_allbyfield_2_df%>%mutate(ntrt2 = ntrt)%>% mutate(year2=year-1981)

###this dataframe (bd_allbyfield_2_df) has the average distance to the centroid for each disurbance_nutrient group in each field for each year. Distances = the average Bray dist for 6 plots to their group centroids (what is plotted in Fig 3 a) ##

## INCLUDES ALL NUTRIENT GROUPS BY FIELD###



```



###PLOT DISPERSION WITH ALL N TREATMENTS AND BY FIELD ###
```{r - recreate FIG 3ab, w/ ALL nutrient treatments BY FIELD (log data)}


head(bd_allbyfield_2_df)



##### plot specifications###

bd_allbyfield_2_df$exp<-mapvalues(bd_allbyfield_2_df$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

bd_allbyfield_2_df$exp<- factor(bd_allbyfield_2_df$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



bd_allbyfield_2_df$ntrt2  <- mapvalues(bd_allbyfield_2_df$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

bd_allbyfield_2_df$ntrt2 <- factor(bd_allbyfield_2_df$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))




mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


disttocentroidplotBYFIELD<- ggplot(bd_allbyfield_2_df, aes(x=year2, y=distances, group=ntrt2, color=ntrt2)) +
    geom_point()  +
   geom_smooth(method="loess", se=FALSE) +
   facet_grid(vars(field), vars(exp))+ 
    ylab(expression('Average distance to group centroid'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())



disttocentroidplotBYFIELD_2<- ggplot(bd_allbyfield_2_df, aes(x=year2, y=distances)) +
    geom_point()  +
   geom_smooth(method="lm", se=FALSE) +
   facet_grid(vars(field), vars(exp))+ 
    ylab(expression('Average distance to group centroid'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())


```




##let's see whats going on with E001 field C compared to B...###


```{r - Exploring E001 field C (versus field B) }

##PCOAandplotsboth_fullN###

head(PCOAandplotsboth_fullN)

head(bd_allbyfield_2_df)


#### just pull out E001 field B and C subset of years: 1982, 1992, 2004 ####


PCOAandplotsE001ABsubset<-PCOAandplotsboth_fullN %>% filter(exp==1)%>% filter(field=="B"|field=="C")%>% filter(year=="1982"|year=="1994"|year=="2004")


groupcentroidssubset<- bd_allbyfield_2_df%>% filter(exp=="Intact in 1982 (E001)")%>% filter(field=="B"|field=="C")%>% filter(year==1982|year==1994|year==2004)


#getting the convex hull of each unique point set
hull <- PCOAandplotsE001ABsubset %>% group_by(field, ntrt,year) %>% 
  slice(chull(Axis.1,Axis.2))


E001fieldBandC<-ggplot(PCOAandplotsE001ABsubset, aes(x=Axis.1, y=Axis.2, color=ntrt, fill=ntrt)) +
    geom_point() +
    geom_polygon(data = hull, alpha = 0.5)+
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    mytheme+
    facet_grid(vars(year), vars(field))+ 
    theme(strip.background = element_blank())+
    theme(strip.text = element_text(face="bold", size=10))+
    theme(panel.spacing.y=unit(0.5, "lines"))
    #geom_text_repel(aes(label=yearlabel),size = 2.5, color="black")




```

######## DISTANCE BETWEEN CENTROIDS#############

```{r - Calculate the distance BTWN centroids (logdata) }

##pulling out the group centroids by year####

centroiddf<-as.data.frame(bd_allboth[["centroids"]])

centroiddf_2<-centroiddf[,1:2]

centroiddf_2 <- tibble::rownames_to_column(centroiddf_2, "expntrtyear")

centroiddf_2<-separate(data = centroiddf_2, col = expntrtyear, into = c("exp", "ntrt", "year"))

centroiddf_3<-centroiddf_2%>% mutate(expyear= paste(exp,year, sep = '_')) 


###grand mean centroid for all treatments each year###

grandcentroid<-centroiddf_2%>% group_by(exp, year) %>% dplyr::summarise(PcoA1centroid=mean(PCoA1, na.rm=TRUE),PcoA2centroid=mean(PCoA2, na.rm=TRUE))%>% mutate(expyear= paste(exp,year, sep = '_')) 


### merge the treatments means with the grand mean centroid for each year##

centroiddf_3<-merge(data.frame(centroiddf_3), data.frame(grandcentroid), by = "expyear", all = TRUE)

###calculate the distance from each centroid to grand centroid using pythagoreum theorem###

centroiddf_4<-centroiddf_3 %>% mutate(distgrandcent=sqrt((PcoA1centroid- PCoA1)^2+(PcoA2centroid-PCoA2)^2))


###average distance of each group to its grand mean##

centroiddists<-centroiddf_4%>% group_by(expyear) %>% dplyr::summarise(meandist=mean(distgrandcent, na.rm=TRUE))%>%separate(col = expyear, into = c("exp", "year"))


##this dataframe (centroidsdists) has the average distance between nutrient group centroids for each year, for each experiment####

```

```{r - AIC table dist BTWN centroid, TABLE S3 }


centroiddists2<-centroiddists%>% mutate (year2=as.numeric(as.character(year))-1981)

###linear fit###

distbtwnlin<-lm(meandist~year2, data=centroiddists2)


##saturating function##
distbtwnnonlin<- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists2)


rawaic<-AIC(distbtwnlin, distbtwnnonlin)
nR<-dim(bd_allboth_df2)[1]  #Sample size 
aictable(rawaic,nR)

###Nonlinear is the best fit###

```

```{r - recreate FIG 3 cd, distance BTWN centroids (logdata)}

centroiddists$year<-as.numeric(as.character(centroiddists$year))

centroiddists_2<-centroiddists%>% mutate(year2=year-1981)


####subset by exp###

centroiddists_E001<-subset(centroiddists_2, exp==1)
centroiddists_E002<-subset(centroiddists_2, exp==2)


###https://www.r-bloggers.com/2021/07/asymptotic-confidence-intervals-for-nls-regression-in-r/##

asympfitcentroidE001<- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists_E001)

asympfitcentroidE002 <- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists_E002)


###confidence intervals around fit###


new.dataE001 <- data.frame(year2=centroiddists_E001$year2)
new.dataE002 <- data.frame(year2=centroiddists_E002$year2)


confE001_centroid <- as_tibble(predFit(asympfitcentroidE001, newdata = new.dataE001, interval = "confidence", level= 0.95)) %>% mutate(year2 = new.dataE001$year2)

confE001_centroiddf<-as.data.frame(confE001_centroid)

confE001_centroiddf2<-cbind(centroiddists_E001, confE001_centroiddf)


confE002_centroid <- as_tibble(predFit(asympfitcentroidE002, newdata = new.dataE002, interval = "confidence", level= 0.95)) %>% mutate(year2 = new.dataE002$year2)


confE002_centroiddf<-as.data.frame(confE002_centroid)

confE002_centroiddf2<-cbind(centroiddists_E002, confE002_centroiddf)


      ##combine togeter and add abc label##
confcentroidboth<-rbind(confE001_centroiddf2, confE002_centroiddf2)


###for plotting####


centroiddists_2$exp<-mapvalues(centroiddists_2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddists_2$exp<- factor(centroiddists_2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


centroiddists_3<-centroiddists_2%>% mutate(abclabel=exp)

levels(centroiddists_3$abclabel) <- c( "(c) ", "(d) ")


confcentroidboth$exp<-mapvalues(confcentroidboth$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

confcentroidboth$exp<- factor(confcentroidboth$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


confcentroidboth_2<-confcentroidboth[,1:7] %>% mutate(abclabel=exp)

levels(confcentroidboth_2$abclabel) <- c( "(c) ", "(d) ")



distbetweencentroids<-ggplot(data=centroiddists_3,aes(x=as.numeric(as.character(year2)),y=meandist)) +
    geom_point() +
    facet_grid(~exp) +
    ylab(expression('Average distance between group centroids'))+
    xlab("Time since experiment (years)")+
    geom_smooth(method="nls", formula=y~SSasymp(x, Asym, R0, lrc), colour = "black", size = 0.5, se=F, fullrange=T)+
    geom_ribbon(data=confcentroidboth_2, aes(ymin=lwr, ymax=upr), color=NA, fill = "gray1", alpha=0.2)+
    mytheme+
    theme(legend.position="none")+
     theme(strip.text = element_blank())+
     theme(strip.background = element_blank())+
     geom_text(aes(x = 1.5, y = 0.18, label = abclabel, group =     abclabel),size = 4,check_overlap = T)
  



```



######## DISTANCE BETWEEN CENTROIDS ALL N ###


###DISPERSION WITH ALL N TREATMENTS###
```{r - Calculate the distance BETWEEM centroids all ntrt treatments all treatments (log data)}


bd_allbothfull_df2<-bd_allbothfull_df%>%mutate(ntrt2 = ntrt)


##pulling out the group centroids by year####

centroiddf_full<-as.data.frame(bd_allbothfull[["centroids"]])

centroiddf_full_2<-centroiddf_full[,1:2]

centroiddf_full_2<- tibble::rownames_to_column(centroiddf_full_2, "expntrtyear")

centroiddf_full_2<-separate(data = centroiddf_full_2, col = expntrtyear, into = c("exp", "ntrt", "year"))

centroiddf_full_3<-centroiddf_full_2%>% mutate(expyear= paste(exp,year, sep = '_')) 


###grand mean centroid for all treatments each year###

grandcentroid_full<-centroiddf_full_3%>% group_by(exp, year) %>% dplyr::summarise(PcoA1centroid=mean(PCoA1, na.rm=TRUE),PcoA2centroid=mean(PCoA2, na.rm=TRUE))%>% mutate(expyear= paste(exp,year, sep = '_')) 


### merge the treatments means with the grand mean centroid for each year##

centroiddf_full<-merge(data.frame(centroiddf_full_3), data.frame(grandcentroid_full), by = "expyear", all = TRUE)

###calculate the distance from each centroid to grand centroid using pythagoreum theorem###

centroiddf_full_4<-centroiddf_full %>% mutate(distgrandcent=sqrt((PcoA1centroid- PCoA1)^2+(PcoA2centroid-PCoA2)^2))


###average distance of each group to its grand mean##

centroiddists_full<-centroiddf_full_4%>% group_by(expyear) %>% dplyr::summarise(meandist=mean(distgrandcent, na.rm=TRUE))%>%separate(col = expyear, into = c("exp", "year"))







```


```{r - recreate FIG 3 cd, distance BTWN centroids all ntrt treatmetns (logdata)}

centroiddists_full$year<-as.numeric(as.character(centroiddists_full$year))

centroiddists_full_2<-centroiddists_full%>% mutate(year2=year-1981)


####subset by exp###

centroiddists_full_E001<-subset(centroiddists_full, exp==1)
centroiddists_full_E002<-subset(centroiddists_full, exp==2)


###https://www.r-bloggers.com/2021/07/asymptotic-confidence-intervals-for-nls-regression-in-r/##

#asympfitcentroidE001_full<- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists_full_E001)

#asympfitcentroidE002_full <- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists_full_E002)



###for plotting####




centroiddists_full$exp<-mapvalues(centroiddists_full$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddists_full$exp<- factor(centroiddists_full$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



distbetweencentroids_fullN<-ggplot(data=centroiddists_full_2,aes(x=as.numeric(as.character(year2)),y=meandist)) +
    geom_point() +
    facet_grid(~exp) +
    ylab(expression('Average distance between group centroids'))+
    xlab("Time since experiment (years)")+
    geom_smooth(method="loess")+
    theme(legend.position="none")+
     theme(strip.text = element_blank())+
     theme(strip.background = element_blank())+
    mytheme
 
  



```



######## DISTANCE BETWEEN CENTROIDS ALL N and BY FIELD###

```{r - recreate FIG 3 cd, distance BTWN centroids BY FIELD (logdata)}

head(bd_allbyfield_2_df)


##pulling out the group centroids by year####

centroidbyfield<-as.data.frame(bd_allbyfield[["centroids"]])

centroiddfbyfield_2<-centroidbyfield[,1:2]

centroiddfbyfield_2<- tibble::rownames_to_column(centroiddfbyfield_2, "expfieldntrtyear")

centroiddfbyfield_2<-separate(data = centroiddfbyfield_2, col = expfieldntrtyear, into = c("exp", "field", "ntrt", "year"))

centroiddfbyfield_3<-centroiddfbyfield_2%>% mutate(expfieldyear= paste(exp,field,year, sep = '_')) 
####



###grand mean centroid for all fields and treatments each year###

grandcentroidbyfield_full<-centroiddfbyfield_3%>% group_by(exp, field,year) %>% dplyr::summarise(PcoA1centroid=mean(PCoA1, na.rm=TRUE),PcoA2centroid=mean(PCoA2, na.rm=TRUE))%>% mutate(expfieldyear= paste(exp,field,year, sep = '_')) 


### merge the treatments means with the grand mean centroid for each year##

centroiddfbyfield_full<-merge(data.frame(centroiddfbyfield_3), data.frame(grandcentroidbyfield_full), by = "expfieldyear", all = TRUE)

###calculate the distance from each centroid to grand centroid using pythagoreum theorem###

centroiddfbyfield_full_4<-centroiddfbyfield_full %>% mutate(distgrandcent=sqrt((PcoA1centroid- PCoA1)^2+(PcoA2centroid-PCoA2)^2))


###average distance of each group to its grand mean##

centroiddistsbyfield_full<-centroiddfbyfield_full_4%>% group_by(expfieldyear) %>% dplyr::summarise(meandist=mean(distgrandcent, na.rm=TRUE))%>%separate(col = expfieldyear, into = c("exp","field", "year"))



centroiddistsbyfield_full$exp<-mapvalues(centroiddistsbyfield_full$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddistsbyfield_full$exp<- factor(centroiddistsbyfield_full$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddistsbyfield_full_2<-centroiddistsbyfield_full%>% mutate(year2=as.numeric(year)-1981)



distbetweencentroidsbyfield_fullN<-ggplot(data=centroiddistsbyfield_full_2,aes(x=as.numeric(as.character(year2)),y=meandist)) +
    geom_point() +
    facet_grid(vars(field), vars(exp))+ 
    ylab(expression('Average distance between group centroids'))+
    xlab("Time since experiment (years)")+
    geom_smooth(method="loess")+
    theme(legend.position="none")+
     theme(strip.text = element_blank())+
     theme(strip.background = element_blank())+
    mytheme




```




#### DISPERSION BY FIELD WITH ALL NUTRIENT TREATMENTS####

```{r - Model fits and error dist BTWN centroid, TABLE S4}


#dist between centroids#
asympfitcentroidE001
asympfitcentroidE002

summary(asympfitcentroidE001)
summary(asympfitcentroidE002)

```


```{r - recreate FIG 3 abcd}

quaddisttocentroidplotnox<- ggplot(data=groupdistancesboth2_df) +
    geom_point(data=groupdistancesboth2_df, aes(x=as.numeric(as.character(year2)), y=distances, group=ntrt2, color=ntrt2)) +
    geom_point(data=groupdistcontrol, aes(x=as.numeric(as.character(year2)), y=distances),     color="gray45") +
    geom_line(data=allpred_df,aes(x=as.numeric(as.character(year2)), y=pred, group=ntrt2, color=ntrt2) )+
    geom_ribbon(data=confboth_2, aes(ymin=lwr, ymax=upr, x=year2), color=NA, alpha=0.2)+
    facet_grid(~exp)+ 
    ylab(expression('Average distance to group centroid'))+
    xlab("Time since experiment")+
    theme(legend.position="right")+
    mytheme+
    theme(legend.title = element_blank()) + 
    scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
     geom_text(aes(x = 1.5, y = 0.60, label = abclabel, group =     abclabel),size = 4,check_overlap = T)+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())


disttocentroidplot_2<-quaddisttocentroidplotnox+ theme(legend.position = c(0.85, 0.75))+theme(legend.text = element_text(size = 8))+ guides(color = guide_legend(override.aes = list(size = 0.5)))+theme(legend.margin = margin(0, 0, 0, 0))+theme(legend.spacing.y = unit(0, "mm"))+ theme(legend.key.size = unit(1.5, "mm"))+ scale_y_continuous(labels = scales::number_format(accuracy = 0.01))


    
g11 <- ggplotGrob(disttocentroidplot_2)
g22 <- ggplotGrob(distbetweencentroids)

grid.arrange(g11, g22 , ncol = 1, heights = c(1, 1))



```




#### DISPERSION BETWEEN E001 and E002 by FIELD####
```{r - dispersion E001 and E002 by field (logdata)}

##START W/ DATA SET subsetted to 2004 to compare E001 and E002 ##

##subset to years before 2005 for BOTH E001 and E002 ## (bc of change in fire regime)

da.wide5$year<-as.numeric(as.character(da.wide5$year)) 

exp12subset<-subset(da.wide5,year<2005)


##just the veg data##

veg_full<-exp12subset%>% dplyr::select(`mass.above.ACER NEGUNDO` :`mass.above.VIOLA SP.`)


###log transformation####

vegmatrixfull<-as.matrix(veg_full)

logvegfull<-log(1+vegmatrixfull)



#### add on a exp field year column###


exp12subset_111 <- exp12subset %>%  mutate(expfieldyear= paste(exp, field, year, sep = '_'))

##using the apply function to calculation the dispersion (beta disp) for each nutrient treatment for each FIELD for each year#

bd_E001E002byfield<-betadisper(vegdist(logvegfull),exp12subset_111$expfieldyear, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a minute ##


##some squared distances are negative and changed to zero##


######making group distances into a dataframe with rownames###


bd_E001E002byfield_2<-as.data.frame(bd_E001E002byfield$group.distances, row.names = rownames(bd_E001E002byfield$group.distances))

setDT(bd_E001E002byfield_2, keep.rownames = TRUE)[]


bd_E001E002byfield_2_df<-separate(data = bd_E001E002byfield_2, col = rn, into = c("exp", "field", "year"))

bd_E001E002byfield_2_df$year<-as.numeric(bd_E001E002byfield_2_df$year)

bd_E001E002byfield_2_df$distances<-as.numeric(bd_E001E002byfield_2_df$`bd_E001E002byfield$group.distances`)

bd_E001E002byfield_2_df<-bd_E001E002byfield_2_df%>% mutate(year2=year-1981)

###this dataframe (bd_E001E002byfield_2_df) has the average distance to the centroid for each field in each year to its E001 or E002 group centroid. Distances = the average Bray dist for ALL 54 plots to their group centroids  ##



##pulling out the group centroids by year####

centroidE001E002df<-as.data.frame(bd_E001E002byfield[["centroids"]])

centroidE001E002df_2<-centroidE001E002df[,1:2]

centroidE001E002df_2 <- tibble::rownames_to_column(centroidE001E002df_2, "expfieldyear")

centroidE001E002df_2<-separate(data = centroidE001E002df_2, col = expfieldyear, into = c("exp", "field", "year"))

centroidE001E002df_2<-centroidE001E002df_2 %>%   mutate(fieldyear= paste(field, year, sep = '_')) %>% select(exp, field, year, fieldyear, PCoA1, PCoA2)
###

###calculate distance between E001 and E002 centroids###

centroidE001<-subset(centroidE001E002df_2, exp==1) #dim = 69 X 6 ##

centroidE002<-subset(centroidE001E002df_2, exp==2) #dim = 58 X 6 ##   ### three missing in E002####

##merge them...dropping the ones in E001 that we don't have E002 for####

mergedcentroids<-merge(centroidE002, centroidE001, by = "fieldyear", all.x = TRUE)

#use pythag theorem to get distance between E001 and E002 centroids###

mergedcentroids_dist<-mergedcentroids %>% mutate(distcentroids=sqrt((PCoA1.y - PCoA1.x)^2+(PCoA2.y-PCoA2.x)^2))


```



#### PLOT DISPERSION BETWEEN E001 and E002 by FIELD####
```{r - plot dispersion E001 and E002 }

mergedcentroids_dist_2 <-mergedcentroids_dist%>% mutate(year2=as.numeric(year.x)-1981)



distE001E002BYFIELD<- ggplot(mergedcentroids_dist_2, aes(x=year2, y=distcentroids)) +
    geom_point()  +
   geom_smooth(method="loess", se=FALSE) +
   facet_wrap(~field.x)+ 
    ylab(expression('Average distance between E001 and E002 group centroid'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())



```



### WANT TO INCLUDE FIELD D FOR THESE METRICS....###


###OLD SINOUSITY METRIC####
```{r - calculate sinuosity of trajectories full N gradient (log data)}

#https://cran.rstudio.com/web/packages/trajr/vignettes/trajr-vignette.html#


head(PCOAandplotsboth_fullN)


##make each experiment, nutrient, plot, its own combo###
PCOAandplotsboth_full2<-PCOAandplotsboth_fullN%>% mutate(expntrtplot= paste(exp, ntrt, plot, sep = '_'))

PCOAandplotsboth_full3<-PCOAandplotsboth_full2 %>%  ungroup() %>% dplyr::select(expntrtplot, Axis.1, Axis.2, year, -exp, -disk)


###calculate sinuoisty for each plot using the traj from coords function##
trajectoriesplot_full<-lapply(X = split.data.frame(x = PCOAandplotsboth_full3, f=PCOAandplotsboth_full3$expntrtplot),function(t){
  PCOAscores<-t %>%   ungroup() %>% dplyr::select(Axis.1, Axis.2, year)
  trajs <- TrajFromCoords(PCOAscores)
  sinuosity<-TrajSinuosity2(trajs)
  return(data.frame(sinuosity))
  }
  )

##dataframe of results##
trajectoriesplotdf_full<-plyr::ldply(trajectoriesplot_full, data.frame)


trajectoriesplotdf_full2<-separate(data = trajectoriesplotdf_full, col = .id, into = c("exp", "ntrt", "plot"))

##mean sinuoisty for each exp_ntrt###

sinuosityavg_full<-trajectoriesplotdf_full2%>% group_by(exp, ntrt) %>% dplyr::summarise(sinuosityavg=mean(sinuosity, na.rm=TRUE),sdsinuosiy=sd(sinuosity, na.rm=TRUE),sesinuosity=sd(sinuosity, na.rm=TRUE)/sqrt(n()), uprconfint=sinuosityavg+(1.96*sesinuosity),lwrconfint=sinuosityavg-(1.96*sesinuosity), n=n())


```


###OLD SINOUSITY METRIC####
```{r - calculate sinuosity field ABCD control plots (log data)}


head(PCOAABCDandplots)


PCOAABCDandplots2<-PCOAABCDandplots %>%  mutate(fieldplot= paste(field, plot, sep = '_'))

###calculate sinuoisty for each plot using the traj from coords function##
trajectoriesABCDcontrol<-lapply(X = split.data.frame(x = PCOAABCDandplots2, f=PCOAABCDandplots2$fieldplot),function(t){
  PCOAscores<-t %>%   ungroup() %>% dplyr::select(Axis.1, Axis.2, year)
  trajs <- TrajFromCoords(PCOAscores)
  sinuosity<-TrajSinuosity2(trajs)
  return(data.frame(sinuosity))
  }
  )

##dataframe of results##
trajectoriesABCD_df<-plyr::ldply(trajectoriesABCDcontrol, data.frame)


trajectoriesplotABCD_df_2<-separate(data = trajectoriesABCD_df, col = .id, into = c("field", "plot"))

##mean sinuoisty for each exp_ntrt###

sinuosityavg_ABCD<-trajectoriesplotABCD_df_2%>% group_by(field) %>% dplyr::summarise(sinuosityavg=mean(sinuosity, na.rm=TRUE),sdsinuosiy=sd(sinuosity, na.rm=TRUE),sesinuosity=sd(sinuosity, na.rm=TRUE)/sqrt(n()), uprconfint=sinuosityavg+(1.96*sesinuosity),lwrconfint=sinuosityavg-(1.96*sesinuosity), n=n())


```



```{r - calculate sinuosity two decades full N gradient }


head(PCOAandplotsboth_fullN)

###split by decade##

PCOAandplotsfirstdecade_full<-subset(PCOAandplotsboth_fullN, as.numeric(as.character(year))<=1992)

PCOAandplotsseconddecade_full<-subset(PCOAandplotsboth_fullN, as.numeric(as.character(year))>1992)


##make each experiment, nutrient, plot, its own combo###
PCOAandplotsfirstdecade2_full<-PCOAandplotsfirstdecade_full%>% mutate(expntrtplot= paste(exp, ntrt, plot, sep = '_'))

PCOAandplotsfirstdecade3_full<-PCOAandplotsfirstdecade2_full %>%  ungroup() %>% select(expntrtplot, Axis.1, Axis.2, year, -exp, -disk)


PCOAandplotsseconddecade2_full<-PCOAandplotsseconddecade_full%>% mutate(expntrtplot= paste(exp, ntrt, plot, sep = '_'))

PCOAandplotsseconddecade3_full<-PCOAandplotsseconddecade2_full %>%  ungroup() %>% select(expntrtplot, Axis.1, Axis.2, year, -exp, -disk)

###calculate sinuoisty for each plot###

###
trajectoriesplotfirst_full<-lapply(X = split.data.frame(x = PCOAandplotsfirstdecade3_full, f=PCOAandplotsfirstdecade3_full$expntrtplot),function(t){
  PCOAscores<-t %>%   ungroup() %>% select(Axis.1, Axis.2, year)
  trajs <- TrajFromCoords(PCOAscores)
  sinuosity<-TrajSinuosity2(trajs)
  return(data.frame(sinuosity))
  }
  )


trajectoriesplotsecond_full<-lapply(X = split.data.frame(x = PCOAandplotsseconddecade3_full, f=PCOAandplotsseconddecade3_full$expntrtplot),function(t){
  PCOAscores<-t %>%   ungroup() %>% select(Axis.1, Axis.2, year)
  trajs <- TrajFromCoords(PCOAscores)
  sinuosity<-TrajSinuosity2(trajs)
  return(data.frame(sinuosity))
  }
  )



##dataframe of results##
trajectoriesplotdffirst_full<-plyr::ldply(trajectoriesplotfirst_full, data.frame)
trajectoriesplotdffirst_2_full<-separate(data = trajectoriesplotdffirst_full, col = .id, into = c("exp", "ntrt", "plot"))

trajectoriesplotdfsecond_full<-plyr::ldply(trajectoriesplotsecond_full, data.frame)

trajectoriesplotdfsecond_2_full<-separate(data = trajectoriesplotdfsecond_full, col = .id, into = c("exp", "ntrt", "plot"))

### add column for decades###

trajectoriesplotdffirst_2_full<-trajectoriesplotdffirst_2_full %>% mutate(decade="1982-1992")

trajectoriesplotdfsecond_2_full<-trajectoriesplotdfsecond_2_full %>% mutate(decade="1993-2004")

##combine them together##
trajectoriesboth_full<-rbind(trajectoriesplotdffirst_2_full, trajectoriesplotdfsecond_2_full)

##mean sinuoisty for each exp_ntrt###

sinuosityavgbydecade_full<-trajectoriesboth_full%>% group_by(exp, ntrt, decade) %>% dplyr::summarise(sinuosityavg=mean(sinuosity, na.rm=TRUE),sdsinuosiy=sd(sinuosity, na.rm=TRUE),sesinuosity=sd(sinuosity, na.rm=TRUE)/sqrt(n()), n=n())

```


```{r - recreate FIGURE 4ab Sinuosity full N gradient}

##for plotting###
sinuosityavg2<-sinuosityavg_full %>% mutate(ntrt2=ntrt)


sinuosityavg2$ntrt2  <- mapvalues(sinuosityavg2$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

sinuosityavg2$ntrt2 <- factor(sinuosityavg2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))


sinuosityavg2$exp<-mapvalues(sinuosityavg2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

sinuosityavg2$exp<- factor(sinuosityavg2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



sinuosityavg2<-sinuosityavg2 %>% mutate(abclabel=exp)
levels(sinuosityavg2$abclabel) <- c( "(a) ", "(b) ")


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


sinuosityplot_fullN<- ggplot(data=sinuosityavg2, aes(x=ntrt2, y=sinuosityavg, group=ntrt2, color=ntrt2)) +
    geom_point(size=2) +
    geom_errorbar(aes(ymin=lwrconfint, ymax=uprconfint), size=1)+
    facet_grid(~exp)+ 
    xlab("")+
    ylab(expression(atop("Average sinuosity", paste("(1982 - 2004)"))))+
    mytheme+
    theme(legend.position="none")+
    theme(legend.title = element_blank()) + 
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
   #scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
   theme(axis.text.x = element_text(angle = 25,vjust = 0.5))+
    theme(strip.text = element_text(face="bold"))+
     theme(strip.background = element_blank())+
   theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
      geom_text(aes(x = 0.8, y = 8.2, label = abclabel, group =     abclabel),size = 4, color= "black", check_overlap = T)+ scale_y_continuous(labels = scales::number_format(accuracy = 0.1))+ylim(3.8, 8.3)




sinuosityplot_ABCD<- ggplot(data=sinuosityavg_ABCD, aes(x=field, y=sinuosityavg, group=field)) +
    geom_point(size=2) +
    geom_errorbar(aes(ymin=lwrconfint, ymax=uprconfint), size=1)+
    xlab("")+
    ylab(expression(atop("Average sinuosity", paste("(1982 - 2004)"))))+
    mytheme+
    theme(legend.position="none")+
    theme(legend.title = element_blank()) + 
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
   #scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
   theme(axis.text.x = element_text(angle = 25,vjust = 0.5))+
    theme(strip.text = element_text(face="bold"))+
     theme(strip.background = element_blank())+
   theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
      scale_y_continuous(labels = scales::number_format(accuracy = 0.1))+ylim(3.8, 10)





```


```{r - recreate SUP FIG 4 Sinuosity 2 decades full N gradient}



##for plotting###
sinuosityavgbydecade2<-sinuosityavgbydecade_full %>% mutate(ntrt2=ntrt)

## plot specifications

sinuosityavgbydecade2$ntrt2  <- mapvalues(sinuosityavgbydecade2$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

sinuosityavgbydecade2$ntrt2 <- factor(sinuosityavgbydecade2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))


sinuosityavgbydecade2$exp<-mapvalues(sinuosityavgbydecade2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

sinuosityavgbydecade2$exp<- factor(sinuosityavgbydecade2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


sinuosityplotbydecade_fullN<- ggplot(data=sinuosityavgbydecade2, aes(x=ntrt2, y=sinuosityavg, group=ntrt2, color=ntrt2)) +
    geom_point(size=2) +
    geom_errorbar(aes(ymin=sinuosityavg-sesinuosity, ymax=sinuosityavg+sesinuosity), size=1)+
    facet_grid(decade~exp)+ 
    xlab("")+
   ylab(expression('Average sinuosity'))+
    mytheme+
    theme(legend.position="none")+
    theme(legend.title = element_blank()) + 
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
   #scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
   theme(axis.text.x = element_text(angle = 25,vjust = 0.5))+
    theme(strip.text = element_text(face="bold"))+
     theme(strip.background = element_blank())+
   theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())

jpeg("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/logfigures/sinuosity2decades.jpeg", width = 6, height = 6, units = 'in', res = 600)
sinuosityplotbydecade
dev.off()

pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/logfigures/sinuosity2decades.pdf", width = 6, height = 6)
sinuosityplotbydecade
dev.off()




```


```{r - recreate FIG 4 abcd}

g222 <- ggplotGrob(PcOAdecade)
g111 <- ggplotGrob(sinuosityplot)

grid.arrange(g111, g222 , ncol = 1, heights = c(1, 1))



```


###CODE CHECKING GOT UP TO HERE on 11/3#######



###SINOUSITY USING TRAJECTORY DIRECTIONALITY ####
```{r - calculate traj directionality (log data)}

##START W/ the DISTANCE MATRIX instead of PCOA points ### 

head(BCdistalldf2)


##make each field, experiment, plot, its own combo###
plotE001E002<-BCdistalldf2 %>% select(field, exp, plot, subplot, year, disk, ntrt, expntrtyear)%>% mutate(fieldexpplot= paste(field, exp,plot, sep = '_'))

##
plotE001E002_2<-distinct(plotE001E002, fieldexpplot, .keep_all=TRUE)


trajdirection<-trajectoryDirectionality(BCdistall, plotE001E002$fieldexpplot, plotE001E002$year)


trajdirectdf<-cbind(plotE001E002_2, trajdirection)


##mean directionality for each exp_ntrt ###

trajdiravg<-trajdirectdf%>% group_by(exp, ntrt) %>% dplyr::summarise(trajdiravg=mean(trajdirection, na.rm=TRUE),sdtrajdir=sd(trajdirection, na.rm=TRUE),setrajdir=sd(trajdirection, na.rm=TRUE)/sqrt(n()), uprconfint=trajdiravg+(1.96*setrajdir),lwrconfint=trajdiravg-(1.96*setrajdir), n=n())


##### NOW do for fields ABCD controls###

head(BCdistABCDdf2)

##make each field,  plot, its own combo###
plotABCD<-BCdistABCDdf2 %>% select(field, exp, plot, year)%>% mutate(fieldplot= paste(field, plot, sep = '_'))

plotABCD_2<-distinct(plotABCD, fieldplot, .keep_all=TRUE)


trajdirectionABCD<-trajectoryDirectionality(BCdistABCD, plotABCD$fieldplot, plotABCD$year)


trajdirectABCDdf<-cbind(plotABCD_2, trajdirectionABCD)

### mean directionality of fields...##


trajdirABCDavg<-trajdirectABCDdf%>% group_by(field) %>% dplyr::summarise(trajdiravg=mean(trajdirectionABCD, na.rm=TRUE),sdtrajdir=sd(trajdirectionABCD, na.rm=TRUE),setrajdir=sd(trajdirectionABCD, na.rm=TRUE)/sqrt(n()), uprconfint=trajdiravg+(1.96*setrajdir),lwrconfint=trajdiravg-(1.96*setrajdir), n=n())



```



```{r - recreate FIGURE 4ab Directionality}

##for plotting###
trajdiravg2<-trajdiravg %>% mutate(ntrt2=ntrt)


trajdiravg2$ntrt2  <- mapvalues(trajdiravg2$ntrt2, from=c("0", "9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("Never", "None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

trajdiravg2$ntrt2 <- factor(trajdiravg2$ntrt2, levels = c("Never", "None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))


trajdiravg2$exp<-mapvalues(trajdiravg2$exp, from=c("0", "1", "2"), to=c("Remnant", "Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

trajdiravg2$exp<- factor(trajdiravg2$exp, levels = c("Remnant", "Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


directionalityplot<- ggplot(data=trajdiravg2, aes(x=ntrt2, y=trajdiravg, group=ntrt2, color=ntrt2)) +
    geom_point(size=2) +
    geom_errorbar(aes(ymin=lwrconfint, ymax=uprconfint), size=1)+
    facet_grid(~exp, scales = "free_x")+ 
    xlab("")+
    ylab(expression(atop("Average directionality", paste("(1982 - 2004)"))))+
    mytheme+
    theme(legend.position="none")+
    theme(legend.title = element_blank()) + 
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
     theme(axis.text.x = element_text(angle = 25,vjust = 0.5))+
    theme(strip.text = element_text(face="bold"))+
     theme(strip.background = element_blank())+
   theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())


##directionality of control plots###

head(trajdirABCDavg)


directionalityplotABCD<- ggplot(data=trajdirABCDavg, aes(x=field, y=trajdiravg, group=field)) +
    geom_point(size=2) +
    geom_errorbar(aes(ymin=lwrconfint, ymax=uprconfint), size=1)+
    xlab("")+
    ylab(expression(atop("Average directionality", paste("(1982 - 2004)"))))+
    mytheme+
    theme(legend.position="none")+
    theme(legend.title = element_blank()) + 
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
     theme(axis.text.x = element_text(angle = 25,vjust = 0.5))+
    theme(strip.text = element_text(face="bold"))+
     theme(strip.background = element_blank())+
   theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())


```



##TRAJECTORY DISTANCE####

##
```{r - calculate trajectory distance between years full N gradient (log data)}

##https://cran.r-project.org/web/packages/ecotraj/vignettes/IntroductionETA.html##

##get the PCoA points into a Euclidean distance matrix to calc. distance between points ###

PCOAandplotsboth_2_fullN <- PCOAandplotsboth_fullN %>% arrange(exp, field, ntrt,plot, year)%>%mutate(exp_field_ntrt_plot= paste(exp, field, ntrt,plot, sep = '_'), exp_field_ntrt_plot2 = as.numeric(as.factor(exp_field_ntrt_plot))) %>% dplyr::select(field, exp, plot, subplot, year, disk, ntrt,  expntrtyear, expntrtfieldyear, exp_field_ntrt_plot, exp_field_ntrt_plot2, Axis.1, Axis.2)

###split it by E001 and E002 since there are missing years in E002##
PCOAandplotsE001_fullN<-subset(PCOAandplotsboth_2_fullN, exp==1) 
PCOAandplotsE002_fullN<-subset(PCOAandplotsboth_2_fullN, exp==2) 

#drop the years for E002##
levels(PCOAandplotsE002_fullN$year)
PCOAandplotsE002_fullN$year <- as.factor(as.character(PCOAandplotsE002_fullN$year))


EucE001 = dist(PCOAandplotsE001_fullN[,12:13])
EucE002 = dist(PCOAandplotsE002_fullN[,12:13])


####
trajlengthE001_fullN<-trajectoryLengths(EucE001, PCOAandplotsE001_fullN$exp_field_ntrt_plot, PCOAandplotsE001_fullN$year)

trajlengthE002_fullN<-trajectoryLengths(EucE002, PCOAandplotsE002_fullN$exp_field_ntrt_plot, PCOAandplotsE002_fullN$year)


####
yearnamesE001<-levels(PCOAandplotsE001_fullN$year)
trajlengthE001_df_fullN=as.data.frame(trajlengthE001_fullN)

colnames(trajlengthE001_df_fullN)<-yearnamesE001
names(trajlengthE001_df_fullN)[names(trajlengthE001_df_fullN) == '2004'] <- 'Total'

trajlengthE001_df_fullN$names <- rownames(trajlengthE001_df_fullN)

trajlengthE001_df2_fullN<-trajlengthE001_df_fullN %>%separate(names, c("exp", "field", "ntrt", "plot"), "_")

trajlengthE001_df3_fullN<-trajlengthE001_df2_fullN%>%dplyr::select(exp, field, ntrt, plot, '1982':'Total')

####
yearnamesE002<-levels(PCOAandplotsE002_fullN$year)
trajlengthE002_df_fullN=as.data.frame(trajlengthE002_fullN)
colnames(trajlengthE002_df_fullN)<-yearnamesE002
names(trajlengthE002_df_fullN)[names(trajlengthE002_df_fullN) == '2004'] <- 'Total'

trajlengthE002_df_fullN$names <- rownames(trajlengthE002_df_fullN)

trajlengthE002_df2_fullN<-trajlengthE002_df_fullN %>%separate(names, c("exp", "field", "ntrt", "plot"), "_")%>%dplyr::select(exp, field, ntrt, plot, '1982':'Total')

###for this df, we need to drop the columns where we don't have back to back years###
##drop: 1994 (col 17(missing 1995), drop 2000 (missing 2001) (col 21), drop 2002 (missing 2003)(col 22), drop 2003 (missing most of 2004)(col 23)###

trajlengthE002_df3_fullN <- subset(trajlengthE002_df2_fullN, select = -c(17,21:23))

##convert wide to long##

traj_longE001_fullN<- gather(trajlengthE001_df3_fullN, startingyear, trajdist, '1982':'2003', factor_key=TRUE)

traj_longE002_fullN <- gather(trajlengthE002_df3_fullN, startingyear, trajdist, '1982':'1999', factor_key=TRUE)

##combine the two dataframes back together##

traj_longboth_fullN<-rbind(traj_longE001_fullN, traj_longE002_fullN)

##this data frame (traj_long_both) contain the trajectory distance in Euclidean space for each plot between years. traj dist = the dist between starting year and the next year###



##summarize the average distance between years by treatment group##

avgTraj_byyear_E001E002_fullN<-traj_longboth_fullN%>% group_by(exp,ntrt,startingyear) %>% dplyr::summarise(meantrajdist=mean(trajdist, na.rm=TRUE),sdtrajdist=sd(trajdist, na.rm=TRUE),setrajdist=sd(trajdist, na.rm=TRUE)/sqrt(n()), n=n())

avgTraj_byyear_E001E002_2_fullN<- avgTraj_byyear_E001E002_fullN %>% mutate (year2=as.numeric(as.character(startingyear))+0.5-1981)



```

###review this###
```{r - AIC trajectory analysis, TABLE S5 and S6}


###AIC test whether a linear or nonlinear fit is better##
###linear fit###

trajdistlin<-lm(meantrajdist~year2, data=avgTraj_byyear_E001E002_2)


##nonlinear##

#trajdistnonlin2 <- nls(meantrajdist ~ SSasymp(year2, Asym, R0, lrc), data=avgTraj_byyear_E001E002_2) ##not converging###

trajdistnonlin2_2<- nls(meantrajdist ~ SSmicmen(year2, a, b), data=avgTraj_byyear_E001E002_2)


##simple exponential decay model####

trajdistnonlin3 <- nls(meantrajdist ~ 1 / (1 + year2^c),start = list(c = 1), data=avgTraj_byyear_E001E002_2)


##null##

trajdistnull<-lm(meantrajdist~1, data=avgTraj_byyear_E001E002_2)


rawaic<-AIC(trajdistnonlin3,trajdistnonlin2_2, trajdistlin, trajdistnull)
nR<-dim(avgTraj_byyear_E001E002_2)[1]  #Sample size 
aictable(rawaic,nR)

##linear model with a slope performs better than null and better than nonlinear model###

####linear model equations#####

##subset by experiment##
avgTraj_byyear_E001<-subset(avgTraj_byyear_E001E002_2, exp="Intact in 1982 (E001)")
avgTraj_byyear_E002<-subset(avgTraj_byyear_E001E002_2, exp="Disturbed in 1982 (E002)")


modelsE001 <- dlply(avgTraj_byyear_E001, "ntrt", function(avgTraj_byyear_E001) 
  lm(meantrajdist ~ year2, data = avgTraj_byyear_E001))

# Print the summary of each model
l_ply(modelsE001, summary, .print = TRUE)


modelsE002 <- dlply(avgTraj_byyear_E002, "ntrt", function(avgTraj_byyear_E002) 
  lm(meantrajdist ~ year2, data = avgTraj_byyear_E002))

# Print the summary of each model
l_ply(modelsE002, summary, .print = TRUE)



```


```{r - recreate FIGURE 5ab Trajectory distance w linear fit}

avgTraj_byyear_E001E002<-avgTraj_byyear_E001E002_2_fullN

# plot specifications

avgTraj_byyear_E001E002$exp<-mapvalues(avgTraj_byyear_E001E002$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

avgTraj_byyear_E001E002$exp<- factor(avgTraj_byyear_E001E002$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


avgTraj_byyear_E001E002_2<- avgTraj_byyear_E001E002 %>% mutate (year2=as.numeric(as.character(startingyear))+0.5-1981)

avgTraj_byyear_E001E002_2<-avgTraj_byyear_E001E002_2 %>% mutate(ntrt2=ntrt)


avgTraj_byyear_E001E002_2$ntrt2  <- mapvalues(avgTraj_byyear_E001E002_2$ntrt2, from=c("0", "9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("Never", "None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))

avgTraj_byyear_E001E002_2$ntrt2 <- factor(avgTraj_byyear_E001E002_2$ntrt2, levels = c("Never", "None", "0 N+micro", "1 N + micro", "2 N + micro", "3.4 N + micro","5.4 N + micro","9 N + micro", "17 N + micro", "27.2 N + micro"))



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))



###seperate the control from the others...###

avgTraj_byyear_E001E002_2<-avgTraj_byyear_E001E002_2 %>% mutate(abclabel=exp)
levels(avgTraj_byyear_E001E002_2$abclabel) <- c( "(a) ", "(b) ")

avgTrajcontrol<-subset(avgTraj_byyear_E001E002_2, ntrt2=="None")


avgTraj_byyearlinear_fullN<- ggplot(data=avgTraj_byyear_E001E002_2) +
    geom_point(data=avgTraj_byyear_E001E002_2, aes(x=as.numeric(as.character(year2)), y=meantrajdist, group=ntrt2, color=ntrt2)) +
    geom_smooth(data=avgTraj_byyear_E001E002_2, aes(x=as.numeric(as.character(year2)), y=meantrajdist, group=ntrt2, color=ntrt2), method = "lm", formula = y ~ x , size = 1, se=FALSE)+
    geom_point(data=avgTrajcontrol, aes(x=as.numeric(as.character(year2)), y=meantrajdist),     color="gray45") +
geom_smooth(data = avgTrajcontrol, aes(x=as.numeric(as.character(year2)), y=meantrajdist), method = "lm", formula = y ~ x, colour = "gray45", size = 0.25)+
    facet_grid(~exp)+ 
    ylab(expression('Annual community trajectory distance'))+
    xlab("Time since experiment (years)")+
    mytheme+
    theme(legend.title = element_blank()) + 
    #scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())
 #geom_text(aes(x = 2.0, y = 0.25, label = abclabel, group =     abclabel),size = 4, color= "black", check_overlap = T)


##add text and legend##

avgTraj_byyear_2_linear<-avgTraj_byyearlinear+ theme(legend.position = c(0.85, 0.85))+theme(legend.text = element_text(size = 8))+ guides(color = guide_legend(override.aes = list(size = 0.5)))+theme(legend.margin = margin(0, 0, 0, 0))+theme(legend.spacing.y = unit(0, "mm"))+ theme(legend.key.size = unit(1.5, "mm"))



```





## ADDITIONAL SUPPLEMENTAL FIGURES AND ANALYES ###

```{r - Indicator species analyses - 2 time periods log data }

##start w/ exp12subset_2#

##just the plot data##
plot<-exp12subset_1_sorted%>% dplyr::select('field':'ntrt2')

##just the veg data##

veg<-exp12subset_1_sorted%>% dplyr::select(`mass.above.ACHILLEA MILLEFOLIUM(LANULOSA)`:`mass.above.VIOLA SP.`)

###log transformation####

vegmatrix<-as.matrix(veg)

logveg<-log(1+vegmatrix)

##merge back together###

exp12subset_3<-data.frame(plot, logveg)


head(exp12subset_3) ##log transformed values###


###subset to the controls and high N treatments###

exp12subset_4<-subset(exp12subset_3,ntrt==9|ntrt==6)


# Look at first 3 years of experiment and last 3 years of experiment
vegearly <- subset(exp12subset_4, year=="1982"|year=="1983"|year=="1984")
veglate <- subset(exp12subset_4, year=="2000"|year=="2002"|year=="2004")

##skip years 2001, 2003 bc of imcomplete data##


#Put data in long format
vegearlylong <-reshape(vegearly,
                  v.names="mass",
                 timevar="species",
                  idvar=c("field", "exp", "plot", "year", "ntrt", "nadd", "disk"),  
                  times=grep("mass.above", names(vegearly), value=TRUE),
                 varying=list(grep("mass.above", names(vegearly), value=TRUE)),
                  direction="long")

vegearlylong_2<-vegearlylong %>% mutate(stage="early") %>% mutate(stage2=1)


veglatelong <-reshape(veglate,
                  v.names="mass",
                 timevar="species",
                  idvar=c("field", "exp", "plot", "year", "ntrt", "nadd", "disk"),  
                  times=grep("mass.above", names(veglate), value=TRUE),
                 varying=list(grep("mass.above", names(veglate), value=TRUE)),
                  direction="long")

veglatelong_2<-veglatelong %>% mutate(stage="late")%>% mutate(stage2=3)

#####merge the early and late##

veglong2<-rbind(vegearlylong_2, veglatelong_2)


# Delete prefix from species names
veglong2$species <- with(veglong2, gsub("mass.above.","", species))

rownames(veglong2)<-NULL ##get rid of rownames##

##indicator species analysis##

    ##convert data back to wide form##

vegwide2 <- spread(veglong2, species, mass)

vegwideplotdata2<-vegwide2[,1:13]
vegwidematrix2<-vegwide2[,14:224]


###make a column for dist_nitrogen_earylate##

vegwideplotdata22<-vegwideplotdata2 %>% mutate(stagentrtdist= paste(stage, ntrt, exp, sep = '_'))

vegwideplotdata22$stagentrtdist<-as.factor(vegwideplotdata22$stagentrtdist)

vegwideplotdata22$stagentrtdist <- factor(vegwideplotdata22$stagentrtdist, levels = c("early_9_1", "early_6_1", "early_9_2", "early_6_2", "late_9_1", "late_6_1", "late_9_2", "late_6_2"))

vegwideplotdata33<-vegwideplotdata22 %>% mutate(stagentrtdist2= as.numeric(stagentrtdist))

vegwideplotdata33$stagentrtdist2<-as.factor(vegwideplotdata33$stagentrtdist2)

vegwideplotdata33$stagentrtdist2 <- factor(vegwideplotdata33$stagentrtdist2, levels = c("1", "2", "3", "4", "5", "6", "7", "8"))

##early  late ##

##indicator spp analyses###

indvalearlylate = multipatt(vegwidematrix2,vegwideplotdata33$stagentrtdist2,max.order = 3, control = how(nperm=99))## just looks at the individual groups, and twos  ##


indval<-data.frame(indvalearlylate[["sign"]]) ##RESULTS###

```


```{r - SUPPLEMENTAL SPP RICHNESS raw data}


##starting with exp12subset_1###raw biomass data###


###summarize##

###Diversity metrics for plant data###
ShannonD_a <- diversity(exp12subset_1[,11:222], index = "shannon") ##shannon-weiner index##
Richness_a <- specnumber(exp12subset_1[,11:222])
Evenness_a <- ShannonD_a/log(Richness_a)

###combine##
plotdatarichness<-cbind(exp12subset_1[,1:10], Richness_a)

plotdatarichnes2<- plotdatarichness%>%   mutate(ntrt2=ntrt,expntrtyear= paste(exp, ntrt,year, sep = '_'))

##make year numeric##

plotdatarichnes2$year<-as.numeric(as.character(plotdatarichnes2$year))

##average across treatments##

richnessaverage<-plotdatarichnes2%>% group_by(exp, ntrt, ntrt2, year, expntrtyear) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())


##richness at beginning###

richnessbeginning<-subset(plotdatarichnes2, year < 1985)

richnessbegsummary<-richnessbeginning%>% group_by(exp) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())



richnessfirstyear<-subset(plotdatarichnes2, year == 1982)

richnessbegsummary<-richnessbeginning%>% group_by(exp) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())




##richness at end of experiment###
richnessend<-subset(plotdatarichnes2, year > 2000)

richnessendsummary<-richnessend%>% group_by(ntrt2) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())



##plotting specifications###

richnessaverage$exp<-mapvalues(richnessaverage$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

richnessaverage$exp<- factor(richnessaverage$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


richnessaverage_2<- richnessaverage%>% mutate (year2=as.numeric(as.character(year-1981)))


richnessaverage_3<-richnessaverage_2 %>% mutate(ntrt2=ntrt)

richnessaverage_3$ntrt2  <- mapvalues(richnessaverage_3$ntrt2, from=c("9", "1", "2", "4","6"), to=c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))

richnessaverage_3$ntrt2 <- factor(richnessaverage_3$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))

mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))




spprichnesstime<-richnessaverage_3 %>% ggplot(aes(x=year2, y=meanrichness, group=ntrt2, color=ntrt2, fill=ntrt2))+
    geom_point()+
    geom_smooth(method="loess")+
    facet_grid(ntrt2~exp) + 
    mytheme+
    ylab("Plot species richness")+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.title = element_blank()) + 
  theme(legend.position = "none") +
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
   scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
   scale_fill_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
     theme(strip.background = element_blank())





```


```{r - SUPPLEMENTAL Biomass over time raw data}

##start with exp12subset_1###

##wide to long form##
exp12subset_long <- gather(exp12subset_1, species, biomass, 'mass.above.ACHILLEA MILLEFOLIUM(LANULOSA)':'mass.above.VIOLA SP.', factor_key=TRUE)

##remove extra text##

exp12subset_long $species<-str_remove(exp12subset_long$species, "mass.above.")


##make a column for exp_ntrt_year##

exp12subset_long_2<-exp12subset_long  %>% mutate( expntrtyear_2= paste(exp,ntrt, year, sep = '_'))

exp12subset_long_3<-exp12subset_long_2 %>% mutate(expntrt= paste(exp,ntrt, sep = '_')) %>% dplyr::select(field, plot, disk,year, ntrt, nadd, expntrtyear_2, expntrt, species, biomass)

##sum all species abundance across plots with the same treatment group and year ###includes zeroes!!!#####

sum_allsp_exp12ABC<-exp12subset_long_3%>% group_by(species, disk,year, ntrt, nadd, expntrtyear_2, expntrt,) %>% dplyr::summarise(sumbiomass=sum(biomass, na.rm=TRUE),n=n())


###get rid of years where we don't have all 18 plots###

sum_allsp_exp12ABC_2<-subset(sum_allsp_exp12ABC, n==18)

sum_allsp_df<-as.data.frame(sum_allsp_exp12ABC_2)


##this dataframe (sumallsp_df has the abundance of each plant in each treatment group (n = 18) for each year####

##calculating the total biomass##

totalbiomassplot<-exp12subset_long_3%>% group_by(plot,field, disk,year, ntrt, nadd, expntrtyear_2, expntrt,) %>% dplyr::summarise(totalbiomass=sum(biomass, na.rm=TRUE),sebiomass=sd(biomass, na.rm=TRUE)/sqrt(n()),n=n())

##average across plots##

totalbiomassgroups<-totalbiomassplot%>% group_by(disk,year, ntrt, nadd, expntrtyear_2, expntrt,) %>% dplyr::summarise(totalplotbiomass=mean(totalbiomass, na.rm=TRUE),seplotbiomass=sd(totalbiomass, na.rm=TRUE)/sqrt(n()), n=n())

totalbiomassgroups2<-subset(totalbiomassgroups, n==18)

totalbiomassdf<-as.data.frame(totalbiomassgroups2)

totalbiomassdf2<-totalbiomassdf%>%mutate(upper=totalplotbiomass+(2*seplotbiomass), lower=totalplotbiomass-(2*seplotbiomass))%>% dplyr::select(expntrtyear_2,year, disk, ntrt, totalplotbiomass, seplotbiomass,upper, lower)

####summary across treatments all years###

biomasssummary<-totalbiomassdf%>% group_by(disk) %>% dplyr::summarise(meanbiomass=mean(totalplotbiomass, na.rm=TRUE),sebiomass=sd(totalplotbiomass, na.rm=TRUE)/sqrt(n()),n=n())


##plot specifications ##


totalbiomassdf2$disk<-mapvalues(totalbiomassdf2$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

totalbiomassdf2$disk<- factor(totalbiomassdf2$disk, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


##
totalbiomassdf22<-totalbiomassdf2 %>% mutate(ntrt2=ntrt)

totalbiomassdf22$ntrt2  <- mapvalues(totalbiomassdf22$ntrt2, from=c("9", "1", "2", "4","6"), to=c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))

totalbiomassdf22$ntrt2 <- factor(totalbiomassdf22$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))


totalbiomassdf3<- totalbiomassdf22 %>% mutate(year2=as.numeric(as.character(year))-1981)

##this dataframe (totalbiomass df3, has the total biomass of all 18 plots per treatment group for all  years###)


###plotting###

mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))

totalbiomass<-totalbiomassdf3 %>% ggplot(aes(x=year2, y=totalplotbiomass, color=ntrt2))+
    geom_line() + 
    geom_ribbon(aes(ymin=lower, ymax=upper, fill=ntrt2), alpha=0.5, colour = NA) + 
    facet_grid(ntrt2~disk) + 
    mytheme+
    ylab(expression(paste("Total aboveground biomass g / m  "^2)))+
    xlab("Time since experiment")+
    theme(legend.title = element_blank())+
    theme(legend.key.size = unit(0.5, "cm"))+theme(strip.background = element_blank())+theme(strip.text.x = element_text(size = 14, colour = "black"))+
   scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
   scale_fill_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+ theme(legend.position = "none") 
    
```


```{r - SUPPLEMENTAL Functional groups over time raw data}

##start with the sum_all_sp_df and totabiomassdf2 dataframes ####

## and the original Da (all plot and spp info from CC)

##merge the spp with total plot biomass##

sum_allsp_df_2 <- (merge(sum_allsp_df,totalbiomassdf2, by = 'expntrtyear_2', sort=FALSE, all.x=TRUE))

sum_allsp_df_3<-sum_allsp_df_2 %>% mutate(propbiomass=sumbiomass/totalplotbiomass)

### this data set (sum_allsp_df_3 has the sum of all spp in each year in each dist/ntrt treatmet and the proportion of biomass of that group##

###merge the species info with functional group and other information##

specieslookup<-da %>% distinct(species, .keep_all = TRUE)

specieslookup2<-specieslookup %>% dplyr::select(species,functional.group,duration,lifeform, pathway, origin)


mergedfuncgroup <- (merge(specieslookup2,sum_allsp_df_3, by = 'species', sort=FALSE, all.y=TRUE))

mergedfuncgroup_2<-mergedfuncgroup%>% mutate(functional.group2= paste(functional.group, origin, sep = '_'))

####now sum up by functional group + origin ##

sumfunctionalgroup<-mergedfuncgroup_2%>% group_by(disk,year, ntrt, nadd, expntrtyear_2, expntrt,functional.group, totalplotbiomass) %>% dplyr::summarise(sumbiomass=sum(sumbiomass, na.rm=TRUE)) %>% mutate(propbiomass=sumbiomass/totalplotbiomass)

sumfuntionalgroupdf<-as.data.frame(sumfunctionalgroup)

###reordering so that other is last, first grasses, then forbs##

sumfuntionalgroupdf$functional.group<-factor(sumfuntionalgroupdf$functional.group, levels=c("C3", "C4" , "S", "W", "L", "F"))

sumfuntionalgroupdf2<-sumfuntionalgroupdf[complete.cases(sumfuntionalgroupdf), ]

#drop the levels not sampeled
sumfuntionalgroupdf2$functional.group <- as.factor(as.character(sumfuntionalgroupdf2$functional.group))


##plot specifications####

sumfuntionalgroupdf2$disk<-mapvalues(sumfuntionalgroupdf2$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

sumfuntionalgroupdf2$disk<- factor(sumfuntionalgroupdf2$disk, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


sumfuntionalgroupdf2<-sumfuntionalgroupdf2 %>% mutate(ntrt2=ntrt)

sumfuntionalgroupdf2$ntrt2  <- mapvalues(sumfuntionalgroupdf2$ntrt2, from=c("9", "1", "2", "4","6"), to=c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))

sumfuntionalgroupdf2$ntrt2 <- factor(sumfuntionalgroupdf2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))


sumfuntionalgroupdf2$year<-as.numeric(as.character(sumfuntionalgroupdf2$year))


sumfuntionalgroupdf3<- sumfuntionalgroupdf2 %>% mutate(year2=year-1981)




mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))





propfunctionalgrouptime<-sumfuntionalgroupdf3 %>% ggplot(aes(x=year2, y=propbiomass, group=functional.group))+
    geom_area(position = 'stack', aes(fill=functional.group)) + 
    facet_grid(ntrt2~disk) + 
    mytheme+
    ylab("Proportion of Biomass")+
    xlab("Time since experiment")+
    theme(legend.title = element_blank())+
    theme(legend.key.size = unit(0.5, "cm"))+scale_fill_viridis_d(option="C", na.value="grey72")+
    theme(strip.background = element_blank())+theme(strip.text.x = element_text(size = 14, colour = "black"))+
    scale_y_continuous(breaks=c(0.25,0.50,0.75, 1.00))
    

```




##additional plots not included in paper###


```{r - pCOA species last few years}


##start with log transformed data###

exp12subset_2004<-subset(exp12subset_2, year==2004)


##just the veg data##

veg2004<-exp12subset_2004%>% dplyr::select(`mass.above.ACHILLEA MILLEFOLIUM(LANULOSA)`:`mass.above.VIOLA SP.`)

#remove columns with all 0s##

veg2004_2 = veg2004[,colSums(veg2004) > 0]

##just the plot data##
plot2004<-exp12subset_2004%>% dplyr::select('field':'ntrt2')%>% mutate(expntrt= paste(exp,ntrt,sep = '_')) 

## Bray curtis dissimiliarty matrix##
dist2004<-vegdist(veg2004_2, method="bray")

##PCOA####
PCOA2004<-pcoa(dist2004)

##plot the ord##

#pcoa1<-plot(PCOA2004)


## extracting the axis scores##

PCOA2004 <- PCOA2004$vectors[,c(1,2)]


##merge the axis scores with the plot data ###

PCOAandplots2004<-cbind(plot2004,PCOA2004)


###pulling out the group centroids ####


bd_2004<-betadisper(vegdist(veg2004_2),plot2004$expntrt, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a bit##


centroiddf2004<-as.data.frame(bd_2004[["centroids"]])

centroiddf2004_2<-centroiddf2004[,1:2]

centroiddf2004_2<- tibble::rownames_to_column(centroiddf2004_2, "expntrt")

centroiddf2004_2<-separate(data = centroiddf2004_2, col = expntrt, into = c("exp", "ntrt"))




##plotting specifications#####


PCOAandplots2004<-PCOAandplots2004%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

PCOAandplots2004$ntrt2  <- mapvalues(PCOAandplots2004$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))
PCOAandplots2004$ntrt2 <- factor(PCOAandplots2004$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))


PCOAandplots2004$exp2<-mapvalues(PCOAandplots2004$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

PCOAandplots2004$exp2 <- factor(PCOAandplots2004$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

####
centroiddf2004_2<-centroiddf2004_2%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

centroiddf2004_2$ntrt2  <- mapvalues(centroiddf2004_2$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))
centroiddf2004_2$ntrt2 <- factor(centroiddf2004_2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))


centroiddf2004_2$exp2<-mapvalues(centroiddf2004_2$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddf2004_2$exp2 <- factor(centroiddf2004_2$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))




####

PCOA2004plot <- ggplot() + 
    xlab("PCOA 1") +
    ylab("PCOA 2") +  
    geom_point(data=PCOAandplots2004, 
               aes(x=Axis.1, y=Axis.2, colour=ntrt2, shape=exp2), 
               size=1)+
        geom_point(data=centroiddf2004_2, 
               aes(x=PCoA1, y=PCoA2, colour=ntrt2, shape=exp2), 
               size=4)+
  scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
  scale_fill_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+ 
   mytheme+
    theme(strip.text.x = element_text(size = 14, colour = "black"))+
    theme(strip.text.y = element_text(size = 14, colour = "black"))+
    theme(legend.position = c(0.89, 0.35),
          legend.spacing.x = unit(0.03, 'cm'))+
    theme(legend.text = element_text(size=6))+
    theme(legend.key.size = unit(0.4, 'cm'))


```


```{r - NMDS species last few years}


##start with log transformed data###

exp12subset_2004<-subset(exp12subset_2, year==2004)



##just the veg data##

veg2004<-exp12subset_2004%>% dplyr::select(`mass.above.ACHILLEA MILLEFOLIUM(LANULOSA)`:`mass.above.VIOLA SP.`)

#remove columns with all 0s##

veg2004_2 = veg2004[,colSums(veg2004) > 0]

##just the plot data##
plot2004<-exp12subset_2004%>% dplyr::select('field':'ntrt2')%>% mutate(expntrt= paste(exp,ntrt,sep = '_')) 

## Bray curtis dissimiliarty matrix##
dist2004<-vegdist(veg2004_2, method="bray")



###NMDS###

NMDS1<-metaMDS(dist2004, k = 3, trymax = 10000)

##extract the spp scores##

en = envfit(NMDS1, veg2004_2, permutations = 999, na.rm = TRUE)

endf <- data.frame((en$vectors)$arrows, (en$vectors)$r, (en$vectors)$pvals)

endf <- tibble::rownames_to_column(endf , "species")

colnames(endf ) <- c("species", "NMDS1", "NMDS2", "r2", "pval")

endf$species<-str_remove(endf$species, "mass.above.")


##select out certain spp only####

endfmain<-endf %>% filter(r2 > 0.3)

species2<-c("Agro.rep", "Ambro.cor", "Carex", "Euph.cor", "Lath.ven", "Poa.pra", "Schiz.scop", "Sorg.nut")

enddfmain2<-as.data.frame(cbind(endfmain, species2))

## extracting the axis scores##

NMDSscores<-NMDS1$points

##merge the axis scores with the plot data ###

NMDSandplots2004<-cbind(plot2004,NMDSscores)


###AVERAGE BY EXP_NTRT####

NMDSavg<-NMDSandplots2004 %>% group_by(exp, ntrt) %>% dplyr::summarise(meanAxis1=mean(MDS1, na.rm=TRUE),sdAxis1=sd(MDS1, na.rm=TRUE),seAxis1=sd(MDS1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(MDS2, na.rm=TRUE),sdAxis2=sd(MDS2, na.rm=TRUE),seAxis2=sd(MDS2, na.rm=TRUE)/sqrt(n()), n=n())



##plotting specifications#####


NMDSandplots2004_2<-NMDSandplots2004%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

NMDSandplots2004_2$ntrt2  <- mapvalues(NMDSandplots2004_2$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))
NMDSandplots2004_2$ntrt2 <- factor(NMDSandplots2004_2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))


NMDSandplots2004_2$exp2<-mapvalues(NMDSandplots2004_2$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

NMDSandplots2004_2$exp2 <- factor(NMDSandplots2004_2$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

##plotting specifications#####


NMDSavg_2<-NMDSavg%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

NMDSavg_2$ntrt2  <- mapvalues(NMDSavg_2$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))
NMDSavg_2$ntrt2 <- factor(NMDSavg_2$ntrt2, levels = c("None", "0 N+micro", "1 N + micro", "3.4 N + micro","9 N + micro"))


NMDSavg_2$exp2<-mapvalues(NMDSavg_2$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

NMDSavg_2$exp2 <- factor(NMDSavg_2$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

####

####


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))




####

NMDS2004plot <- ggplot() + 
    xlab("NMDS 1") +
    ylab("NMDS 2") + 
    geom_point(data=NMDSandplots2004_2, 
               aes(x=MDS1, y=MDS2, colour=ntrt2, shape=exp2), 
               size=1)+
  geom_point(data=NMDSavg_2, 
               aes(x=meanAxis1, y=meanAxis2, colour=ntrt2, shape=exp2), 
               size=4)+
  geom_segment(data = enddfmain2,
               aes(x = 0, xend = NMDS1/2, y = 0, yend = NMDS2/2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  geom_text(data = enddfmain2, aes(x = NMDS1/2, y = NMDS2/2, label = species2),
            size = 2.5, position=position_jitter(height=0.03, width=0.03))+
  scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+  
  mytheme+
    theme(strip.text.x = element_text(size = 14, colour = "black"))+
    theme(strip.text.y = element_text(size = 14, colour = "black"))+
    theme(legend.position = c(0.85, 0.25),
          legend.spacing.x = unit(0.03, 'cm'))+
    theme(legend.text = element_text(size=6))+
    theme(legend.key.size = unit(0.4, 'cm'))


```

