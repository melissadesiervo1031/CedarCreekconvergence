---
title: "Cedar Creek data analysis"
author: "Melissa DeSiervo" mhdesiervo@gmail.com; mdesierv@uwyo.edu
date: "3/25/2022"
output: html_document
---


library(plyr)
library(dplyr)
library(ggplot2)
library(ape)
library(devtools)
library(tidyr)
library(vegan) ##must be the most recent version from github##
library(viridis)
library(stringr)
library(here)
library(tidyverse)
library(tsvr)
library(ggpubr)
library(ecotraj)
library(investr)
library(data.table)
library(trajr)
library(gtable)
library(gridExtra)
library(codyn)
library(indicspecies)
library(BiodiversityR)
library(ggrepel)
library(lme4)



```{r aictable function}

aictable<-function(X,m){
  #
  #  This function will create a full model selection table based on AICc.
  #  
  #  Inputs:
  #
  #  X is the AIC table produced by R by using AIC(model1,model2, ...)
  #  m is the sample size
  #
  #
  rnames<-row.names(X)
  AICc<-X$AIC+2*X$df*(X$df+1)/(m-X$df-1)     #small-sample correction
  logL<-X$df-X$AIC/2                         #Log-likelihood
  tab<-data.frame(X[,1],logL,AICc)           #Remove AIC column; add logL and AICc
  colnames(tab)[1]<-c("Params")              #Rename "df" column   
  row.names(tab)<-rnames
  tab<-tab[order(tab$AICc),]                 #Sort by ascending AICc value
  deltaAICc<-tab$AICc-min(tab$AICc)          #Delta AICc
  weight<-exp(-deltaAICc/2)/sum(exp(-deltaAICc/2))  #Weights
  cumwt<-weight                              #Column for cumulative weight
  for(i in 2:dim(X)[1]){                  
    cumwt[i]<-cumwt[i-1]+cumwt[i]              #Accumulate weight from the top
  }
  tab<-data.frame(tab,deltaAICc,weight,cumwt)
  tab<-round(tab,4)
  tab
}

```


```{r upload and clean E001 and E002 datasets}


# Reading in and cleaning Cedar Creek data###

#Read in e001 data## Plot data for the unplowed fields##

d1s <- read.csv(here("data/e001-soil-cn-2019-09-13.csv"), header=T, strip.white=T, skip=1)

# Delete some extra variables and add dummies to stack exp1 & exp2 data
d1s$natm.nadd <- NULL
d1s$fertadd <- NULL
d1s$burn.trt.1992 <- NA
d1s$ntrt.last.year <- 'CurrentYear'
d1s$ntrt.origin <- 1 # No cessation in E001
d1s$disk <- 0 # E001 was not disked before experiment (disturbed vegetation)
d1s$exp <- 1

#Read in e002 data ##Plot data for the plowed fields##

d2s <- read.csv(here("data/e002-soil-cn-2019-09-13.csv"), header=T, strip.white=T, skip=1)

## Delete some extra variables and add dummies to stack exp1 & exp2 data
d2s$X <- NULL
d2s$date <- NULL
d2s$BurnRecBeginning1992 <- NULL
d2s$NtrtRecBefore1992 <- NULL
d2s$TrtRecAfter1991 <- NULL
d2s$TrtRecAfter2013 <- NULL
d2s$burn <- NA
d2s$fence <- NA
d2s$fence.origin <- NA
d2s$depth <- NA
d2s$disk <- 1 # E002 was disked before experiment (disturbed vegetation)
d2s$exp <- 2


#Additioanl plot info for both experiments##

d3s <- read.csv(here("data/E001-E002-Soil-CN-2018.csv"), header=T, strip.white=T, skip=0, na.strings=c(""))


# Delete samples that have errors
d3s <- d3s[is.na(d3s$FLAGGED.FOR.RERUN..S.Spillage..E.Error.),]

# Delete some extra variables and add dummies to stack exp1 & exp2 data
d3s$FLAGGED.FOR.RERUN..S.Spillage..E.Error. <- NULL
d3s$Sample <- NULL
d3s$X <- NULL
d3s$burn <- NA
d3s$burn.origin <- NA
d3s$burn.trt.1992 <- NA
d3s$fence <- NA
d3s$fence.origin <- NA
d3s$depth <- NA
d3s$disk <- NA
d3s$nadd <- NA
d3s$ntrt <- NA
d3s$ntrt.last.year <- NA
d3s$ntrt.origin <- NA
d3s$trt.origin <- NA  

d3s$disk[d3s$exp==1] <- 0 # E001 was not disked before experiment (intact vegetation)
d3s$disk[d3s$exp==2] <- 1 # E002 was disked before experiment (disturbed vegetation)

# Check that data sets have the same variables
sort(names(d1s))
sort(names(d2s))
sort(names(d3s))

# Stack exp1 & 2 data
ds <- rbind(d1s,d2s,d3s)


#Read in e001 aboveground plant biomass data ##

d1a <- read.csv(here("data/e001-aboveground-mass-2019-09-13.csv"), header=T, strip.white=T, skip=1)



# Delete some extra variables and add dummies to stack exp1 & exp2 data
d1a$natm.nadd <- NULL
d1a$fertadd <- NULL
d1a$burn.trt.1992 <- NA
d1a$ntrt.last.year <- "CurrentYear" # No cessation in E001
d1a$ntrt.origin <- 1 # No cessation in E001
d1a$subplot <- NA
d1a$disk <- 0 # E001 was not disked before experiment (disturbed vegetation)
d1a$exp <- 1


#Read in e002 aboveground plant biomass data ##
d2a <- read.csv(here("data/e002-aboveground-mass-2019-09-13.csv"), header=T, strip.white=T, skip=1)


# Delete some extra variables and add dummies to stack exp1 & exp2 data
d2a$X <- NULL
d2a$date <- NULL
d2a$burn <- NA
d2a$fence <- NA
d2a$fence.origin <- NA
d2a$disk <- 1 # E002 was disked before experiment (intact vegetation)
d2a$exp <- 2


# Check that data sets have the same variables
sort(names(d1a))
sort(names(d2a))


# Stack exp1 & 2 data

da <- rbind(d1a,d2a)

# Delete records with key missing data
da <- da[!is.na(da$mass),]

# Disking not done if field D
da <- da[da$field != 'D',]
da$field <- as.factor(as.character(da$field))


# If subplot is missing specify it as a whole plot
da$subplot[is.na(da$subplot)] <- "Whole"

# Code other Nutrient additions
da$other.add <- 1
da$other.add[da$ntrt == 9] <- 0


################################################################################
# Here we make a clean design file of original treatments                      #
# Make clean subplot and year level file with original treatments only.        #
################################################################################


names(da)

# SUBPLOT SCALE Get a list of plots that have original treatments
design.df <- ddply(da, .(field, exp, plot, subplot, ntrt, nadd, disk, other.add, ntrt.origin), colwise(mean, .(mass.above)))
design.df$mass.above <- NULL
dim(design.df)
with(design.df, table(plot, field, exp))
dim(design.df)

# PLOT SCALE Get a list of plots that have original treatments
design.df.plot <- ddply(da, .(field, exp, plot, ntrt, nadd, disk, other.add, ntrt.origin), colwise(mean, .(mass.above)))
design.df.plot$mass.above <- NULL
dim(design.df.plot)
with(design.df.plot, table(plot, field, exp))
dim(design.df.plot)


# YEAR AND SUBPLOT SCALE Get a list of plots that have original treatments
design.df.yr <- ddply(da, .(field, exp, plot, subplot, year, ntrt, disk, other.add, ntrt.origin, burn.origin, fence.origin), colwise(mean, .(mass.above)))
design.df$mass.above <- NULL
dim(design.df)
with(design.df, table(plot, field, exp))
dim(design.df)

#### Important note: burn.origin column isn't exactly right for B E002. The burn doesn't happen until 1992, so should be 54 plots from 1982-1991 and 27 plots 1992-2004###

summary(design.df.yr)
design.orig <- design.df.yr   #dim 9086 X 12

# Delete cessations plots
design.orig <- design.orig[design.orig$ntrt.origin==1,]  #dim #7799   12#


# Delete subplots with experimental burns (after 1992)
#design.orig <- design.orig[design.orig$burn.origin==1,]
design.orig<-subset(design.orig, year < 1992| year >= 1992 & burn.origin==1) #dim #6153   12#

# Some field level data is not represented in both data sets
# Get this sorted out across merged data set
# Fences removed in 2004 (partial removal in field C but still open generally)
# After 2004 all of E002 is unfenced
design.orig$fence[design.orig$year <= 2004 & design.orig$exp==2] <- 1
design.orig$fence[design.orig$year > 2004 & design.orig$exp==2] <- 0

# After 2004 all of E001 is unfenced except in field C
design.orig$fence[design.orig$year <= 2004 & design.orig$exp==1 & design.orig$field != 'C'] <- 1
design.orig$fence[design.orig$year > 2004 & design.orig$exp==2 & design.orig$field != 'C'] <- 0

# Pull out data that is fenced after 2004 as these were invidual plots 
# fenced in field C (I think) after whole field fences were removed. 
design.orig$sel <- TRUE
design.orig$sel[design.orig$year > 2004 & design.orig$fence == 1] <- FALSE
design.orig <- design.orig[design.orig$sel,]
with(design.orig, table(year,fence, exp))
with(design.orig, table(year, field,fence.origin, exp))
with(design.orig, table(year, fence, field, exp))

dim(design.orig)   #dim #6153   12#
summary(design.orig)

# Get field scale burn record
df.burn <- ddply(d1a, .(field, year), colwise(max, .(burn)), na.rm=T)
# Replace original burn record with field summary
da$burn <- NULL
da <- merge(da, df.burn, by=c("field", "year"), all.x=TRUE)


# MERGE IN DESIGN.ORIG FILE TO ONLY HAVE FILES FOR WHICH TREATMENTS HAVE NOT CHANGED

dim(da)  ##72737  X  19### ##includes N cessation and burned plots###
dim(design.orig)  # Unique plot_years with correct treatments### ##dim 6396##

design.orig2<-design.orig %>% select(field, year, exp, disk, plot, subplot, ntrt, other.add, ntrt.origin, burn.origin, fence.origin)

da_min<-da %>% select(field, year, exp, disk, plot, subplot, ntrt,  species, mass.above) #72737  X 9### ##includes N cessation and burned plots###

da_orig<-merge(design.orig2, da_min, by =c("field", "year", "exp", "disk", "plot", "subplot", "ntrt")) # ##dim 50404    13### 

### da_orig is what we want to use moving foward...##

##### get counts by plot year to crosscheck with excel file "Datasubset_CC Convergence###


da_origsiteyear<-da_orig %>%  distinct(field, year, exp, disk, plot, subplot, ntrt, .keep_all = T)

plotcountcheck<-da_origsiteyear%>%group_by(exp, field, year) %>%  tally()

plotcountcheck2<-da_origsiteyear%>%group_by(exp, year) %>%  tally()


plotcountcheck19822004<-subset(plotcountcheck, year < 2005)

sum(plotcountcheck19822004$n) #  6102 total plots-years 1982 to 2004 #### matches exactly w/ excel file## :-) 

sum(plotcountcheck$n)  ## 6396 total plot  years to be analyzed with full times series (note that this includes the E/W subplots that are compiled later...#### 



################# TAXONOMIC AND OTHER SMALL DATA FIXES####################


# Capitalize species to get rid of capilization differences in spelling
da_orig$species <- toupper(as.character(da_orig$species))


###
da_orig$live <- 1
da_orig$sorted <- 1
da_orig$wood <- 0
da_orig$vasc <- 1

# Do some general substitutions

da_orig$species <- gsub("APOCYNUM CANNABINUM", "APOCYNUM ANDROSAEMIFOLIUM", da_orig$species) ## MD 11/1 based off email with Eric##
da_orig$species <- gsub("MISC. FORB", "MISCELLANEOUS FORB", da_orig$species)
da_orig$species <- gsub("SEDGES", "CAREX SP.", da_orig$species)
da_orig$species <- gsub("QUERCUS RUBRUM", "QUERCUS RUBRA", da_orig$species)

# Find litter and code as not alive
sel<-da_orig$species == 'MISCELLANEOUS LITTER'
da_orig$live[sel] <- 0

sel<-grep("PINE", da_orig$species)
da_orig$live[sel] <- 0

# Code unsorted material as not being sorted
sel<-grep("MISCELLANEOUS", da_orig$species)
da_orig$sorted[sel] <- 0

sel<-grep("FUNGI", da_orig$species)
da_orig$sorted[sel] <- 0

sel<-grep("MOSS", da_orig$species)
da_orig$sorted[sel] <- 0

sel<-grep("LICHEN", da_orig$species)
da_orig$sorted[sel] <- 0

# Woody stuff
sel<-grep("ACER NEGUNDO", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("CEANOTHUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("CORYLUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("PINUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("PINE", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("POPULUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("QUERCUS", da_orig$species)
da_orig$wood[sel] <- 1
sel<-grep("ULMUS", da_orig$species)
da_orig$wood[sel] <- 1


##mistake w/ biomass for Asclepias syriaca##
da_orig["mass.above"][da_orig["mass.above"] == 1711.970] <- 1711.970/10


# Read in species attribute look up table
sp.df <- read.csv(here("data/Cedar_Creek_Plant_Taxon_List.csv"),header=T)



names(sp.df)[] <- tolower(names(sp.df))

sp.df<-plyr::rename(sp.df, c("ï..species"="species"))
sp.df$species <- toupper(sp.df$species) 
sp.df$functional.group <- toupper(sp.df$functional.group)
sp.df$duration <- toupper(sp.df$duration)
sp.df$lifeform <- toupper(sp.df$lifeform)
sp.df$pathway <- toupper(sp.df$pathway)
sp.df$origin <- toupper(sp.df$origin)
sp.df$family <- toupper(sp.df$family)

da_full <- merge(da_orig,sp.df, by='species', all.x=TRUE)

# Set Unknowns to missing
da_full$origin[da_full$origin == 'UNKNOWN'] <- NA
da_full$origin[da_full$origin == 'NATIVE AND/OR INTRODUCED'] <- NA


da_full$functional.group[da_full$functional.group == 'UNKNOW'] <- NA

da_full$duration[da_full$duration == 'UNKNOWN'] <- NA
da_full$duration[da_full$duration == 'BIENNIAL, PERENNIAL'] <- "BIENNIAL"

# Lump biennials in with annuals as they are pretty similar
# mostly weedy forbs 
unique(da_full$species[da_full$duration=="BIENNIAL"])
unique(da_full$species[da_full$duration=="BIENNIAL, PERENNIAL"])
unique(da_full$species[grep('BIENNIAL', da_full$duration)]) 

da_full$duration[grep('BIENNIAL', da_full$duration)] <- "ANNUAL"
unique(da_full$species[da_full$duration=="ANNUAL" & da_full$functional.group=="C4"])
unique(da_full$species[da_full$duration=="ANNUAL" & da_full$functional.group=="F"])

# Add in some species atrributes
sel <- da_full$species == "QUERCUS RUBRA"
da_full$functional.group[sel] <- "W"
da_full$lifeform[sel] <- "WOODY"
da_full$origin[sel] <- "NATIVE"

# Add in some species atrributes
sel <- da_full$species == "RUDBEKIA SEROTINA"
da_full$functional.group[sel] <- "F"
da_full$lifeform[sel] <- "FORB"
da_full$origin[sel] <- "NATIVE"

# Add in some species atrributes
sel <- da_full$species == "POA PRATENSIS"
da_full$origin[sel] <- "INTRODUCED"

sel <- da_full$species == "MISCELLANEOUS CAREX SP."
da_full$functional.group[sel] <- "S"
da_full$lifeform[sel] <- "SEDGE"
da_full$origin[sel] <- "NATIVE"


# Capitalize species to get rid of capilization differences in spelling
da_full$species <- toupper(as.character(da_full$species))

##deal with some entries where sp. were weighed twice##
summary(freq <- ddply(da_full[da_full$live==1 & da_full$sorted==1, ], .(year, field, exp, plot, subplot, disk, ntrt, species), colwise(length, .(mass.above)))) ##takes a while##

freq$freq <- freq$mass.above

freq$mass.above <- NULL
freq[freq$freq > 1,]

doubles.df <- merge(freq[freq$freq > 1,], da_full[c("field", "exp","plot", "year", "species", "mass.above")], by=c("field", "exp","plot", "year", "species"))
doubles.df[c("field", "exp","plot", "year", "species", "mass.above")]

#####
# There are a few cases where there are multiple species weighed per sample. 
# Options are taking max, min, mean, or sum. 

#da.mn <- ddply(da_full, .(field, exp, plot, subplot, year, disk, ntrt, nadd, species, live, sorted, wood, functional.group, lifeform, duration, origin), colwise(mean, .(mass.above)))
##takes a while##

# subset to live, sorted, herbaceous plants
d2 <- da_full[da_full$sorted ==1 & da_full$live ==1 & da_full$wood==0, c("field", "exp","plot", "subplot", "year", "disk", "ntrt",  "species", "mass.above")]

#subset that includes woody stuff####
d2woody <- da_full[da_full$sorted ==1 & da_full$live ==1, c("field", "exp","plot", "subplot", "year", "disk", "ntrt", "species", "mass.above")]


#Add some columns for herbaceous version####
d3<-d2 %>% mutate(expntrtfieldyear= paste(exp,field, ntrt, year, sep = '_'), expntrtyear= paste(exp,ntrt, year, sep = '_'), ntrt2=ntrt) 

#Add some columns for herbaceous + woody version ####
d3woody<-d2woody %>% mutate(expntrtfieldyear= paste(exp,field, ntrt, year, sep = '_'), expntrtyear= paste(exp,ntrt, year, sep = '_'), ntrt2=ntrt) 


##These data frames (d3 or d3woody) has fields A, B, C, experiment 1 (intact) & exp 2 (disked in 1982) in a long data dataformat ##9 levels of nutrient addition#### years 1982 - 2019 (not every field / exp sampeled in every year## 
#### Has both whole plots and suplots...###


# Transpose herbaceous and woody data to be a site by species matrix
da.widewoody <- reshape(d3woody,
                   v.names="mass.above",
                   idvar=c("field", "exp","plot", "subplot", "year", "disk", "ntrt", "expntrtyear"),
                   timevar="species",
                   direction="wide") 
# Fill in NA's with zeros in wide data set
da.widewoody[is.na(da.widewoody)] <- 0

##make nutrient and years factors#

da.widewoody$ntrt<-as.factor(da.widewoody$ntrt)
da.widewoody$year<-as.factor(da.widewoody$year)

########Combine east / west subplots into "whole" to match up with rest of data (from 2015)#######

##make only the biomasses the numeric variables##
da.widewoody$exp<-as.factor(da.widewoody$exp)
da.widewoody$disk<-as.factor(da.widewoody$disk)


#subset out the east/ west subplots plots and the whole plots ##

da.wideeastwest<-subset(da.widewoody, subplot=="East"|subplot=="West", row.names=NULL)
da.widewhole<-subset(da.widewoody, subplot=="Whole", row.names=NULL)

##Add the values from the subplots together##

EWaddall<-as.data.frame(da.wideeastwest%>%group_by(field,exp,plot,year,disk,ntrt,expntrtyear, expntrtfieldyear, ntrt2) %>% summarise_if(is.numeric,sum)%>% mutate(subplot="Whole"))


###merge the whole plots back together###
da.wide_allwhole<-rbind(da.widewhole,EWaddall)



dim(da.wide_allwhole) ## dimensions of the dataset = 6126  194##

##reorder columns so that all the rows are in the same order across fields etc. 
da.wide5<-da.wide_allwhole%>%arrange(year)%>%arrange(plot)%>%arrange(exp)%>%arrange(field) 


##### Check that the max number of rep within a treatment is 18, since 6 plots in each field and exp recieved the same N treatment##

max(ave(da.wide5$plot, da.wide5$expntrtyear,FUN = seq_along))


####check the plotyears####


plotcountcheck5<-da.wide5%>%group_by(exp, field, year) %>%  tally()

plotcountcheck2<-da_origsiteyear%>%group_by(exp, year) %>%  tally()


##This data frame (da.wide5) has fields A, B, C, experiment 1 (intact) & exp 2 (disked in 1982) ## years 1982 - 2019 for E002 and years 1982 - 2004 for exp E001 (not every field / exp sampeled in every year## INCLUDES WOODY PLANTS
###wide version format###

# N Treatments (Ntrt) Details (from Table 1 Tilman 1987)
# Ntrt Trt g N/m2/yr Other nutrients 
# 1     A       0.0      All 
# 2     B       1.0      All 
# 3     C       2.0      All 
# 4     D       3.4      All 
# 5     E       5.4      All 
# 6     F       9.5      All 
# 7     G      17.0      All 
# 8     H      27.2      All 
# 9     I       0.0      None 

##da.wide5 = fields A, B, C, E001 and E002 1982 to 2019 w/ some missing years###

###some notes about missing data##
## E002 missing data = 2003 field A & B, 2005 all fields , 2006 all fields , 2009 A and C, 2010 all fields, 2011 A, 2012 all fields, 213 A and C, 2014 all fields, 2015 A, 2016 A, 2017 all, ####


############ SUBSETTING FROM FULL DATASET FIELDS ABC E001 and E002########


##subset to years before 2005 for BOTH E001 and E002 ## (bc of change in fire regime)

da.wide5$year<-as.numeric(as.character(da.wide5$year)) 

exp12subset<-subset(da.wide5,year<2005)


##subset to selected nutrient treatments below 9.5 g N##

#exp12subset_1<-subset(exp12subset,ntrt==9|ntrt==1|ntrt==2|ntrt==4|ntrt==6)


### this data set (exp12subset_1 has fields ABC, E001 and E002 from 1982-2004) ## > 2004 was a change in the fire regime## ONLY the control and selected nutrient treatments below 9.5 g N) ##

###some notes about missing data##
## E001 data set is complete from 1982 - 2004. E002 dataset is missing years 1995, 1998, 2001, 2003 ALL fields##




```


```{r clean field D data}


#### SELECTING JUST FIELD D TO LOOK AT REMNANT VEGETATION (NEVER PLOWED)###

# Stack exp1 & 2 data
da <- rbind(d1a,d2a)

# Delete records with key missing data
da <- da[!is.na(da$mass),]

# Selecting just field D###

da_fieldD <- subset(da, field=="D")

####

# Capitalize species to get rid of capilization differences in spelling
da_fieldD$species <- toupper(as.character(da_fieldD$species))


# mabye we include woody for field D? not sure yet...###
da_fieldD$live <- 1
da_fieldD$sorted <- 1
da_fieldD$wood <- 0
da_fieldD$vasc <- 1

# Do some general substitutions

da_fieldD$species <- gsub("APOCYNUM CANNABINUM", "APOCYNUM ANDROSAEMIFOLIUM", da_fieldD$species) ## MD 11/1 based off email with Eric##
da_fieldD$species <- gsub("MISC. FORB", "MISCELLANEOUS FORB", da_fieldD$species)
da_fieldD$species <- gsub("SEDGES", "CAREX SP.", da_fieldD$species)
da_fieldD$species <- gsub("QUERCUS RUBRUM", "QUERCUS RUBRA", da_fieldD$species)

# Find litter and code as not alive
sel<-da_fieldD$species == 'MISCELLANEOUS LITTER'|da_fieldD$species == 'WOODY DEBRIS'

da_fieldD$live[sel] <- 0

sel<-grep("PINE", da_fieldD$species)
da_fieldD$live[sel] <- 0

# Code unsorted material as not being sorted
sel<-grep("MISCELLANEOUS", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

sel<-grep("FUNGI", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

sel<-grep("MOSS", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

sel<-grep("LICHEN", da_fieldD$species)
da_fieldD$sorted[sel] <- 0

# Woody stuff
sel<-grep("ACER NEGUNDO", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("CEANOTHUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("CORYLUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("PINUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("PINE", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("POPULUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("QUERCUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1
sel<-grep("ULMUS", da_fieldD$species)
da_fieldD$wood[sel] <- 1


###remove the not live stuff...leave in trees ###

da_fieldD_2<-subset(da_fieldD, live==1)


### Without trees###

# subset to live, sorted, herbaceous plants
da_fieldD_3 <- da_fieldD[da_fieldD$sorted ==1 & da_fieldD$live ==1 & da_fieldD$wood==0, c("field", "plot", "year", "species", "mass.above")]


######### with trees####


# Transpose data to be a site by species matrix
da_fieldD_wide <- reshape(da_fieldD_2,
                   v.names="mass.above",
                   idvar=c("field", "plot", "year"),
                   timevar="species",
                   direction="wide") 

# Fill in NA's with zeros in wide data set
da_fieldD_wide[is.na(da_fieldD_wide)] <- 0





```


###PERMANOVA AND PCOA FULL N GRADIENT###
##this chunk takes a long time to run.....###

```{r - Conduct a PCoA using all the veg data across years  FULL N GRADIENT (log)}


exp12subset<-subset(da.wide5,year<2005)

##make nutrient and years factors#

exp12subset$ntrt<-as.factor(exp12subset$ntrt)
exp12subset$year<-as.factor(exp12subset$year)


##arrange the dataframe so that that columns and rows are in right order##
exp12subsetsorted<-exp12subset%>%arrange(year)%>%arrange(plot)%>%arrange(field)%>%arrange(exp)


##just the plot data##
plot<-exp12subsetsorted%>% dplyr::select('field':'ntrt2')

##just the veg data##

veg<-exp12subsetsorted%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)



###log transformation####

vegmatrix<-as.matrix(veg)

logveg<-log(1+vegmatrix)


## Bray curtis dissimiliarty matrix##
distE1andE2<-vegdist(logveg, method="bray")
BCdistall<-as.matrix(distE1andE2)  ##into a matrix#
BCdistalldf<-as.data.frame(BCdistall)  #into a dataframe#

BCdistalldf2<-cbind(plot,BCdistalldf) #merge plot data w/ dissim matrix##

##BCdistalldf2 has the plot info and the BC dissimilarity matrix for the entire experiment (E001 and E002, all three fields combined, with a subsetted selection of the ntrt treatments)

###PcOA for both E011 and E002 together####

PCOA_allfieldE12_fullN <- pcoa(distE1andE2)  ## takes a while##

PCOA_allfieldE12_cmd <- cmdscale(distE1andE2, eig=TRUE, add=FALSE)  ## Another way of doing the pcoa that gives same results#


## extracting the axis scores for each exp##

PCOAaxesboth_fullN <- PCOA_allfieldE12_fullN$vectors[,c(1,2)]


##merge the axis scores with the plot data ###

PCOAandplotsboth_fullN<-cbind(plot,PCOAaxesboth_fullN )

##PCOAandplotsboth_full N has the plot info and the PCOA scores for the entire experiment (E001 and E002, all three fields combined, wiah ALL of the ntrt treatments)


####species scores#####

PCOA_allfieldE12_cmd_wscores<-add.spec.scores(PCOA_allfieldE12_cmd, veg,  method='cor.scores')

spscores<-as.data.frame(PCOA_allfieldE12_cmd_wscores$cproj)
names<-rownames(spscores)
rownames(spscores) <- NULL

spscores_df <- cbind(names,spscores)

spscores_df$names <- with(spscores_df, gsub("mass.above.","", names))

```

##this chunck takes a long time to run.....###

```{r - Conduct permanova: nutrient, disturbance, field effect (log data) FULL N GRADIENT}

exp12subset<-subset(da.wide5,year<2005)


####for this analysis, getting rid of the years where not every field was sampeled##

exp12subset_22<-exp12subset%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)



###log transform the biomass data###

justveg<-as.matrix(exp12subset_22[,12:198])

logveg<-log(1+justveg)

exp12subset_22<-cbind(exp12subset_22[,1:11], logveg)



### Extract two  years year to get the apply function to work#####

da.wide_1990<-subset(exp12subset_22, year=="1990", row.names=NULL)

da.wide_1999<-subset(exp12subset_22, year=="1999", row.names=NULL)

###
exp12subset_19821991<-subset(exp12subset_22, as.numeric(as.character(year)) < 1992)
exp12subset_19922004<-subset(exp12subset_22, as.numeric(as.character(year)) >= 1992)

#drop the levels not sampeled

levels(exp12subset_19821991$year)
exp12subset_19821991$year <- as.factor(as.character(exp12subset_19821991$year))


levels(exp12subset_19922004$year)
exp12subset_19922004$year <- as.factor(as.character(exp12subset_19922004$year))


##PERMANOVA###

### investigate the blocking / strata issue ###

## Correct with strata
 test<-with(da.wide_1990, adonis2(vegdist(da.wide_1990[,11:198]) ~ exp+ntrt+field, data = da.wide_1990,  strata = da.wide_1990$field))

 test2<-adonis2(vegdist(da.wide_1990[,11:198])~exp+ntrt+field, data= da.wide_1990)
 
 #### using strata rescricts permutations to within fields. Makes no difference in Sum of Sqs or R2 (what we report) -- only matters for the p value ####
 
 
 ##Do a PERMANOVA looping over years, looking at effect of exp (disturbed or not), ntrt treatment# and field (A, B, C)###
 
##need to do this in two batches because from 1992 on there are fewer plots..####

###
permallfields1<-lapply(X = split.data.frame(x = exp12subset_19821991, f=exp12subset_19821991$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt+field, data= da.wide_1990)
  return(data.frame(z))
  }
  )



permallfields2<-lapply(X = split.data.frame(x = exp12subset_19922004, f=exp12subset_19922004$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+ntrt+field, data= da.wide_1999)
  return(data.frame(z))
  }
  )




##dataframe of results##
permmaster1<-plyr::ldply(permallfields1, data.frame)
permmaster2<-plyr::ldply(permallfields2, data.frame)


names<-c("Disturbance", "Fertilization", "Field", "residual", "total")

sourcevariation<-rep(names,length(unique(permmaster1$.id)))

permmaster11<-cbind(sourcevariation,permmaster1)

sourcevariation<-rep(names,length(unique(permmaster2$.id)))

permmaster22<-cbind(sourcevariation,permmaster2)

###

permmasterall<-rbind(permmaster11, permmaster22)
  
permmaster3_allnut<-subset(permmasterall,sourcevariation=="Disturbance"|sourcevariation=="Fertilization"|sourcevariation=="Field") 

##This dataframe (permmmaster3_allnut) has the results from a permanova for each independent variable (disturbance, field, fertilization) for every year in the dataset w/ everything sampeled. The R2 column is what is plotted in Fig 1 ###



```


```{r - Conduct permanova: nutrient as quantitative, disturbance, field effect (log data) FULL N GRADIENT}

exp12subset<-subset(da.wide5,year<2005)


###add in N as quanitative variable###


# N Treatments (Ntrt) Details (from Table 1 Tilman 1987)
# Ntrt Trt g N/m2/yr Other nutrients 
# 1     A       0.0      All 
# 2     B       1.0      All 
# 3     C       2.0      All 
# 4     D       3.4      All 
# 5     E       5.4      All 
# 6     F       9.5      All 
# 7     G      17.0      All 
# 8     H      27.2      All 
# 9     I       0.0      None 


exp12subset$nadd<-exp12subset$ntrt


exp12subset$nadd <- mapvalues(exp12subset$nadd, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("0", "0", "1", "2", "3.4","5.4","9.5", "17", "27"))




####for this analysis, getting rid of the years where not every field was sampeled##

exp12subset_22<-exp12subset%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)

###move columns##

exp12subset_22$nadd<-as.numeric(as.character(exp12subset_22$nadd))


exp12subset_22<-exp12subset_22 %>% select(field, exp, plot, subplot, year, disk, ntrt, expntrtfieldyear, expntrtyear, ntrt2, nadd, `mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`   )


###drop the control ntrt 9, to do quantitatve N +micro###

exp12subset_33<-subset(exp12subset_22, ntrt!=9 )



###log transform the biomass data###

justveg<-as.matrix(exp12subset_33[,13:199])

logveg<-log(1+justveg)

exp12subset_33<-cbind(exp12subset_33[,1:12], logveg)



### Extract two  years year to get the apply function to work#####

da.wide_1990<-subset(exp12subset_33, year=="1990", row.names=NULL)

da.wide_1999<-subset(exp12subset_33, year=="1999", row.names=NULL)

###
exp12subset_19821991<-subset(exp12subset_33, as.numeric(as.character(year)) < 1992)
exp12subset_19922004<-subset(exp12subset_33, as.numeric(as.character(year)) >= 1992)

#drop the levels not sampeled

levels(exp12subset_19821991$year)
exp12subset_19821991$year <- as.factor(as.character(exp12subset_19821991$year))


levels(exp12subset_19922004$year)
exp12subset_19922004$year <- as.factor(as.character(exp12subset_19922004$year))


##PERMANOVA###

### investigate the blocking / strata issue ###

## Correct with strata
 test<-with(da.wide_1990, adonis2(vegdist(da.wide_1990[,11:198]) ~ exp+ntrt+field, data = da.wide_1990,  strata = da.wide_1990$field))

 test2<-adonis2(vegdist(da.wide_1990[,11:198])~exp+ntrt+field, data= da.wide_1990)
 
 #### using strata rescricts permutations to within fields. Makes no difference in Sum of Sqs or R2 (what we report) -- only matters for the p value ####
 
 
 ##Do a PERMANOVA looping over years, looking at effect of exp (disturbed or not), ntrt treatment# and field (A, B, C)###
 
##need to do this in two batches because from 1992 on there are fewer plots..####

###
permallfields1<-lapply(X = split.data.frame(x = exp12subset_19821991, f=exp12subset_19821991$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+nadd+field, data= da.wide_1990)
  return(data.frame(z))
  }
  )



permallfields2<-lapply(X = split.data.frame(x = exp12subset_19922004, f=exp12subset_19922004$year),function(t){
  z<-adonis2(vegdist(t[,11:198])~exp+nadd+field, data= da.wide_1999)
  return(data.frame(z))
  }
  )




##dataframe of results##
permmaster1<-plyr::ldply(permallfields1, data.frame)
permmaster2<-plyr::ldply(permallfields2, data.frame)


names<-c("Disturbance", "Fertilization", "Field", "residual", "total")

sourcevariation<-rep(names,length(unique(permmaster1$.id)))

permmaster11<-cbind(sourcevariation,permmaster1)

sourcevariation<-rep(names,length(unique(permmaster2$.id)))

permmaster22<-cbind(sourcevariation,permmaster2)

###

permmasterall<-rbind(permmaster11, permmaster22)
  
permmaster3_allnut<-subset(permmasterall,sourcevariation=="Disturbance"|sourcevariation=="Fertilization"|sourcevariation=="Field") 

##This dataframe (permmmaster3_allnut) has the results from a permanova for each independent variable (disturbance, field, fertilization) for every year in the dataset w/ everything sampeled. The R2 column is what is plotted in Fig 1 ###



```

```{r - recreate FIG 1, R2 FULL N GRADIENT}


permmaster3_allnut2<- permmaster3_allnut %>% mutate (year=as.numeric(.id))  %>% mutate (year2=year-1981)

permmaster3_allnut2$sourcevariation<- factor(permmaster3_allnut2$sourcevariation, levels = c("Disturbance", "Fertilization", "Field"))

my_plotlabels = paste0('(', letters, ') ')

abclabels = paste0(my_plotlabels[1:length(levels(permmaster3_allnut2$sourcevariation))]) 

permmaster5<-cbind(permmaster3_allnut2, abclabels)


##make the plot##

mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))




variancetimeall_allnut<-permmaster5 %>% ggplot(aes(x=as.numeric(year2), y=R2, group=sourcevariation)) +
    geom_point() +
    facet_wrap(~sourcevariation, strip.position = c("top"))+
    geom_smooth(method="loess", colour="black", size=0.5, fill = "gray1") +
    geom_text(aes(x = 2.0, y = 0.54, label = abclabels, group =     abclabels),size = 4,check_overlap = T)+
    ylab(expression('Explained variation'))+
    xlab("Time since experiment (years)")+
    mytheme+
    theme(strip.text = element_text(face="bold", size=12))+
     theme(strip.background = element_blank())


   ###

```


```{r - recreate FIG 2, PCOA ordination by year FULL N GRADIENT}


##PCOAandplotsE001 (and E002) have 11 colummns of plot data, PC0A axis 1 and 2 for each plot (in each year, field, subset of ntrt conditions)##


PCOAandplotsboth_fullN



#first check that there are 18 OR 9 in each ntrt treatment / year##
PCOAandplotscount_fullN<-PCOAandplotsboth_fullN %>% count(year,disk,ntrt)

####2003 for E002 only has 1 field so we remove it###

PCOAandplotsboth2_fullN<-PCOAandplotsboth_fullN %>%filter(year!=2003)

PCOAandplotscount2_fullN<-PCOAandplotsboth2_fullN %>% count(year,disk,ntrt)##good now###

PCOAandplotsboth2_fullN$Axis.1<-as.numeric(PCOAandplotsboth2_fullN$Axis.1)
PCOAandplotsboth2_fullN$Axis.2<-as.numeric(PCOAandplotsboth2_fullN$Axis.2)

PCOAandplotsboth2_fullN$year<-as.numeric(as.character(PCOAandplotsboth2_fullN$year))



PCOAandplotsavg_fullN<-PCOAandplotsboth2_fullN %>% group_by(exp,year,disk,ntrt) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())



####

## plot specifications

PCOAandplotsavg2_fullN<-mutate(PCOAandplotsavg_fullN, ntrt2=ntrt)

PCOAandplotsavg2_fullN$ntrt2<-PCOAandplotsavg2_fullN$ntrt



PCOAandplotsavg2_fullN$ntrt2  <- mapvalues(PCOAandplotsavg2_fullN$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N + μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9 N + μ", "17 N + μ", "27.2 N + μ"))

PCOAandplotsavg2_fullN$ntrt2 <- factor(PCOAandplotsavg2_fullN$ntrt2, levels = c("None", "0 N + μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9 N + μ", "17 N + μ", "27.2 N + μ"))




PCOAandplotsavg2_fullN<-PCOAandplotsavg2_fullN  %>% mutate(yearlabel=ifelse(year==1982|year==1992|year==2004,year, NA))%>%mutate(exp_ntrt= as.factor(paste(exp, ntrt, sep = '_')))

PCOAandplotsavg2_fullN$exp_ntrt <- factor(PCOAandplotsavg2_fullN$exp_ntrt , levels = c("1_9", "2_9", "1_1","2_1", "1_2", "2_2","1_3", "2_3", "1_4", "2_4","1_5", "2_5", "1_6", "2_6", "1_7", "2_7", "1_8", "2_8"))

PCOAandplotsavg3_fullN<-PCOAandplotsavg2_fullN %>% mutate(abclabel=exp_ntrt)
levels(PCOAandplotsavg3_fullN$abclabel) <- c( "(a) ", "(b) ", "(c) ", "(d) ", "(e) ", "(f) ", "(g) ", "(h) ", "(i) ", "(j) ", "(k) ", "(l) ", "(m) ", "(n) ", "(o) ", "(p) ", "(q) ", "(r) ")


PCOAandplotsavg3_fullN$disk<-plyr::mapvalues(PCOAandplotsavg3_fullN$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))





mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=7, colour = "black"))+theme(axis.text.y=element_text(size=7, colour = "black"))+theme(axis.title=element_text(size=10))+theme(plot.title=element_text(size=10) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85", size=0.25))+theme(legend.text = element_text(size=8))+theme(legend.key.size = unit(0.45, 'cm'))


##landscape version###

L_PcoAfieldAveragedE001E002_fullN<-ggplot(PCOAandplotsavg3_fullN[order(PCOAandplotsavg3_fullN$year),], aes(x=meanAxis1  , y=meanAxis2 , group=exp_ntrt, color=year, label=year)) +
    geom_point(size=0.35) +
    geom_errorbar(aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2), color="dark gray", size=0.25) +
    geom_errorbarh(aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1), color="dark gray", size=0.25) +
    geom_path(aes(x=meanAxis1 , y=meanAxis2 , group=exp_ntrt, color=year),size=0.25)+
    geom_point(size=0.75) +
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    facet_grid(disk~ntrt2) + 
    mytheme+
    scale_color_viridis(option = "D")+
    scale_fill_viridis(option = "D",trans = 'reverse')+
    guides(#reverse color order (higher value on top)
    color = guide_colorbar(reverse = TRUE),
    #reverse size order (higher diameter on top) 
    size = guide_legend(reverse = TRUE))+
    theme(strip.background = element_blank())+
    theme(strip.text = element_text(face="bold", size=10))+
    theme(panel.spacing.y=unit(0.5, "lines"))+
    scale_x_continuous(limits = c(-0.4, 0.47), breaks = c(-0.3, 0.0, 0.3))+
  scale_y_continuous(limits = c(-0.48, 0.27), breaks = c(-0.25, 0.0, 0.25))


##portrait version###

P_PcoAfieldAveragedE001E002_fullN<-ggplot(PCOAandplotsavg3_fullN[order(PCOAandplotsavg3_fullN$year),], aes(x=meanAxis1  , y=meanAxis2 , group=exp_ntrt, color=year, label=year)) +
    geom_point(size=0.35) +
    geom_errorbar(aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2), color="dark gray", size=0.25) +
    geom_errorbarh(aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1), color="dark gray", size=0.25) +
    geom_path(aes(x=meanAxis1 , y=meanAxis2 , group=exp_ntrt, color=year),size=0.25)+
    geom_point(size=0.75) +
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    facet_grid(ntrt2~disk) + 
    mytheme+
    scale_color_viridis(option = "D")+
    scale_fill_viridis(option = "D",trans = 'reverse')+
    guides(#reverse color order (higher value on top)
    color = guide_colorbar(reverse = TRUE),
    #reverse size order (higher diameter on top) 
    size = guide_legend(reverse = TRUE))+
    theme(strip.background = element_blank())+
    theme(strip.text = element_text(face="bold", size=12))+
    theme(panel.spacing.y=unit(0.5, "lines"))+
    scale_x_continuous(limits = c(-0.38, 0.48), breaks = c(-0.3, 0.0, 0.3))+
  scale_y_continuous(limits = c(-0.48, 0.27), breaks = c(-0.25, 0.0, 0.25))+
   geom_text(aes(x = -0.36, y = 0.23, label = abclabel, group =exp_ntrt),size = 3,check_overlap = T)

 
```


```{r - recreate FIG 4 cd, PCoA by decade FULL N GRADIENT}


PCOAandplotsavg_fullN<-PCOAandplotsboth_fullN %>% group_by(exp,year,disk,ntrt) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())


###get rid of years where we don't have 9 or 18 plots###
####2003 for E002 only has 1 field, so remove it###

PCOAandplotsavg2_fullN<-subset(PCOAandplotsavg_fullN, n>8)


PCOAandplotsavg2_fullN<-PCOAandplotsavg2_fullN  %>% mutate(yearlabel=ifelse(year==1982|year==1988|year==1992|year==2004,year, NA))

######

##by decade####

PcoAplaying_fullN <- PCOAandplotsavg2_fullN %>% filter(year %in% c(1982,2004))

arrow_start_fullN <- PCOAandplotsavg2_fullN %>% filter(year ==1982)
arrow_stop_fullN<- PCOAandplotsavg2_fullN %>% filter(year == 2004)

wide_PcoAplaying_fullN <- pivot_wider(PcoAplaying_fullN, names_from = year, values_from = year)

##just pull out the first year of data##

PCOAandplots1982_fullN<-subset(PCOAandplotsavg2_fullN, year==1982)

##pull out the first, last, and midpoint year##

PCOAandplots198219922004_fullN<-subset(PCOAandplotsavg2_fullN, year==1982|year==1992|year==2004)

PCOAandplots198219922004_fullN<-PCOAandplots198219922004_fullN %>% mutate(abclabel=exp)%>% mutate(ntrt2=ntrt) %>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))



PCOAandplots198219922004_fullN$ntrt2  <- mapvalues(PCOAandplots198219922004_fullN$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

PCOAandplots198219922004_fullN$ntrt2 <- factor(PCOAandplots198219922004_fullN$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))




#first arrow and second##
PcoAplayingfirst_fullN <- PCOAandplotsavg2_fullN %>% filter(year %in% c(1982,1992, 2004))

PcoAplayingfirst2_fullN<-PcoAplayingfirst_fullN %>% mutate(abclabel=exp)
levels(PcoAplayingfirst2_fullN$abclabel) <- c( "(c) ", "(d) ")

#make sure its in the right order##
PcoAplayingfirst2_fullN<-PcoAplayingfirst2_fullN %>% arrange(year)%>% arrange(exp)%>% arrange(ntrt)%>% mutate(ntrt2=ntrt) %>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))




PcoAplayingfirst2_fullN$ntrt2  <- mapvalues(PcoAplayingfirst2_fullN$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

PcoAplayingfirst2_fullN$ntrt2 <- factor(PcoAplayingfirst2_fullN$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))




wide_PcoAplaying1 <- pivot_wider(PcoAplayingfirst2_fullN, names_from = year, values_from = year)

wide_PcoAplaying1$`1982`<-as.numeric(as.character(wide_PcoAplaying1$`1982`))
wide_PcoAplaying1$`1992`<-as.numeric(as.character(wide_PcoAplaying1$`1992`))
wide_PcoAplaying1$`2004`<-as.numeric(as.character(wide_PcoAplaying1$`2004`))


PCOAandplotslabels_fullN<-subset(PcoAplayingfirst2_fullN, ntrt==8)
PCOAandplotslabels_fullN<-PCOAandplotslabels_fullN%>%  mutate(expntrt= paste(exp, ntrt, sep = '_'))%>%  mutate(yearlabel= year)


######

## plot specifications



PCOAandplotsavg2_fullN$disk<-mapvalues(PCOAandplotsavg2_fullN$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



ann_textdisk2 <- data.frame(meanAxis1 = c(0.03, 0.03), meanAxis2 =c(0.27,0.27),exp= c("Intact in 1982 (E001)","Disturbed in 1982 (E002)"), ntrt2=c("None", "None"), expntrt=c("1_9" ,"2_9"), abclabel = factor(c("(a) ","(b) " ),levels = c("(c) ", "(d) ")))


####
mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))

PcOAdecade_fullN<-ggplot(data=PcoAplayingfirst2_fullN, aes(x=meanAxis1  , y=meanAxis2 , color=ntrt2)) +
  geom_hline(yintercept = 0)+geom_vline(xintercept = 0)+
  geom_point(data=PCOAandplots198219922004_fullN, aes(x=meanAxis1  , y=meanAxis2 , group=ntrt2, shape=as.factor(year)), size=2)+
    geom_errorbar(data=PCOAandplots198219922004_fullN, aes(ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2,color=ntrt2), size=0.25) +
  geom_errorbarh(data=PCOAandplots198219922004_fullN, aes(xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1,color=ntrt2),  size=0.25) +
  geom_point(data=PCOAandplots198219922004_fullN, aes(x=meanAxis1  , y=meanAxis2 , group=ntrt2,color=ntrt2,shape=as.factor(year)))+
  geom_segment(data=wide_PcoAplaying1, aes(x=`1982`  , y=`1982`, xend =`1992`, yend = `1992`, color=ntrt2), arrow=arrow(length=unit(0.0, "cm"))) +
    geom_path(size=0.75, arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))+
      geom_segment(data=wide_PcoAplaying1, aes(x=`1992`  , y=`1992`, xend =`2004`, yend = `2004`, color=ntrt2), arrow=arrow(length=unit(0.0, "cm"))) +
    geom_path(size=0.75, arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")))+
          
    #ylab("PCoA 2")+
    ylab(expression(atop("", paste("PCoA 2"))))+
    xlab("PCoA 1")+
    facet_grid(~disk) + 
    #xlim(-0.330,0.500)+
    #ylim(-0.500,0.180)+
      mytheme+
    scale_shape_manual(values = c(21, 22, 24))+
      theme(strip.background = element_blank())+
      geom_text(aes(x = -0.31, y = 0.18, label = abclabel, group =     abclabel),size = 4, color= "black", check_overlap = T)+theme(strip.text = element_blank())+scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+theme(legend.position="none")+scale_y_continuous(limits=c(-0.5, 0.18), labels = scales::number_format(accuracy = 0.05))+scale_x_continuous(limits=c(-0.33, 0.5), labels = scales::number_format(accuracy = 0.05))+geom_text(data=PCOAandplotslabels_fullN, aes(label=yearlabel),position = position_nudge(y = -0.04, x=0.05), color="#000004", size=3.0)


```


```{r - recreate supplemental fig PCOA species scores}


###PCOA species scores using biodiversity package###


head(spscores_df)

spscores_df$species<-spscores_df$names

### pull out max and min species for each axis##


spscores_dfsubset<-subset(spscores_df, Dim1>0.1|Dim1< (-0.22)|Dim2>0.1|Dim2<(-0.29))


##merge with functional group information##

specieslookup<-da_full %>% distinct(species, .keep_all = TRUE)

specieslookup2<-specieslookup %>% dplyr::select(species,functional.group,duration,lifeform, pathway, origin)


mergedfuncgroupspscores <- (merge(specieslookup2,spscores_dfsubset, by = 'species', sort=FALSE, all.y=TRUE))


####
mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))


speciesPCOAplot <- ggplot() + 
    geom_segment(data=mergedfuncgroupspscores , 
                 aes(x=0, y=0, xend=Dim1*2, yend=Dim2*2, group=functional.group),                  size=0.5, arrow=arrow()) +
    geom_text_repel(data=mergedfuncgroupspscores , 
                    aes(x=Dim1*2, y=Dim2*2, label=names, color=functional.group), nudge_y = -0.04)+mytheme+
   theme(legend.position="none")+
    ylab("PCoA 2")+
    xlab("PCoA 1")


```



###PCOA across years controls and field D ###

```{r - Conduct a PCoA just controls plots over time (log)}



head(da_fieldD_2 ) #long form field D##
da_fieldD_2$exp<-0

head(d3woody)  ##long form fields ABC##

#######

##just subset out control plots##
d3E001E002<-d3woody %>% filter(ntrt==9) %>% select(field, exp, plot, year, species, mass.above)


da_fieldD_3<-da_fieldD_2 %>% filter(ntrt==9)%>% select(field, exp, plot, year, species, mass.above)

fieldABCDE001E002<-rbind(da_fieldD_3, d3E001E002)

# Transpose data to be a site by species matrix
fieldABCD_wide <- reshape(fieldABCDE001E002,
                   v.names="mass.above",
                   idvar=c("field", "plot", "year"),
                   timevar="species",
                   direction="wide") 


fieldABCD_wide_sorted<-fieldABCD_wide%>%arrange(year)%>%arrange(plot)%>%arrange(field)%>%arrange(exp)

###count of plots###

##there should be 3 or 6 plots per field A, B, C to 2004, and 5 in field D ###########
plotcountcheck2<-fieldABCD_wide_sorted%>%group_by(exp, field, year) %>%  tally()



##subset to fewer years###

fieldABCD_wide_sorted_1982<-subset(fieldABCD_wide_sorted, year==1982)


##just the plot data field ABCD##
plotABCD1982<-fieldABCD_wide_sorted_1982%>% dplyr::select(field, exp, plot, year)


##just the veg data##

vegABCD1982<-fieldABCD_wide_sorted_1982[5:181]


# Fill in NA's with zeros in wide data set
vegABCD1982[is.na(vegABCD1982)] <- 0


vegmatrixABCD1982<-as.matrix(vegABCD1982)

logvegABCD1982<-log(1+vegmatrixABCD1982)


## Bray curtis dissimiliarty matrix##
distABCD1982<-vegdist(logvegABCD1982, method="bray")
BCdistABCD1982<-as.matrix(distABCD1982)  ##into a matrix#
BCdistABCDdf1982<-as.data.frame(BCdistABCD1982)  #into a dataframe#

BCdistABCDdf21982<-cbind(plotABCD1982,BCdistABCDdf1982) #merge plot data w/ dissim matrix##




##BCdistABCD2 has the plot info and the BC dissimilarity matrix for all the control plots from E001 ABC and field D ######

###PcOA fields ABCD####

PCOA_ABCD1982 <- cmdscale(BCdistABCD1982, eig=TRUE, add=FALSE) 


## extracting the axis scores for each exp##

PCOAaxes_ABCD1982<- PCOA_ABCD1982$points[,c(1,2)]


##merge the axis scores with the plot info...##

PCOAABCDandplots1982<-cbind(plotABCD1982, PCOAaxes_ABCD1982)

##rename columns##

names(PCOAABCDandplots1982)[5] <- "Axis.1"
names(PCOAABCDandplots1982)[6] <- "Axis.2"


PCOAABCDandplots1982$exp<-as.factor(as.character(PCOAABCDandplots1982$exp))
PCOAABCDandplots1982$field<-as.factor(PCOAABCDandplots1982$field)


```


```{r - Supp figure PCOA controls ABCD}


PCOA_ABCD_average1982<-PCOAABCDandplots1982 %>% group_by(exp, field) %>% dplyr::summarise(meanAxis1=mean(Axis.1, na.rm=TRUE),sdAxis1=sd(Axis.1, na.rm=TRUE),seAxis1=sd(Axis.1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(Axis.2, na.rm=TRUE),sdAxis2=sd(Axis.2, na.rm=TRUE),seAxis2=sd(Axis.2, na.rm=TRUE)/sqrt(n()), n=n())


PCOAABCDandplots1982$exp<-mapvalues(PCOAABCDandplots1982$exp, from=c("0", "1", "2"), to=c("Remnant", "Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


PCOAABCDandplots1982$exp<- factor(PCOAABCDandplots1982$exp, levels = c("Remnant", "Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

PCOAABCDandplots1982$field<-mapvalues(PCOAABCDandplots1982$field, from=c("A", "B", "C", "D"), to=c("A (Last farmed 1968)", "B (Last farmed 1957)", "C (Last farmed in 1934)", "D (Never farmed)"))


###change avg too###

PCOA_ABCD_average1982$exp<-mapvalues(PCOA_ABCD_average1982$exp, from=c("0", "1", "2"), to=c("Remnant", "Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

PCOA_ABCD_average1982$exp<- factor(PCOA_ABCD_average1982$exp, levels = c("Remnant", "Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


PCOA_ABCD_average1982$field<-mapvalues(PCOA_ABCD_average1982$field, from=c("A", "B", "C", "D"), to=c("A (Last farmed 1968)", "B (Last farmed 1957)", "C (Last farmed in 1934)", "D (Never farmed)"))



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())


PCOA_ABCD_averageplot1982<-ggplot() +
  geom_point(data=PCOAABCDandplots1982, aes(x=Axis.1, Axis.2 , color=field, shape=as.factor(exp)), size=1.5)+
    geom_point(data=PCOA_ABCD_average1982, aes(x=meanAxis1, y=meanAxis2 , color=field, shape=as.factor(exp)), size=5) +
       geom_errorbar(data=PCOA_ABCD_average1982, aes(x= meanAxis1, ymin=meanAxis2-seAxis2, ymax=meanAxis2+seAxis2), color="gray45", size=0.25) +
  geom_errorbarh(data=PCOA_ABCD_average1982, aes(y = meanAxis2, xmin=meanAxis1-seAxis1, xmax=meanAxis1+seAxis1), color="gray45", size=0.25) +
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    mytheme





```


###DISPERSION####

###DISPERSION WITHIN ALL N TREATMENTS###
```{r - Calculate the distance TO centroid within ntrt treatments all treatments (log data)}


###need to have the most recent verion of vegan from github for this to work##
#https://github.com/vegandevs/vegan/issues/331#


#######################

####All nutrient treatments....####

exp12subset<-subset(da.wide5,year<2005)

##get rid of years not all fields were sampeled###

#exp12subset_full<-exp12subset%>%filter(year!=1995)%>%filter(year!=1998)%>%filter(year!=2001)%>%filter(year!=2003)

##just the veg data##

veg_full<-exp12subset%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)



###log transformation####

vegmatrixfull<-as.matrix(veg_full)

logvegfull<-log(1+vegmatrixfull)



##using the apply function to calculation the dispersion (beta disp) for each nutrient treatment for each year#

bd_allbothfull<-betadisper(vegdist(logvegfull),exp12subset$expntrtyear, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a bit##

#bd_allbothEUC<-betadisper(vegdist(logveg, method="euclidean"),exp12subset_2$expntrtyear, type = "centroid")    ##same thing but in Euclidean distance###

##some squared distances are negative and changed to zero##


######making group distances into a dataframe with rownames###

bd_allbothfull_2<-as.data.frame(bd_allbothfull$group.distances, row.names = rownames(bd_allbothfull$group.distances))

setDT(bd_allbothfull_2, keep.rownames = TRUE)[]


bd_allbothfull_df<-separate(data = bd_allbothfull_2, col = rn, into = c("exp", "ntrt", "year"))

bd_allbothfull_df$year<-as.numeric(bd_allbothfull_df$year)
bd_allbothfull_df$ntrt<-as.factor(bd_allbothfull_df$ntrt)

bd_allbothfull_df$distances<-as.numeric(bd_allbothfull_df$`bd_allbothfull$group.distances`)

bd_allbothfull_df2<-bd_allbothfull_df%>%mutate(ntrt2 = ntrt)%>%mutate(year2 = year-1981)

###this dataframe (bd_allboth_fulldf2) has the average distance to the centroid for each disurbance_nutrient group for each year. Distances = the average Bray dist for 18 plots to their group centroids (what is plotted in Fig 3 a) ##

## INCLUDES ALL NUTRIENT GROUPS###



```

```{r - AIC table dist TO centroid, TABLE S1 }

####test whether the distance to centroid is best fit by a linear or saturating function##


head(bd_allbothfull_df2)

bd_allbothfull_df2<-bd_allbothfull_df2%>% mutate (year2=year-1981)


##null##

nulllin<-lm(distances~1, data=bd_allbothfull_df2)


###linear fit###

distlin<-lm(distances~year2, data=bd_allbothfull_df2)


##saturating function##
distnonlin<- nls(distances~ SSasymp(year2, Asym, R0, lrc), data = bd_allbothfull_df2)


###quadratic function###

distquad<-lm(distances~year2+I(year2^2), data=bd_allbothfull_df2)



rawaic<-AIC(nulllin, distlin, distnonlin, distquad)
nR<-dim(bd_allbothfull_df2)[1]  #Sample size 
aictable(rawaic,nR)

###QUADRACTIC is the best fit (now that we have the highest nutrient treatments###

```

```{r - model fits and error dist TO centroid quadratic, TABLE S2}


head(bd_allbothfull_df2)

bd_allbothfull_df2<-bd_allbothfull_df2%>% mutate (year2=year-1981) %>% mutate(expntrt= paste(exp,ntrt, sep = '_'))



####
quadraticfits <- lmList(distances ~ year2+ I(year2^2) | expntrt, data=bd_allbothfull_df2)

quadraticfits_df <- data.frame(Subject=rownames(coef(fm1)),coef(fm1),check.names=FALSE)




```


### PLOT DISPERSION WITHIN ALL N TREATMENTS###
```{r - recreate FIG 3ab, w/ ALL nutrient treatments (log data)}


head(bd_allbothfull_df2)


bd_allbothfull_df2<-bd_allbothfull_df2 %>% mutate(abclabel=exp)


bd_allbothfull_df2$abclabel<-mapvalues(bd_allbothfull_df2$abclabel, from=c("1", "2"), to=c("(a)", "(b)"))



##### plot specifications###

bd_allbothfull_df2$exp<-mapvalues(bd_allbothfull_df2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

bd_allbothfull_df2$exp<- factor(bd_allbothfull_df2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



bd_allbothfull_df2$ntrt2  <- mapvalues(bd_allbothfull_df2$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

bd_allbothfull_df2$ntrt2 <- factor(bd_allbothfull_df2$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))


##just take out control for figure###


bd_allbothfull_control=subset(bd_allbothfull_df2, ntrt==9)



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))




disttocentroidplot<- ggplot(bd_allbothfull_df2, aes(x=year2, y=distances, group=ntrt2, color=ntrt2)) +
    geom_point() +
    facet_grid(~exp)+ 
    ylab(expression('Average distance to nutrient centroid'))+
    xlab("Time since experiment")+
    stat_smooth(method = "lm", formula = y ~ x + I(x^2), size = 0.5, se=FALSE)+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
    scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+
   stat_smooth(data=bd_allbothfull_control,aes(x=year2, y=distances), method = "lm", formula = y ~ x + I(x^2), size = 0.5)+ guides(color=guide_legend(override.aes=list(fill=NA)))+ geom_text(aes(x = 2, y = 0.6, label = abclabel, group = abclabel),size = 4, color= "black", check_overlap = T)
    

```


###Takes a long time ###
###DISPERSION WITHIN ALL N TREATMENTS AND BY FIELD ###
```{r - Calculate the distance TO centroid within ntrt treatments all treatments (log data)}


###need to have the most recent verion of vegan from github for this to work##
#https://github.com/vegandevs/vegan/issues/331#

##Used the datasubsetted to before 2004 ##

head(da.wide5)

####All nutrient treatments....####

exp12subset<-subset(da.wide5,year<2005)


##plot data##
plot_full<-exp12subset%>%dplyr::select(field:expntrtyear) %>% mutate(expfieldplotyear= paste(exp,field,plot,year, sep = '_'))

##just the veg data##

veg_full<-exp12subset%>% dplyr::select(`mass.above.ACER NEGUNDO` :`mass.above.VIOLA SP.`)



###log transformation####

vegmatrixfull<-as.matrix(veg_full)

logvegfull<-log(1+vegmatrixfull)



##using the apply function to calculation the dispersion (beta disp) for each nutrient treatment for each FIELD for each year#

bd_allbyfield<-betadisper(vegdist(logvegfull),plot_full$expntrtfieldyear, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a VERY LONG TIME ##

#bd_allbothEUC<-betadisper(vegdist(logveg, method="euclidean"),exp12subset_2$expntrtyear, type = "centroid")    ##same thing but in Euclidean distance###

##some squared distances are negative and changed to zero##


######making group distances into a dataframe with rownames###


bd_allbyfield_2<-as.data.frame(bd_allbyfield$group.distances, row.names = rownames(bd_allbyfield$group.distances))

setDT(bd_allbyfield_2, keep.rownames = TRUE)[]


bd_allbyfield_2_df<-separate(data = bd_allbyfield_2, col = rn, into = c("exp", "field", "ntrt", "year"))

bd_allbyfield_2_df$year<-as.numeric(bd_allbyfield_2_df$year)
bd_allbyfield_2_df$ntrt<-as.factor(bd_allbyfield_2_df$ntrt)

bd_allbyfield_2_df$distances<-as.numeric(bd_allbyfield_2_df$`bd_allbyfield$group.distances`)

###this dataframe (bd_allbyfield_2_df) has the average distance to the centroid for each disurbance_nutrient group in each field for each year. Distances = the average Bray dist for 6 plots to their group centroids (what is plotted in Fig 3 a) ##

## INCLUDES ALL NUTRIENT GROUPS BY FIELD###



```


###PLOT DISPERSION WITHIN ALL N TREATMENTS BY FIELD ###
```{r - recreate supplemental fig, w/ ALL nutrient treatments BY FIELD (log data)}



bd_allbyfield_2_df<-bd_allbyfield_2_df %>% mutate(abclabel=exp)%>% mutate(ntrt2=ntrt)%>% mutate(year2=year-1981)

bd_allbyfield_2_df$abclabel<-mapvalues(bd_allbyfield_2_df$abclabel, from=c("1", "2"), to=c("(a)", "(b)"))

##### plot specifications###

bd_allbyfield_2_df$exp<-mapvalues(bd_allbyfield_2_df$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

bd_allbyfield_2_df$exp<- factor(bd_allbyfield_2_df$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



bd_allbyfield_2_df$ntrt2  <- mapvalues(bd_allbyfield_2_df$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

bd_allbyfield_2_df$ntrt2 <- factor(bd_allbyfield_2_df$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))


bd_allbyfield_2_df$field  <- mapvalues(bd_allbyfield_2_df$field, from=c("A", "B", "C"),
                               to=c("Field A", "Field B", "Field C"))


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))


disttocentroidplotBYFIELD<- ggplot(bd_allbyfield_2_df, aes(x=year2, y=distances, group=ntrt2, color=ntrt2)) +
  geom_smooth(method="lm", se=FALSE, size=0.5) +
   geom_point()  + 
  facet_grid(vars(field), vars(exp))+ 
    ylab(expression('Average distance to nutrient group centroid'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
    scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+scale_y_continuous(breaks=c(0.1, 0.2, 0.3, 0.4))



disttocentroidplotBYFIELDloess<- ggplot(bd_allbyfield_2_df, aes(x=year2, y=distances, group=ntrt2, color=ntrt2)) +
       geom_smooth(method="loess", se=FALSE, size=0.5) +
  geom_point()  + 
  facet_grid(vars(field), vars(exp))+ 
    ylab(expression('Average distance to nutrient group centroid'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
    scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+scale_y_continuous(breaks=c(0.1, 0.2, 0.3, 0.4))




pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/distnutcentroidsfield.pdf", width = 7, height = 6)
disttocentroidplotBYFIELD
dev.off()



pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/distnutcentroidsfieldloess.pdf", width = 7, height = 6)
disttocentroidplotBYFIELDloess
dev.off()


```


##let's see whats going on with E001 field C compared to B...###

```{r - Exploring E001 field C (versus field B) }

##PCOAandplotsboth_fullN###

head(PCOAandplotsboth_fullN)

head(bd_allbyfield_2_df)


#### just pull out E001 field B and C subset of years: 1982, 1992, 2004 ####


PCOAandplotsE001ABsubset<-PCOAandplotsboth_fullN %>% filter(exp==1)%>% filter(field=="B"|field=="C")%>% filter(year=="1982"|year=="1994"|year=="2004")


groupcentroidssubset<- bd_allbyfield_2_df%>% filter(exp=="Intact in 1982 (E001)")%>% filter(field=="B"|field=="C")%>% filter(year==1982|year==1994|year==2004)


#getting the convex hull of each unique point set
hull <- PCOAandplotsE001ABsubset %>% group_by(field, ntrt,year) %>% 
  slice(chull(Axis.1,Axis.2))


E001fieldBandC<-ggplot(PCOAandplotsE001ABsubset, aes(x=Axis.1, y=Axis.2, color=ntrt, fill=ntrt)) +
    geom_point() +
    geom_polygon(data = hull, alpha = 0.5)+
    ylab("PCoA 2")+
    xlab("PCoA 1")+
    mytheme+
    facet_grid(vars(year), vars(field))+ 
    theme(strip.background = element_blank())+
    theme(strip.text = element_text(face="bold", size=10))+
    theme(panel.spacing.y=unit(0.5, "lines"))
    #geom_text_repel(aes(label=yearlabel),size = 2.5, color="black")




```



######## DISTANCE BETWEEN CENTROIDS ALL N ###

###DISPERSION BTWN N TREATMENTS###
```{r - Calculate the distance BETWEEM centroids all ntrt treatments all treatments (log data)}


bd_allbothfull_df2<-bd_allbothfull_df%>%mutate(ntrt2 = ntrt)


##pulling out the group centroids by year####

centroiddf_full<-as.data.frame(bd_allbothfull[["centroids"]])

centroiddf_full_2<-centroiddf_full[,1:2]

centroiddf_full_2<- tibble::rownames_to_column(centroiddf_full_2, "expntrtyear")

centroiddf_full_2<-separate(data = centroiddf_full_2, col = expntrtyear, into = c("exp", "ntrt", "year"))

centroiddf_full_3<-centroiddf_full_2%>% mutate(expyear= paste(exp,year, sep = '_')) 


###grand mean centroid for all treatments each year###

grandcentroid_full<-centroiddf_full_3%>% group_by(exp, year) %>% dplyr::summarise(PcoA1centroid=mean(PCoA1, na.rm=TRUE),PcoA2centroid=mean(PCoA2, na.rm=TRUE))%>% mutate(expyear= paste(exp,year, sep = '_')) 


### merge the treatments means with the grand mean centroid for each year##

centroiddf_full<-merge(data.frame(centroiddf_full_3), data.frame(grandcentroid_full), by = "expyear", all = TRUE)

###calculate the distance from each centroid to grand centroid using pythagoreum theorem###

centroiddf_full_4<-centroiddf_full %>% mutate(distgrandcent=sqrt((PcoA1centroid- PCoA1)^2+(PcoA2centroid-PCoA2)^2))


###average distance of each group to its grand mean##

centroiddists_full<-centroiddf_full_4%>% group_by(expyear) %>% dplyr::summarise(meandist=mean(distgrandcent, na.rm=TRUE))%>%separate(col = expyear, into = c("exp", "year"))







```

```{r - AIC table dist BTWN centroid, TABLE S3 }


centroiddists_full2<-centroiddists_full%>% mutate (year2=as.numeric(as.character(year))-1981)

##null##
distnull<-lm(meandist~1, data=centroiddists_full2)



###linear fit###

distbtwnlin<-lm(meandist~year2, data=centroiddists_full2)


##saturating function##
distbtwnnonlin<- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists_full2)

##quadratic##


distbtwnquad<-lm(meandist~year2+I(year2^2), data=centroiddists_full2)


rawaic<-AIC(distnull, distbtwnlin, distbtwnnonlin,distbtwnquad)
nR<-dim(bd_allboth_df2)[1]  #Sample size 
aictable(rawaic,nR)

###Nonlinear is the best fit###

```

```{r - recreate FIG 3 cd, distance BTWN centroids all ntrt treatmetns (logdata)}

centroiddists_full$year<-as.numeric(as.character(centroiddists_full$year))

centroiddists_full_2<-centroiddists_full%>% mutate(year2=year-1981)%>%mutate(abclabel=exp)



centroiddists_full_2$abclabel<-mapvalues(centroiddists_full_2$abclabel, from=c("1", "2"), to=c("(c)", "(d)"))

####subset by exp###

centroiddists_full_E001<-subset(centroiddists_full_2, exp==1)
centroiddists_full_E002<-subset(centroiddists_full_2, exp==2)




###https://www.r-bloggers.com/2021/07/asymptotic-confidence-intervals-for-nls-regression-in-r/##

asympfitcentroidE001_full<- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists_full_E001)

asympfitcentroidE002_full <- nls(meandist~ SSasymp(year2, Asym, R0, lrc), data = centroiddists_full_E002)



###confidence intervals around fit###


new.dataE001 <- data.frame(year2=centroiddists_full_E001$year2)
new.dataE002 <- data.frame(year2=centroiddists_full_E002$year2)


confE001_centroid <- as_tibble(predFit(asympfitcentroidE001_full, newdata = new.dataE001, interval = "confidence", level= 0.95)) %>% mutate(year2 = new.dataE001$year2)

confE001_centroiddf<-as.data.frame(confE001_centroid)

confE001_centroiddf2<-cbind(centroiddists_full_E001, confE001_centroiddf)


confE002_centroid <- as_tibble(predFit(asympfitcentroidE002_full, newdata = new.dataE002, interval = "confidence", level= 0.95)) %>% mutate(year2 = new.dataE002$year2)


confE002_centroiddf<-as.data.frame(confE002_centroid)

confE002_centroiddf2<-cbind(centroiddists_full_E002, confE002_centroiddf)


      ##combine togeter and add abc label##
confcentroidboth<-rbind(confE001_centroiddf2, confE002_centroiddf2)

confcentroidboth<-confcentroidboth[,1:8]


###for plotting####


centroiddists_full_2$exp<-mapvalues(centroiddists_full_2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddists_full_2$exp<- factor(centroiddists_full_2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

confcentroidboth$exp<-mapvalues(confcentroidboth$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

confcentroidboth$exp <- factor(centroiddists_full_2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

distbetweencentroids_fullN<-ggplot(data=centroiddists_full_2,aes(x=as.numeric(as.character(year2)),y=meandist)) +
    geom_point() +
    facet_grid(~exp) +
    ylab(expression('Average distance between nutrient centroids'))+
    xlab("Time since experiment (years)")+
     geom_smooth(method="nls", formula=y~SSasymp(x, Asym, R0, lrc), colour = "black", size = 0.5, se=F, fullrange=T)+
  geom_ribbon(data=confcentroidboth, aes(ymin=lwr, ymax=upr), color=NA, fill = "gray1", alpha=0.2)+
      mytheme+
    theme(legend.position="none")+
     theme(strip.text = element_blank())+
     theme(strip.background = element_blank())+
    mytheme+ geom_text(aes(x = 2, y = 0.22, label = abclabel, group = abclabel),size = 4, color= "black", check_overlap = T)+theme(strip.text = element_blank())
 
  



```



######## DISTANCE BETWEEN CENTROIDS ALL N and BY FIELD###

```{r - recreate supplemental figure, distance BTWN centroids BY FIELD (logdata)}


##pulling out the group centroids by year####

centroidbyfield<-as.data.frame(bd_allbyfield[["centroids"]])

centroiddfbyfield_2<-centroidbyfield[,1:2]

centroiddfbyfield_2<- tibble::rownames_to_column(centroiddfbyfield_2, "expfieldntrtyear")

centroiddfbyfield_2<-separate(data = centroiddfbyfield_2, col = expfieldntrtyear, into = c("exp", "field", "ntrt", "year"))

centroiddfbyfield_3<-centroiddfbyfield_2%>% mutate(expfieldyear= paste(exp,field,year, sep = '_')) 
####



###grand mean centroid for all fields and treatments each year###

grandcentroidbyfield_full<-centroiddfbyfield_3%>% group_by(exp, field,year) %>% dplyr::summarise(PcoA1centroid=mean(PCoA1, na.rm=TRUE),PcoA2centroid=mean(PCoA2, na.rm=TRUE))%>% mutate(expfieldyear= paste(exp,field,year, sep = '_')) 


### merge the treatments means with the grand mean centroid for each year##

centroiddfbyfield_full<-merge(data.frame(centroiddfbyfield_3), data.frame(grandcentroidbyfield_full), by = "expfieldyear", all = TRUE)

###calculate the distance from each centroid to grand centroid using pythagoreum theorem###

centroiddfbyfield_full_4<-centroiddfbyfield_full %>% mutate(distgrandcent=sqrt((PcoA1centroid- PCoA1)^2+(PcoA2centroid-PCoA2)^2))


###average distance of each group to its grand mean##

centroiddistsbyfield_full<-centroiddfbyfield_full_4%>% group_by(expfieldyear) %>% dplyr::summarise(meandist=mean(distgrandcent, na.rm=TRUE))%>%separate(col = expfieldyear, into = c("exp","field", "year"))



centroiddistsbyfield_full$exp<-mapvalues(centroiddistsbyfield_full$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddistsbyfield_full$exp<- factor(centroiddistsbyfield_full$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddistsbyfield_full_2<-centroiddistsbyfield_full%>% mutate(year2=as.numeric(year)-1981)


centroiddistsbyfield_full_2$field  <- mapvalues(centroiddistsbyfield_full_2$field, from=c("A", "B", "C"),
                               to=c("Field A", "Field B", "Field C"))

distbetweencentroidsbyfield_fullN<-ggplot(data=centroiddistsbyfield_full_2,aes(x=as.numeric(as.character(year2)),y=meandist)) +
    geom_point() +
    facet_grid(vars(field), vars(exp))+ 
    ylab(expression('Average distance between nutrient group centroids'))+
    xlab("Time since experiment (years)")+
    geom_smooth(method="loess", colour = "black", size = 0.5, se=F, fullrange=T)+
    theme(legend.position="none")+
   mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())



pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/distBTWNnutcentroidsfield.pdf", width = 6, height = 5)
distbetweencentroidsbyfield_fullN
dev.off()



```




###DISPERSION BTWN E001 and E002 by nutrients TREATMENTS###
```{r - Calculate the distance BETWEEN E001 and E002 centroids all ntrt treatments (log data)}


bd_allbothfull_df2<-bd_allbothfull_df%>%mutate(ntrt2 = ntrt)


##pulling out the group centroids by year####

centroiddf_full<-as.data.frame(bd_allbothfull[["centroids"]])

centroiddf_full_2<-centroiddf_full[,1:2]

centroiddf_full_2<- tibble::rownames_to_column(centroiddf_full_2, "expntrtyear")

centroiddf_full_2<-separate(data = centroiddf_full_2, col = expntrtyear, into = c("exp", "ntrt", "year"))

centroiddf_full_3<-centroiddf_full_2%>% mutate(ntrtyear= paste(ntrt,year, sep = '_')) 



###grand mean centroid E001 and E002 for all treatments each year###

grandcentroid_full_e001e002<-centroiddf_full_3%>% group_by(ntrt, year) %>% dplyr::summarise(PcoA1centroid=mean(PCoA1, na.rm=TRUE),PcoA2centroid=mean(PCoA2, na.rm=TRUE)) %>% mutate(ntrtyear= paste(ntrt,year, sep = '_'))


### merge the treatments means with the grand mean centroid for each year##

centroiddf_full_e001e002<-merge(data.frame(centroiddf_full_3), data.frame(grandcentroid_full_e001e002), by = "ntrtyear", all = TRUE)



###calculate the distance from each centroid to grand centroid using pythagoreum theorem###

centroiddf_full_4_e001e002<-centroiddf_full_e001e002 %>% mutate(distgrandcent=sqrt((PcoA1centroid- PCoA1)^2+(PcoA2centroid-PCoA2)^2))


###average distance of each group to its grand mean##

centroiddists_full_e001e002<-centroiddf_full_4_e001e002%>% group_by(ntrtyear) %>% dplyr::summarise(meandist=mean(distgrandcent, na.rm=TRUE))%>%separate(col = ntrtyear, into = c("ntrt", "year"))


```



```{r - recreate supplemental figure, distance BTWN E001 and E002 centroids (logdata)}


head(centroiddists_full_e001e002)

centroiddists_e001e002<-as.data.frame(centroiddists_full_e001e002)


centroiddists_e001e002_2<- centroiddists_e001e002 %>% mutate(year2=as.numeric(year)-1981)%>% mutate(ntrt2=ntrt)



centroiddists_e001e002_2$ntrt2  <- mapvalues(centroiddists_e001e002_2$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

centroiddists_e001e002_2$ntrt2 <- factor(centroiddists_e001e002_2$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))




distbetweencentroidse001e002<-ggplot(data=centroiddists_e001e002_2,aes(x=year2 ,y=meandist, group=ntrt2, color=ntrt2)) +
    geom_point() +
    ylab(expression('Average distance between \n disturbance group centroids'))+
    xlab("Time since experiment (years)")+
    geom_smooth(method="loess", size = 0.5, se=F, fullrange=T)+  mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank()) + scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+theme(plot.margin = margin(10, 10, 10, 30))


pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/distbetweencentroidse001e002.pdf", width = 5, height = 3)
distbetweencentroidse001e002
dev.off()

```


#### DISPERSION BETWEEN E001 and E002 by FIELD all ntrts together####
```{r - dispersion E001 and E002 by field (logdata)}

##START W/ DATA SET subsetted to 2004 to compare E001 and E002 ##

##subset to years before 2005 for BOTH E001 and E002 ## (bc of change in fire regime)

da.wide5$year<-as.numeric(as.character(da.wide5$year)) 

exp12subset<-subset(da.wide5,year<2005)


##just the veg data##

veg_full<-exp12subset%>% dplyr::select(`mass.above.ACER NEGUNDO` :`mass.above.VIOLA SP.`)


###log transformation####

vegmatrixfull<-as.matrix(veg_full)

logvegfull<-log(1+vegmatrixfull)



#### add on a exp field year column###


exp12subset_111 <- exp12subset %>%  mutate(expfieldyear= paste(exp, field, year, sep = '_'))

##using the apply function to calculation the dispersion (beta disp) for each nutrient treatment for each FIELD for each year#

bd_E001E002byfield<-betadisper(vegdist(logvegfull),exp12subset_111$expfieldyear, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a minute ##


##some squared distances are negative and changed to zero##


######making group distances into a dataframe with rownames###


bd_E001E002byfield_2<-as.data.frame(bd_E001E002byfield$group.distances, row.names = rownames(bd_E001E002byfield$group.distances))

setDT(bd_E001E002byfield_2, keep.rownames = TRUE)[]


bd_E001E002byfield_2_df<-separate(data = bd_E001E002byfield_2, col = rn, into = c("exp", "field", "year"))

bd_E001E002byfield_2_df$year<-as.numeric(bd_E001E002byfield_2_df$year)

bd_E001E002byfield_2_df$distances<-as.numeric(bd_E001E002byfield_2_df$`bd_E001E002byfield$group.distances`)

bd_E001E002byfield_2_df<-bd_E001E002byfield_2_df%>% mutate(year2=year-1981)

###this dataframe (bd_E001E002byfield_2_df) has the average distance to the centroid for each field in each year to its E001 or E002 group centroid. Distances = the average Bray dist for ALL 54 plots to their group centroids  ##



##pulling out the group centroids by year####

centroidE001E002df<-as.data.frame(bd_E001E002byfield[["centroids"]])

centroidE001E002df_2<-centroidE001E002df[,1:2]

centroidE001E002df_2 <- tibble::rownames_to_column(centroidE001E002df_2, "expfieldyear")

centroidE001E002df_2<-separate(data = centroidE001E002df_2, col = expfieldyear, into = c("exp", "field", "year"))

centroidE001E002df_2<-centroidE001E002df_2 %>%   mutate(fieldyear= paste(field, year, sep = '_')) %>% select(exp, field, year, fieldyear, PCoA1, PCoA2)
###

###calculate distance between E001 and E002 centroids###

centroidE001<-subset(centroidE001E002df_2, exp==1) #dim = 69 X 6 ##

centroidE002<-subset(centroidE001E002df_2, exp==2) #dim = 58 X 6 ##   ### three missing in E002####

##merge them...dropping the ones in E001 that we don't have E002 for####

mergedcentroids<-merge(centroidE002, centroidE001, by = "fieldyear", all.x = TRUE)

#use pythag theorem to get distance between E001 and E002 centroids###

mergedcentroids_dist<-mergedcentroids %>% mutate(distcentroids=sqrt((PCoA1.y - PCoA1.x)^2+(PCoA2.y-PCoA2.x)^2))


```


#### PLOT DISPERSION BETWEEN E001 and E002 by FIELD####
```{r - plot dispersion E001 and E002 by field }

mergedcentroids_dist_2 <-mergedcentroids_dist%>% mutate(year2=as.numeric(year.x)-1981)

## for plotting##

mergedcentroids_dist_2$field.x<-mapvalues(mergedcentroids_dist_2$field.x, from=c("A", "B", "C"), to=c("Field A", "Field B", "Field C"))

distE001E002BYFIELD<- ggplot(mergedcentroids_dist_2, aes(x=year2, y=distcentroids)) +
    geom_point()  +
   geom_smooth(method="nls", formula=y~SSasymp(x, Asym, R0, lrc), colour = "black", size = 0.5, se=F, fullrange=T)+
   facet_wrap(~field.x)+ 
    ylab(expression('Average distance between \n disturbace group centroids'))+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.position="right")+
    theme(legend.title = element_blank()) + 
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
    theme(plot.margin = margin(10, 10, 10, 30))


pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/distE001E002BYFIELD.pdf", width = 5, height = 3)
distE001E002BYFIELD
dev.off()


```



###SINOUSITY USING TRAJECTORY DIRECTIONALITY ####
```{r - calculate traj directionality (log data)}

##START W/ the DISTANCE MATRIX instead of PCOA points ### 

head(BCdistalldf2)


##make each field, experiment, plot, its own combo###
plotE001E002<-BCdistalldf2 %>% select(field, exp, plot, subplot, year, disk, ntrt, expntrtyear)%>% mutate(fieldexpplot= paste(field, exp,plot, sep = '_'))

##
plotE001E002_2<-distinct(plotE001E002, fieldexpplot, .keep_all=TRUE)


trajdirection<-trajectoryDirectionality(BCdistall, plotE001E002$fieldexpplot, plotE001E002$year)


trajdirectdf<-cbind(plotE001E002_2, trajdirection)


##mean directionality for each exp_ntrt ###

trajdiravg<-trajdirectdf%>% group_by(exp, ntrt) %>% dplyr::summarise(trajdiravg=mean(trajdirection, na.rm=TRUE),sdtrajdir=sd(trajdirection, na.rm=TRUE),setrajdir=sd(trajdirection, na.rm=TRUE)/sqrt(n()), uprconfint=trajdiravg+(1.96*setrajdir),lwrconfint=trajdiravg-(1.96*setrajdir), n=n())


```


```{r - recreate FIGURE 4ab Directionality}

##for plotting###
trajdiravg2<-trajdiravg %>% mutate(ntrt2=ntrt)


trajdiravg2$ntrt2  <- mapvalues(trajdiravg2$ntrt2, from=c("0", "9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("Never", "None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

trajdiravg2$ntrt2 <- factor(trajdiravg2$ntrt2, levels = c("Never", "None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))


trajdiravg2$exp<-mapvalues(trajdiravg2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

trajdiravg2$exp<- factor(trajdiravg2$exp, levels = c("Remnant", "Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

trajdiravg2<-trajdiravg2 %>% mutate(abclabel=if_else(exp=="Intact in 1982 (E001)", "(a)", "(b)"))


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=8, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))


directionalityplot<- ggplot(data=trajdiravg2, aes(x=ntrt2, y=trajdiravg, group=ntrt2, color=ntrt2)) +
    geom_point(size=2) +
    geom_errorbar(aes(ymin=lwrconfint, ymax=uprconfint), size=1)+
    facet_grid(~exp, scales = "free_x")+ 
    xlab("")+
    ylab(expression(atop("Average directionality", paste("(1982 - 2004)"))))+
    mytheme+
    theme(legend.position="none")+
    theme(legend.title = element_blank()) + 
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
     theme(axis.text.x = element_text(angle = 25,vjust = 0.5))+
    theme(strip.text = element_text(face="bold"))+
     theme(strip.background = element_blank())+
   theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+scale_y_continuous(labels = scales::number_format(accuracy = 0.005))+geom_text(aes(x = 0.8, y = 0.49, label = abclabel, group =     abclabel),size = 4, color= "black", check_overlap = T)



```


## plot trajectory directionality###
```{r - recreate FIG 4 abcd}

g222 <- ggplotGrob(PcOAdecade_fullN)
g111 <- ggplotGrob(directionalityplot)

grid::grid.newpage()
grid::grid.draw(rbind(g111, g222))

pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/angledirectionality4panel.pdf", width = 7, height = 7)
grid::grid.draw(rbind(g111, g222))
dev.off()




```

```{r -directionality by decade}


##arrange the dataframe so that that columns and rows are in right order##
exp12subsetsorted<-exp12subset%>%arrange(year)%>%arrange(plot)%>%arrange(field)%>%arrange(exp)


exp12subsetsorted$year<-as.numeric(as.character(exp12subsetsorted$year))

##just the plot data##
plotfirstdecade<-exp12subsetsorted%>% dplyr::select('field':'ntrt2') %>% filter(year<=1992)

plotseconddecade<-exp12subsetsorted%>% dplyr::select('field':'ntrt2') %>% filter(year>1992)


##just the veg data##

vegfirstdecade<-exp12subsetsorted%>% filter(year<=1992)%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)

vegseconddecade<-exp12subsetsorted%>% filter(year>1992)%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)


###log transformation####

vegmatrixfirst<-as.matrix(vegfirstdecade)

logvegfirst<-log(1+vegmatrixfirst)


vegmatrixsecond<-as.matrix(vegseconddecade)

logvegsecond<-log(1+vegmatrixsecond)


## Bray curtis dissimiliarty matrix for each decade##
distE1andE2first<-vegdist(logvegfirst, method="bray")
BCdistallfirst<-as.matrix(distE1andE2first)  ##into a matrix#
BCdistalldffirst<-as.data.frame(BCdistallfirst)  #into a dataframe#

BCdistalldffirst2<-cbind(plotfirstdecade,BCdistalldffirst) #merge plot data w/ dissim matrix##


distE1andE2second<-vegdist(logvegsecond, method="bray")
BCdistallsecond<-as.matrix(distE1andE2second)  ##into a matrix#
BCdistalldfsecond<-as.data.frame(BCdistallsecond)  #into a dataframe#

BCdistalldfsecond2<-cbind(plotseconddecade,BCdistalldfsecond) #merge plot data w/ dissim matrix##




##make each field, experiment, plot, its own combo###
plotE001E002first<-BCdistalldffirst2%>% select(field, exp, plot, subplot, year, disk, ntrt, expntrtyear)%>% mutate(fieldexpplot= paste(field, exp,plot, sep = '_'))

plotE001E002first_2<-distinct(plotE001E002first, fieldexpplot, .keep_all=TRUE)

plotE001E002second<-BCdistalldfsecond2%>% select(field, exp, plot, subplot, year, disk, ntrt, expntrtyear)%>% mutate(fieldexpplot= paste(field, exp,plot, sep = '_'))

plotE001E002second_2<-distinct(plotE001E002second, fieldexpplot, .keep_all=TRUE)


#### traj direction on each decade ####

trajdirectionfirst<-trajectoryDirectionality(BCdistallfirst, plotE001E002first$fieldexpplot, plotE001E002first$year)

trajdirectionsecond<-trajectoryDirectionality(BCdistallsecond, plotE001E002second$fieldexpplot, plotE001E002second$year)

####

trajdirectdffirst<-cbind(plotE001E002first_2, trajdirect=trajdirectionfirst)

trajdirectdfsecond<-cbind(plotE001E002second_2, trajdirect=trajdirectionsecond)

###

### add column for decades###

trajdirectdffirst_2<-trajdirectdffirst %>% mutate(decade="1982-1992")

trajdirectdfsecond_2<-trajdirectdfsecond %>% mutate(decade="1993-2004")

##combine them together##
trajectoriesboth<-rbind(trajdirectdffirst_2, trajdirectdfsecond_2)

##mean traj direction for each exp_ntrt###

trajdirectavgbydecade<-trajectoriesboth%>% group_by(exp, ntrt, decade) %>% dplyr::summarise(trajdiravg=mean(trajdirect, na.rm=TRUE),sdtrajdir=sd(trajdirect, na.rm=TRUE),setrajdir=sd(trajdirect, na.rm=TRUE)/sqrt(n()), n=n())




```


## plot trajectory directionality BY DECADE (supplemental)###

```{r -plot directionality by decade}


trajdirectavgbydecade<-trajectoriesboth%>% group_by(exp, ntrt, decade) %>% dplyr::summarise(trajdiravg=mean(trajdirect, na.rm=TRUE),sdtrajdir=sd(trajdirect, na.rm=TRUE),setrajdir=sd(trajdirect, na.rm=TRUE)/sqrt(n()), n=n())




##for plotting###
trajdirectavgbydecade2<-trajdirectavgbydecade %>% mutate(ntrt2=ntrt)

## plot specifications

trajdirectavgbydecade2$ntrt2 <- mapvalues(trajdirectavgbydecade2$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

trajdirectavgbydecade2$ntrt2<- factor(trajdirectavgbydecade2$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

                                          

trajdirectavgbydecade2$exp<-mapvalues(trajdirectavgbydecade2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

trajdirectavgbydecade2$exp<- factor(trajdirectavgbydecade2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=8, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title.x=element_text(size=12))+theme(axis.title.y=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))



trajdirplotbydecade<- ggplot(data=trajdirectavgbydecade2, aes(x=ntrt2, y=trajdiravg, group=ntrt2, color=ntrt2)) +
    geom_point(size=2) +
    geom_errorbar(aes(ymin=trajdiravg-setrajdir, ymax=trajdiravg+setrajdir), size=0.5)+
    facet_grid(decade~exp)+ 
    xlab("")+
    ylab(expression('Average directionality'))+
    mytheme+
    theme(legend.position="none")+
    theme(legend.title = element_blank()) + 
    theme(legend.title = element_blank()) + 
  theme(strip.text.x = element_text(size = 14, colour = "black"))+
     theme(axis.text.x = element_text(angle = 25,vjust = 0.5))+
    theme(strip.text = element_text(face="bold"))+
     theme(strip.background = element_blank())+
   theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))





pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/trajdirbydecade.pdf", width = 6, height = 6)
trajdirplotbydecade
dev.off()


```



##TRAJECTORY DISTANCE####


##
```{r - calculate trajectory distance between years full N gradient (log data)}

##https://cran.r-project.org/web/packages/ecotraj/vignettes/IntroductionETA.html##

### Start with the BC dist matrix ###


##arrange the dataframe so that that columns and rows are in right order##
exp12subsetsorted<-exp12subset%>%arrange(year)%>%arrange(plot)%>%arrange(field)%>%arrange(exp)


exp12subsetsorted$year<-as.numeric(as.character(exp12subsetsorted$year))


### subset by experiment, due to different numbers of years in E001 and E002 ####

##just the plot data##
plotE001<-exp12subsetsorted%>% dplyr::select('field':'ntrt2') %>% filter(exp==1) %>% mutate(exp_field_ntrt_plot= paste(exp, field, ntrt,plot, sep = '_'))

plotE002<-exp12subsetsorted%>% dplyr::select('field':'ntrt2') %>% filter(exp==2) %>% mutate(exp_field_ntrt_plot= paste(exp, field, ntrt,plot, sep = '_'))


##just the veg data##

vegE001<-exp12subsetsorted%>% filter(exp==1)%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)

vegE002<-exp12subsetsorted%>% filter(exp==2)%>% dplyr::select(`mass.above.ACER NEGUNDO`:`mass.above.VIOLA SP.`)


###log transformation####

vegmatrixE001<-as.matrix(vegE001)

logvegE001<-log(1+vegmatrixE001)


vegmatrixE002<-as.matrix(vegE002)

logvegE002<-log(1+vegmatrixE002)


## Bray curtis dissimiliarty matrix for each experiment##

distE001<-vegdist(logvegE001, method="bray")
BCdistallE001<-as.matrix(distE001)  ##into a matrix#
BCdistallE001df<-as.data.frame(BCdistallE001)  #into a dataframe#

BCdistallE001df2<-cbind(plotE001,BCdistallE001df) #merge plot data w/ dissim matrix##


distE002<-vegdist(logvegE002, method="bray")
BCdistallE002<-as.matrix(distE002)  ##into a matrix#
BCdistallE002df<-as.data.frame(BCdistallE002)  #into a dataframe#

BCdistallE002df2<-cbind(plotE002,BCdistallE002df) #merge plot data w/ dissim matrix##





####
trajlengthE001_fullN<-trajectoryLengths(distE001, BCdistallE001df2$exp_field_ntrt_plot, BCdistallE001df2$year)

trajlengthE002_fullN<-trajectoryLengths(distE002, BCdistallE002df2$exp_field_ntrt_plot, BCdistallE002df2$year)



####
levels(BCdistallE001df2$year)
BCdistallE001df2$year <- as.factor(as.character(BCdistallE001df2$year))

yearnamesE001<-levels(BCdistallE001df2$year)
trajlengthE001_df_fullN=as.data.frame(trajlengthE001_fullN)

colnames(trajlengthE001_df_fullN)<-yearnamesE001
names(trajlengthE001_df_fullN)[names(trajlengthE001_df_fullN) == '2004'] <- 'Total'

trajlengthE001_df_fullN$names <- rownames(trajlengthE001_df_fullN)

trajlengthE001_df2_fullN<-trajlengthE001_df_fullN %>%separate(names, c("exp", "field", "ntrt", "plot"), "_")%>%dplyr::select(exp, field, ntrt, plot, '1982':'Total')

####

levels(BCdistallE002df2$year)
BCdistallE002df2$year <- as.factor(as.character(BCdistallE002df2$year))

yearnamesE002<-levels(BCdistallE002df2$year)


trajlengthE002_df_fullN=as.data.frame(trajlengthE002_fullN)
colnames(trajlengthE002_df_fullN)<-yearnamesE002
names(trajlengthE002_df_fullN)[names(trajlengthE002_df_fullN) == '2004'] <- 'Total'

trajlengthE002_df_fullN$names <- rownames(trajlengthE002_df_fullN)

trajlengthE002_df2_fullN<-trajlengthE002_df_fullN %>%separate(names, c("exp", "field", "ntrt", "plot"), "_")%>%dplyr::select(exp, field, ntrt, plot, '1982':'Total')

###for this df, we need to drop the columns where we don't have back to back years###
##drop: 1994 (col 17(missing 1995), drop 2000 (missing 2001) (col 21), drop 2002 (missing 2003)(col 22), drop 2003 (missing most of 2004)(col 23)###

trajlengthE002_df3_fullN <- subset(trajlengthE002_df2_fullN, select = -c(17,21:23))

##convert wide to long##

traj_longE001_fullN<- gather(trajlengthE001_df2_fullN, startingyear, trajdist, '1982':'2003', factor_key=TRUE)

traj_longE002_fullN <- gather(trajlengthE002_df3_fullN, startingyear, trajdist, '1982':'1999', factor_key=TRUE)

##combine the two dataframes back together##

traj_longboth_fullN<-rbind(traj_longE001_fullN, traj_longE002_fullN)

##this data frame (traj_long_both) contain the trajectory distance in Euclidean space for each plot between years. traj dist = the dist between starting year and the next year###



##summarize the average distance between years by treatment group##

avgTraj_byyear_E001E002_fullN<-traj_longboth_fullN%>% group_by(exp,ntrt,startingyear) %>% dplyr::summarise(meantrajdist=mean(trajdist, na.rm=TRUE),sdtrajdist=sd(trajdist, na.rm=TRUE),setrajdist=sd(trajdist, na.rm=TRUE)/sqrt(n()), n=n())

avgTraj_byyear_E001E002_2_fullN<- avgTraj_byyear_E001E002_fullN %>% mutate (year2=as.numeric(as.character(startingyear))+0.5-1981)



```


```{r - AIC trajectory analysis, TABLE S5 and S6}

###AIC test whether a linear or nonlinear fit is better##
###linear fit###


trajdistlin<-lm(meantrajdist~year2, data=avgTraj_byyear_E001E002_2_fullN)


##nonlinear asymptotic##

trajdistnonlin2 <- nls(meantrajdist ~ SSasymp(year2, Asym, R0, lrc), data=avgTraj_byyear_E001E002_2_fullN) ##converging###

#trajdistnonlin2_2<- nls(meantrajdist ~ SSmicmen(year2, a, b), data=avgTraj_byyear_E001E002_2)

##simple exponential decay model####

#trajdistnonlin3 <- nls(meantrajdist ~ 1 / (1 + year2^c),start = list(c = 1), data=avgTraj_byyear_E001E002_2)


###quadratic function###

trajdistquad<-lm(meantrajdist~year2+I(year2^2), data=avgTraj_byyear_E001E002_2_fullN)


##null##

trajdistnull<-lm(meantrajdist~1, data=avgTraj_byyear_E001E002_2_fullN)


rawaic<-AIC(trajdistlin, trajdistnonlin2, trajdistquad, trajdistnull)
nR<-dim(traj_longboth_fullN)[1]  #Sample size 
aictable(rawaic,nR)

##NONLINEAR ASYMPTOTIC MODEL performs better than null and better than nonlinear model###

####non linear model equations#####

###E001 seperate by nutrient and experiment####

controlE001<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==9 & exp==1)
E001distntrt1<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==1 & exp==1)
E001distntrt2<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==2 & exp==1)
E001distntrt3<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==3 & exp==1)
E001distntrt4<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==4 & exp==1)
E001distntrt5<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==5 & exp==1)
E001distntrt6<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==6 & exp==1)
E001distntrt7<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==7 & exp==1)
E001distntrt8<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==8 & exp==1)




###E002 seperate by nutrient and experiment####

controlE002<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==9 & exp==2)
E002distntrt1<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==1 & exp==2)
E002distntrt2<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==2 & exp==2)
E002distntrt3<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==3 & exp==2)
E002distntrt4<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==4 & exp==2)
E002distntrt5<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==5 & exp==2)
E002distntrt6<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==6 & exp==2)
E002distntrt7<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==7 & exp==2)
E002distntrt8<-subset(avgTraj_byyear_E001E002_2_fullN, ntrt==8 & exp==2)

#
#E001 #Non linear model fits##

#controlE001fit<- nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data = controlE001) # not working, singular gradient#
E001ntrt1fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt1) 
E001ntrt2fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt2) 
E001ntrt3fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt3) 
E001ntrt4fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt4) 
E001ntrt5fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt5) 
#E001ntrt6fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt6) ## not working, singular gradient#
E001ntrt7fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt7) 
E001ntrt8fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E001distntrt8) 

    
#E002 #Non linear model fits##

controlE002fit<- nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data = controlE002) 
E002ntrt1fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt1) 
E002ntrt2fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt2) 
E002ntrt3fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt3) 
E002ntrt4fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt4) 
E002ntrt5fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt5) 
E002ntrt6fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt6) 
E002ntrt7fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt7) 
#E002ntrt8fit<-nls(meantrajdist~ SSasymp(year2, Asym, R0, lrc), data =E002distntrt8) ### not working singular gradient ###


### for the ones that didn't work above specify the LRC at the estimate...###

x=controlE001$year2
y=controlE001$meantrajdist

summary(E001ntrt1fit)

##first, specify lrc from the closest model##
asympfunc <- function(x, Asym, R0, lrc=0.194)
    Asym + (R0 - Asym) * exp(-exp(lrc) * x)

controlE001fit<-nls(y ~ asympfunc(x, Asym, R0),
    data = data.frame(x, y),
    start = as.list(coef(E001ntrt1fit)[c(1, 2)])) ## this one works now ###

###
x=E001distntrt6$year2
y=E001distntrt6$meantrajdist

summary(E001ntrt5fit)


##first, specify lrc from the closest model##
asympfunc <- function(x, Asym, R0, lrc=0.00531)
    Asym + (R0 - Asym) * exp(-exp(lrc) * x)

E001ntrt6fit<-nls(y ~ asympfunc(x, Asym, R0),
    data = data.frame(x, y),
    start = as.list(coef(E001ntrt5fit)[c(1, 2)])) ## this one works now ###


###
x=E002distntrt8$year2
y=E002distntrt8$meantrajdist

summary(E002ntrt7fit)

##first, specify lrc from the closest model##
asympfunc <- function(x, Asym, R0, lrc=0.24417 )
    Asym + (R0 - Asym) * exp(-exp(lrc) * x)

E002ntrt8fit<-nls(y ~ asympfunc(x, Asym, R0),
    data = data.frame(x, y),
    start = as.list(coef(E002ntrt7fit)[c(1, 2)])) ## this one works now ###




###THESE ARE ALL THE VALUES IN TABLE S5###

summary(controlE001fit)
summary(E001ntrt1fit)
summary(E001ntrt2fit)
summary(E001ntrt3fit)
summary(E001ntrt4fit)
summary(E001ntrt5fit)
summary(E001ntrt6fit)
summary(E001ntrt7fit)
summary(E001ntrt8fit)


summary(controlE002fit)
summary(E002ntrt1fit)
summary(E002ntrt2fit)
summary(E002ntrt3fit)
summary(E002ntrt4fit)
summary(E002ntrt5fit)
summary(E002ntrt6fit)
summary(E002ntrt7fit)
summary(E002ntrt8fit)


### add the predicted values from fit to dataframes for plotting###

controlE001$prednls = predict(controlE001fit)
E001distntrt1$prednls = predict(E001ntrt1fit)
E001distntrt2$prednls = predict(E001ntrt2fit)
E001distntrt3$prednls = predict(E001ntrt3fit)
E001distntrt4$prednls = predict(E001ntrt4fit)
E001distntrt5$prednls = predict(E001ntrt5fit)
E001distntrt6$prednls = predict(E001ntrt6fit)
E001distntrt7$prednls = predict(E001ntrt7fit)
E001distntrt8$prednls = predict(E001ntrt8fit)


controlE002$prednls = predict(controlE002fit)
E002distntrt1$prednls = predict(E002ntrt1fit)
E002distntrt2$prednls = predict(E002ntrt2fit)
E002distntrt3$prednls = predict(E002ntrt3fit)
E002distntrt4$prednls = predict(E002ntrt4fit)
E002distntrt5$prednls = predict(E002ntrt5fit)
E002distntrt6$prednls = predict(E002ntrt6fit)
E002distntrt7$prednls = predict(E002ntrt7fit)
E002distntrt8$prednls = predict(E002ntrt8fit)


avgTraj_byyear_E001E002_2_fullN_2<-rbind(controlE001, E001distntrt1,E001distntrt2,E001distntrt3,E001distntrt4,E001distntrt5,E001distntrt6,E001distntrt7,E001distntrt8, controlE002,E002distntrt1,E002distntrt2,E002distntrt3,E002distntrt4,E002distntrt5,E002distntrt6,E002distntrt7,E002distntrt8 )

```


```{r - recreate FIGURE 5ab Trajectory distance w nonlinear fit}

avgTraj_byyear_E001E002_2_fullN_2

avgTraj_byyear_E001E002_2_fullN_2$ntrt2=avgTraj_byyear_E001E002_2_fullN_2$ntrt




###seperate the control from the others and calculate confidence intervals for plotting...###

# confidence intervals E001#

newdataE001 <- data.frame(
  x= controlE001$year2
)

newdataE002 <- data.frame(
  year2= controlE002$year2
)


confcontrolE001<-as.data.frame(predFit(controlE001fit, newdata = newdataE001, interval = "confidence", level=0.95))

confE001df<-cbind(controlE001, confcontrolE001)


confcontrolE002<-as.data.frame(predFit(controlE002fit, newdata = newdataE002, interval = "confidence", level=0.95))

confE002df<-cbind(controlE002, confcontrolE002)


confdistboth<-rbind(confE001df, confE002df)



# plot specifications

avgTraj_byyear_E001E002_2_fullN_2$exp<-mapvalues(avgTraj_byyear_E001E002_2_fullN_2$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

avgTraj_byyear_E001E002_2_fullN_2$exp<- factor(avgTraj_byyear_E001E002_2_fullN_2$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))



avgTraj_byyear_E001E002_2_fullN_2$ntrt2  <- mapvalues(avgTraj_byyear_E001E002_2_fullN_2$ntrt2, from=c("0", "9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("Never", "None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

avgTraj_byyear_E001E002_2_fullN_2$ntrt2 <- factor(avgTraj_byyear_E001E002_2_fullN_2$ntrt2, levels = c("Never", "None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))





avgTraj_byyear_E001E002_2_fullN_2<-avgTraj_byyear_E001E002_2_fullN_2%>% mutate(abclabel=if_else(exp=="Intact in 1982 (E001)", "(a)", "(b)"))


confdistboth$ntrt2<-confdistboth$ntrt


confdistboth$ntrt2 <- mapvalues(confdistboth$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

confdistboth$ntrt2 <- factor(confdistboth$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))



confdistboth$exp<-mapvalues(confdistboth$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

confdistboth$exp<- factor(confdistboth$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))





####



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))





avgTraj_byyearnonlinear_fullN<- ggplot(data=avgTraj_byyear_E001E002_2_fullN_2) +
    geom_point(data=avgTraj_byyear_E001E002_2_fullN_2, aes(x=as.numeric(as.character(year2)), y=meantrajdist, group=ntrt2, color=ntrt2)) +geom_line(data=avgTraj_byyear_E001E002_2_fullN_2, aes(x=as.numeric(as.character(year2)), y=prednls, group=ntrt2, color=ntrt2))+
    facet_grid(~exp)+ 
  geom_ribbon(data=confdistboth, aes(x=year2, ymin=lwr, ymax=upr,group=ntrt2, color=ntrt2), color=NA, fill = "gray1", alpha=0.2)+
    ylab(expression('Annual community trajectory distance'))+
    xlab("Time since experiment (years)")+
    mytheme+
    theme(legend.title = element_blank()) + 
    scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+
    theme(strip.text = element_text(size=12, face="bold"))+
     theme(strip.background = element_blank())+
    geom_text(aes(x = 2.5, y = 0.65, label = abclabel, group =     abclabel),size = 4, color= "black", check_overlap = T)




pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/trajlength.pdf", width = 6, height = 4)
avgTraj_byyearnonlinear_fullN
dev.off()


```



## ADDITIONAL SUPPLEMENTAL FIGURES AND ANALYES ###


```{r - Indicator species analyses - 2 time periods with field D log data }


##starting with exp12subset, raw biomass data####


head(da_fieldD_3 ) #long form field D##
da_fieldD_3$exp<-0

head(d3woody)  ##long form fields ABC##

#######

d3E001E002<-d3woody %>% select(field, exp,ntrt, plot, year, species, biomass=mass.above)


da_fieldD_3$exp=0
da_fieldD_3$ntrt=0


da_fieldD_3<-da_fieldD_3 %>% select(field, exp,ntrt, plot, year, species, biomass=mass.above)


###
dim(d3E001E002)
dim(da_fieldD_3)

####

fieldABCDE001E002<-rbind(d3E001E002, da_fieldD_3)

###

###subset to the controls and high N treatments###

fieldABCDE001E002_subset<-subset(fieldABCDE001E002,ntrt==9|ntrt==0|ntrt==8) ###control treatment  (9) highest N 27.2 (8)



# Look at first 3 years of experiment and last 3 years of experiment
vegearlylong <- subset(fieldABCDE001E002_subset, year=="1982"|year=="1983"|year=="1984")
veglatelong <- subset(fieldABCDE001E002_subset, year=="2000"|year=="2002"|year=="2004")


##skip years 2001, 2003 bc of imcomplete data##

vegearlylong_2<-vegearly %>% mutate(stage="early") %>% mutate(stage2=1)

veglatelong_2<-veglatelong %>% mutate(stage="late")%>% mutate(stage2=3)

#####merge the early and late##

veglong2<-rbind(vegearlylong_2, veglatelong_2)


####this file for indicator species #####

dim(veglong2) ##dim 6316    9


#rownames(veglong2)<-NULL ##get rid of rownames##


##indicator species analysis##

    ##convert data back to wide form##

vegwide2 <- spread(veglong2, species, biomass) ##dim 648 X 161####


# Fill in NA's with zeros in wide data set
vegwide2 [is.na(vegwide2)] <- 0

vegwideplotdata2<-vegwide2[,1:7]
vegwidematrix2<-vegwide2[,8:161]


###make a column for dist_nitrogen_earylate##

vegwideplotdata22<-vegwideplotdata2 %>% mutate(stagentrtdist= paste(stage, ntrt, exp, sep = '_'))

vegwideplotdata22$stagentrtdist<-as.factor(vegwideplotdata22$stagentrtdist)

###
levels(vegwideplotdata22$stagentrtdist)

vegwideplotdata22$stagentrtdist <- factor(vegwideplotdata22$stagentrtdist, levels = c("early_0_0", "early_9_1", "early_8_1", "early_9_2", "early_8_2", "late_0_0", "late_9_1", "late_8_1", "late_9_2", "late_8_2"))

vegwideplotdata33<-vegwideplotdata22 %>% mutate(stagentrtdist2= as.numeric(stagentrtdist))

vegwideplotdata33$stagentrtdist2<-as.factor(vegwideplotdata33$stagentrtdist2)

vegwideplotdata33$stagentrtdist2 <- factor(vegwideplotdata33$stagentrtdist2, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))

##early  late ##

##indicator spp analyses###

indvalearlylatefieldABCD = multipatt(vegwidematrix2,vegwideplotdata33$stagentrtdist2,max.order = 3, control = how(nperm=99))## just looks at the individual groups, and twos  ##

indvalearlylatefieldABCD2 = multipatt(vegwidematrix2,vegwideplotdata33$stagentrtdist2,max.order = 4, control = how(nperm=999))## just looks at the individual groups, and twos and threes  ##


indval<-data.frame(indvalearlylatefieldABCD2[["sign"]]) ##RESULTS###

write.csv(indval, "C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/indicspp12_22_22.csv", row.names=FALSE)


```


```{r - SUPPLEMENTAL SPP RICHNESS time series and by field raw data}


##starting with exp12subset, raw biomass data####


dim(exp12subset) ##6102 by 198, 1-10 plot data, the rest veg data###

###summarize##

###Diversity metrics for plant data###
ShannonD_a <- diversity(exp12subset[,11:198], index = "shannon") ##shannon-weiner index##
Richness_a <- specnumber(exp12subset[,11:198])
Evenness_a <- ShannonD_a/log(Richness_a)

###combine##
plotdatarichness<-cbind(exp12subset[,1:10], Richness_a)

plotdatarichnes2<- plotdatarichness%>%   mutate(ntrt2=ntrt,expntrtyear= paste(exp, ntrt,year, sep = '_'))

##make year numeric##

plotdatarichnes2$year<-as.numeric(as.character(plotdatarichnes2$year))

##average across treatments##

richnessaverage<-plotdatarichnes2%>% group_by(exp, ntrt, ntrt2, year, expntrtyear) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())


##average across fields####

richnessaverageABC<-plotdatarichnes2%>% group_by(exp,field, year, ntrt, ntrt2, year, expntrtyear) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())

richnessABC19822004<-subset(richnessaverageABC,year==1982|year==2004)
richnessABC19822004<-subset(richnessaverageABC,year==1982|year==2004)


##richness at beginning###

richnessbeginning<-subset(plotdatarichnes2, year < 1985)

richnessbegsummary<-richnessbeginning%>% group_by(exp) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())

richnessbegsummaryboth<-richnessbeginning %>% group_by(ntrt)%>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())



richnessfirstyear<-subset(plotdatarichnes2, year == 1982)

richnessbegsummary<-richnessbeginning%>% group_by(exp) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())




##richness at end of experiment###
richnessend<-subset(plotdatarichnes2, year > 2000)

richnessendsummary<-richnessend%>% group_by(ntrt2) %>% dplyr::summarise(meanrichness=mean(Richness_a, na.rm=TRUE),sdrichness=sd(Richness_a, na.rm=TRUE),serichness=sd(Richness_a, na.rm=TRUE)/sqrt(n()), n=n())



##plotting specifications###

richnessaverage$exp<-mapvalues(richnessaverage$exp, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

richnessaverage$exp<- factor(richnessaverage$exp, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


richnessaverage$ntrt2 <- mapvalues(richnessaverage$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

richnessaverage$ntrt2 <- factor(richnessaverage$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))


richnessaverage$year2= richnessaverage$year - 1981



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))




spprichnesstime<-richnessaverage %>% ggplot(aes(x=year2, y=meanrichness, group=ntrt2, color=ntrt2, fill=ntrt2))+
    geom_point()+
    geom_smooth(method="loess", se=FALSE)+
    facet_grid(~exp) + 
    mytheme+
    ylab("Plot species richness")+
    xlab("Time since experiment")+
    mytheme+
    theme(legend.title = element_blank()) + 
    theme(strip.text.x = element_text(size = 14, colour = "black"))+
  scale_colour_manual(values = c("dark gray","#f9cb35", "#f98e09", "#e45a31", "#bc3754", "#8a226a", "#57106e", "#210c4a", "#000004"))+
   theme(strip.background = element_blank())


pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/spprichnesstime.pdf", width = 6.5, height = 3)
spprichnesstime
dev.off()


```


```{r - SUPPLEMENTAL SPP RICHNESS field ABCD raw data}

fieldABCDE001E002<-rbind(d3E001E002, da_fieldD_3)

##convert long to wide ###


ABCDwide <- spread(fieldABCDE001E002, species, biomass) ##dim 648 X 161####


# Fill in NA's with zeros in wide data set
ABCDwide [is.na(ABCDwide)] <- 0

##starting with BCDwide, raw biomass data####


dim(ABCDwide) ##7566 by 256, 1-5 plot data, the rest veg data###

###summarize##

###Diversity metrics for plant data###
ABCDShannonD_a <- diversity(ABCDwide[,6:256], index = "shannon") ##shannon-weiner index##
ABCDRichness_a <- specnumber(ABCDwide[,6:256])
ABCDEvenness_a <- ABCDShannonD_a/log(ABCDRichness_a)

###combine##
plotdatarichnessABCD<-cbind(ABCDwide[,1:5], ABCDRichness_a)

#### SUBSET TO JUST 1982 and 2004, AND CONTROLS ONLY ####

richnessABCD19822004<-subset(plotdatarichnessABCD, year==1982|year==2004)

richnessABCD19822004controls<-subset(richnessABCD19822004, ntrt==9 | ntrt==0)


##average across fields####

richnessaverageABCD19822004<-richnessABCD19822004controls%>% group_by(exp,field, year) %>% dplyr::summarise(meanrichness=mean(ABCDRichness_a, na.rm=TRUE),sdrichness=sd(ABCDRichness_a, na.rm=TRUE),serichness=sd(ABCDRichness_a, na.rm=TRUE)/sqrt(n()), n=n())

# sumarize## 

ggplot(richnessaverageABCD19822004, aes(x=field, y=meanrichness))+
  geom_bar(stat='identity')+
  facet_grid(year~exp, scale="free", space="free") 


```




```{r - SUPPLEMENTAL Biomass over time raw data}

##starting with exp12subset, raw biomass data####


dim(exp12subset) ##6102 by 198, 1-10 plot data, the rest veg data###


##wide to long form##
exp12subset_long <- gather(exp12subset, species, biomass, 'mass.above.ACER NEGUNDO':'mass.above.VIOLA SP.', factor_key=TRUE)

##remove extra text##

exp12subset_long $species<-str_remove(exp12subset_long$species, "mass.above.")


##make a column for exp_ntrt_year##

exp12subset_long_2<-exp12subset_long  %>% mutate( expntrtyear_2= paste(exp,ntrt, year, sep = '_'))

exp12subset_long_3<-exp12subset_long_2 %>% mutate(expntrt= paste(exp,ntrt, sep = '_')) %>% dplyr::select(field, plot, disk,year, ntrt,  expntrtyear_2, expntrt, species, biomass)

##sum all species abundance across plots with the same treatment group and year ###includes zeroes!!!#####

#sum_allsp_exp12ABC<-exp12subset_long_3%>% group_by(species, disk,year, ntrt, expntrtyear_2, expntrt,) %>% dplyr::summarise(sumbiomass=sum(biomass, na.rm=TRUE),n=n())


###get rid of years where we don't have all 18 plots###

#sum_allsp_exp12ABC_2<-subset(sum_allsp_exp12ABC, n==18)

#sum_allsp_df<-as.data.frame(sum_allsp_exp12ABC_2)

### due to differing number of plots through time, use average instead###


mean_allsp_exp12ABC<-exp12subset_long_3%>% group_by(species, disk,year, ntrt, expntrtyear_2, expntrt,) %>% dplyr::summarise(meanbiomass=mean(biomass, na.rm=TRUE),n=n())



##this dataframe (sumallsp_df has the abundance of each plant in each treatment group (n = 18) for each year####

##calculating the total biomass##

totalbiomassplot<-exp12subset_long_3%>% group_by(plot,field, disk,year, ntrt, expntrtyear_2, expntrt,) %>% dplyr::summarise(totalbiomass=sum(biomass, na.rm=TRUE),sebiomass=sd(biomass, na.rm=TRUE)/sqrt(n()),n=n())

##average across plots##

totalbiomassgroups<-totalbiomassplot%>% group_by(disk,year, ntrt,  expntrtyear_2, expntrt,) %>% dplyr::summarise(totalplotbiomass=mean(totalbiomass, na.rm=TRUE),seplotbiomass=sd(totalbiomass, na.rm=TRUE)/sqrt(n()), n=n())


totalbiomassdf<-as.data.frame(totalbiomassgroups)

totalbiomassdf2<-totalbiomassdf%>%mutate(upper=totalplotbiomass+(2*seplotbiomass), lower=totalplotbiomass-(2*seplotbiomass))%>% dplyr::select(expntrtyear_2,year, disk, ntrt, totalplotbiomass, seplotbiomass,upper, lower)

####summary across treatments all years###

biomasssummary<-totalbiomassdf%>% group_by(disk) %>% dplyr::summarise(meanbiomass=mean(totalplotbiomass, na.rm=TRUE),sebiomass=sd(totalplotbiomass, na.rm=TRUE)/sqrt(n()),n=n())


##plot specifications ##


totalbiomassdf2$disk<-mapvalues(totalbiomassdf2$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

totalbiomassdf2$disk<- factor(totalbiomassdf2$disk, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


totalbiomassdf22<-totalbiomassdf2 %>% mutate(ntrt2=ntrt)


totalbiomassdf22$ntrt2 <- mapvalues(totalbiomassdf22$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

totalbiomassdf22$ntrt2 <- factor(totalbiomassdf22$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

##



totalbiomassdf3<- totalbiomassdf22 %>% mutate(year2=as.numeric(as.character(year))-1981)


totalbiomassdf3subset<-subset(totalbiomassdf3, ntrt==9|ntrt==2|ntrt==5|ntrt==8)

###plotting###

mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))+ theme(panel.grid.major = element_line(colour = "gray 85"))+ theme(panel.grid.minor = element_line(colour = "gray 95"))

totalmeanbiomassplot<-totalbiomassdf3subset %>% ggplot(aes(x=year2, y=totalplotbiomass, color=ntrt2))+
    geom_line(size=1) + 
    #geom_ribbon(aes(ymin=lower, ymax=upper, fill=ntrt2), alpha=0.5, colour = NA) + 
    facet_grid(~disk) + 
    mytheme+
    ylab(expression(paste("Average aboveground biomass g / m  "^2)))+
    xlab("Time since experiment")+
    theme(legend.position = "right")+
    theme(strip.background = element_blank())+theme(strip.text.x = element_text(size = 14, colour = "black")) + scale_colour_manual(values = c("dark gray","#f98e09", "#8a226a","#000004"))+ scale_fill_manual(values = c("dark gray","#f98e09", "#8a226a","#000004"))


pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/totalbiomassplot.pdf", width = 6.5, height = 3)
totalmeanbiomassplot
dev.off()

```


```{r - SUPPLEMENTAL Functional groups over time raw data}

##start with the mean_allsp_exp12ABC and totalbiomassgroups dataframes ####

## and the original Da (all plot and spp info from CC)

totalbiomassplot2<-as.data.frame(totalbiomassgroups) %>% select(expntrtyear_2, totalplotbiomass, seplotbiomass)


##merge the spp with total plot biomass##

sum_allsp_df_2 <- (merge(mean_allsp_exp12ABC,totalbiomassplot2, by = 'expntrtyear_2', sort=FALSE, all.x=TRUE))

sum_allsp_df_3<-sum_allsp_df_2 %>% mutate(propbiomass=meanbiomass/totalplotbiomass)

### this data set (sum_allsp_df_3 has the sum of all spp in each year in each plot and the proportion of biomass of that sp##

###merge the species info with functional group and other information##

specieslookup<-sp.df %>% distinct(species, .keep_all = TRUE)

specieslookup2<-specieslookup %>% dplyr::select(species,functional.group,duration,lifeform, pathway, origin)


mergedfuncgroup <- (merge(specieslookup2,sum_allsp_df_3, by = 'species', sort=FALSE, all.y=TRUE))

mergedfuncgroup_2<-mergedfuncgroup%>% mutate(functional.group2= paste(functional.group, origin, sep = '_'))

####now sum up by functional group + origin ##

sumfunctionalgroup<-mergedfuncgroup_2%>% group_by(disk,year, ntrt,expntrtyear_2, expntrt,functional.group, totalplotbiomass) %>% dplyr::summarise(sumfuncbiomass=sum(meanbiomass, na.rm=TRUE))%>% mutate(propbiomass=sumfuncbiomass/totalplotbiomass)

sumfunctionalgroupdf<-as.data.frame(sumfunctionalgroup)


###check that the proportions add to 1###

checksum<-sumfunctionalgroup%>% group_by(expntrtyear_2) %>% dplyr::summarise(sumpropbiomass=sum(propbiomass, na.rm=TRUE))




###reordering so that other is last, first grasses, then forbs##

sumfunctionalgroupdf$functional.group<-factor(sumfunctionalgroupdf$functional.group, levels=c("C3", "C4" , "S", "W", "L", "F"))

#sumfuntionalgroupdf2<-sumfuntionalgroupdf[complete.cases(sumfuntionalgroupdf), ]

#drop the levels not sampeled
sumfunctionalgroupdf$functional.group <- as.factor(as.character(sumfunctionalgroupdf$functional.group))


##plot specifications####

sumfunctionalgroupdf$disk<-mapvalues(sumfunctionalgroupdf$disk, from=c("0", "1"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

sumfunctionalgroupdf$disk<- factor(sumfunctionalgroupdf$disk, levels = c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


sumfunctionalgroupdf$ntrt2<-sumfunctionalgroupdf$ntrt



sumfunctionalgroupdf$ntrt2 <- mapvalues(sumfunctionalgroupdf$ntrt2, from=c("9", "1", "2", "3", "4","5","6", "7", "8"),
                               to=c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))

sumfunctionalgroupdf$ntrt2 <- factor(sumfunctionalgroupdf$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "2 N + μ", "3.4 N + μ","5.4 N + μ","9.5 N + μ", "17 N + μ", "27.2 N + μ"))



sumfunctionalgroupdf$year<-as.numeric(as.character(sumfunctionalgroupdf$year))


sumfunctionalgroupdf2<- sumfunctionalgroupdf %>% mutate(year2=year-1981)



mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))


### subset for plotting###
sumfuntionalgroupdf3subset<-subset(sumfunctionalgroupdf2, ntrt==9|ntrt==2|ntrt==5|ntrt==8)


    
propfunctionalgrouptime<-sumfuntionalgroupdf3subset %>% ggplot(aes(x=year2, y=propbiomass, group=functional.group))+
    geom_area(position = 'stack', aes(fill=functional.group)) + 
    facet_grid(ntrt2~disk) + 
    mytheme+
    ylab("Proportion of Biomass")+
    xlab("Time since experiment")+
    theme(legend.title = element_blank())+
    theme(legend.key.size = unit(0.5, "cm"))+scale_fill_viridis_d(option = "D",direction=-1, na.value="grey72")+
    theme(strip.background = element_blank())+theme(strip.text.x = element_text(size = 14, colour = "black"))+
    scale_y_continuous(breaks=c(0.25,0.50,0.75, 1.00))


pdf("C:/Users/Melissa/Dropbox/DRAGnet/CedarCreekdata/Dist recovery MS/Figures_overleaf/propfunctionalgrouptime.pdf", width = 6, height = 6)
propfunctionalgrouptime
dev.off()

```




##additional plots not included in paper###


```{r - pCOA species last few years}


##start with log transformed data###

exp12subset_2004<-subset(exp12subset_2, year==2004)


##just the veg data##

veg2004<-exp12subset_2004%>% dplyr::select(`mass.above.ACHILLEA MILLEFOLIUM(LANULOSA)`:`mass.above.VIOLA SP.`)

#remove columns with all 0s##

veg2004_2 = veg2004[,colSums(veg2004) > 0]

##just the plot data##
plot2004<-exp12subset_2004%>% dplyr::select('field':'ntrt2')%>% mutate(expntrt= paste(exp,ntrt,sep = '_')) 

## Bray curtis dissimiliarty matrix##
dist2004<-vegdist(veg2004_2, method="bray")

##PCOA####
PCOA2004<-pcoa(dist2004)

##plot the ord##

#pcoa1<-plot(PCOA2004)


## extracting the axis scores##

PCOA2004 <- PCOA2004$vectors[,c(1,2)]


##merge the axis scores with the plot data ###

PCOAandplots2004<-cbind(plot2004,PCOA2004)


###pulling out the group centroids ####


bd_2004<-betadisper(vegdist(veg2004_2),plot2004$expntrt, type = "centroid")    ####Note that you have to specify the centroid ##  ##takes a bit##


centroiddf2004<-as.data.frame(bd_2004[["centroids"]])

centroiddf2004_2<-centroiddf2004[,1:2]

centroiddf2004_2<- tibble::rownames_to_column(centroiddf2004_2, "expntrt")

centroiddf2004_2<-separate(data = centroiddf2004_2, col = expntrt, into = c("exp", "ntrt"))




##plotting specifications#####


PCOAandplots2004<-PCOAandplots2004%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

PCOAandplots2004$ntrt2  <- mapvalues(PCOAandplots2004$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))
PCOAandplots2004$ntrt2 <- factor(PCOAandplots2004$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))


PCOAandplots2004$exp2<-mapvalues(PCOAandplots2004$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

PCOAandplots2004$exp2 <- factor(PCOAandplots2004$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

####
centroiddf2004_2<-centroiddf2004_2%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

centroiddf2004_2$ntrt2  <- mapvalues(centroiddf2004_2$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))
centroiddf2004_2$ntrt2 <- factor(centroiddf2004_2$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))


centroiddf2004_2$exp2<-mapvalues(centroiddf2004_2$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

centroiddf2004_2$exp2 <- factor(centroiddf2004_2$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))




####

PCOA2004plot <- ggplot() + 
    xlab("PCOA 1") +
    ylab("PCOA 2") +  
    geom_point(data=PCOAandplots2004, 
               aes(x=Axis.1, y=Axis.2, colour=ntrt2, shape=exp2), 
               size=1)+
        geom_point(data=centroiddf2004_2, 
               aes(x=PCoA1, y=PCoA2, colour=ntrt2, shape=exp2), 
               size=4)+
  scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+
  scale_fill_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+ 
   mytheme+
    theme(strip.text.x = element_text(size = 14, colour = "black"))+
    theme(strip.text.y = element_text(size = 14, colour = "black"))+
    theme(legend.position = c(0.89, 0.35),
          legend.spacing.x = unit(0.03, 'cm'))+
    theme(legend.text = element_text(size=6))+
    theme(legend.key.size = unit(0.4, 'cm'))


```


```{r - NMDS species last few years}


##start with log transformed data###

exp12subset_2004<-subset(exp12subset_2, year==2004)



##just the veg data##

veg2004<-exp12subset_2004%>% dplyr::select(`mass.above.ACHILLEA MILLEFOLIUM(LANULOSA)`:`mass.above.VIOLA SP.`)

#remove columns with all 0s##

veg2004_2 = veg2004[,colSums(veg2004) > 0]

##just the plot data##
plot2004<-exp12subset_2004%>% dplyr::select('field':'ntrt2')%>% mutate(expntrt= paste(exp,ntrt,sep = '_')) 

## Bray curtis dissimiliarty matrix##
dist2004<-vegdist(veg2004_2, method="bray")



###NMDS###

NMDS1<-metaMDS(dist2004, k = 3, trymax = 10000)

##extract the spp scores##

en = envfit(NMDS1, veg2004_2, permutations = 999, na.rm = TRUE)

endf <- data.frame((en$vectors)$arrows, (en$vectors)$r, (en$vectors)$pvals)

endf <- tibble::rownames_to_column(endf , "species")

colnames(endf ) <- c("species", "NMDS1", "NMDS2", "r2", "pval")

endf$species<-str_remove(endf$species, "mass.above.")


##select out certain spp only####

endfmain<-endf %>% filter(r2 > 0.3)

species2<-c("Agro.rep", "Ambro.cor", "Carex", "Euph.cor", "Lath.ven", "Poa.pra", "Schiz.scop", "Sorg.nut")

enddfmain2<-as.data.frame(cbind(endfmain, species2))

## extracting the axis scores##

NMDSscores<-NMDS1$points

##merge the axis scores with the plot data ###

NMDSandplots2004<-cbind(plot2004,NMDSscores)


###AVERAGE BY EXP_NTRT####

NMDSavg<-NMDSandplots2004 %>% group_by(exp, ntrt) %>% dplyr::summarise(meanAxis1=mean(MDS1, na.rm=TRUE),sdAxis1=sd(MDS1, na.rm=TRUE),seAxis1=sd(MDS1, na.rm=TRUE)/sqrt(n()),meanAxis2=mean(MDS2, na.rm=TRUE),sdAxis2=sd(MDS2, na.rm=TRUE),seAxis2=sd(MDS2, na.rm=TRUE)/sqrt(n()), n=n())



##plotting specifications#####


NMDSandplots2004_2<-NMDSandplots2004%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

NMDSandplots2004_2$ntrt2  <- mapvalues(NMDSandplots2004_2$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))
NMDSandplots2004_2$ntrt2 <- factor(NMDSandplots2004_2$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))


NMDSandplots2004_2$exp2<-mapvalues(NMDSandplots2004_2$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

NMDSandplots2004_2$exp2 <- factor(NMDSandplots2004_2$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

##plotting specifications#####


NMDSavg_2<-NMDSavg%>% mutate(ntrt2=ntrt)%>% mutate(exp2=exp)

NMDSavg_2$ntrt2  <- mapvalues(NMDSavg_2$ntrt2, from=c("9", "1", "2", "4","6"),
                               to=c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))
NMDSavg_2$ntrt2 <- factor(NMDSavg_2$ntrt2, levels = c("None", "0 N+μ", "1 N + μ", "3.4 N + μ","9 N + μ"))


NMDSavg_2$exp2<-mapvalues(NMDSavg_2$exp2, from=c("1", "2"), to=c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

NMDSavg_2$exp2 <- factor(NMDSavg_2$exp2, levels =c("Intact in 1982 (E001)", "Disturbed in 1982 (E002)"))

####

####


mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=10, colour = "black"))+theme(axis.text.y=element_text(size=10, colour = "black"))+theme(axis.title=element_text(size=12))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.title = element_blank())+theme(plot.title = element_text(margin=margin(0,0,5,0)))




####

NMDS2004plot <- ggplot() + 
    xlab("NMDS 1") +
    ylab("NMDS 2") + 
    geom_point(data=NMDSandplots2004_2, 
               aes(x=MDS1, y=MDS2, colour=ntrt2, shape=exp2), 
               size=1)+
  geom_point(data=NMDSavg_2, 
               aes(x=meanAxis1, y=meanAxis2, colour=ntrt2, shape=exp2), 
               size=4)+
  geom_segment(data = enddfmain2,
               aes(x = 0, xend = NMDS1/2, y = 0, yend = NMDS2/2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  geom_text(data = enddfmain2, aes(x = NMDS1/2, y = NMDS2/2, label = species2),
            size = 2.5, position=position_jitter(height=0.03, width=0.03))+
  scale_colour_manual(values = c("gray45", "#E69F00", "#009E73","#0072B2","#CC79A7"))+  
  mytheme+
    theme(strip.text.x = element_text(size = 14, colour = "black"))+
    theme(strip.text.y = element_text(size = 14, colour = "black"))+
    theme(legend.position = c(0.85, 0.25),
          legend.spacing.x = unit(0.03, 'cm'))+
    theme(legend.text = element_text(size=6))+
    theme(legend.key.size = unit(0.4, 'cm'))


```

